var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};angular.module("app",["ui.router","pascalprecht.translate","commons","angular.filter","720kb.datepicker","ngMessages","cg.fileupload","ngDialog","mp.deepBlur","rzModule","ngAria","tmh.dynamicLocale","ngCookies","ngRaven","ngAnimate","toastr"]).config(["$translateProvider","$compileProvider","tmhDynamicLocaleProvider","toastrConfig",function(e,t,n,o){var i=localStorage.getItem("lang");i&&0<=i.indexOf('"')&&(i=i.replace(/\"/g,""),localStorage.setItem("lang",i)),t.preAssignBindingsEnabled(!0);var r=navigator.userAgent,a=new RegExp(["(MSIE|Trident|(?!Gecko.+)Firefox","|(?!AppleWebKit.+Chrome.+)Safari(?!.+Edge)","|(?!AppleWebKit.+)Chrome(?!.+Edge)|(?!AppleWebKit.+Chrome.+Safari.+)Edge","|AppleWebKit(?!.+Chrome|.+Safari)|Gecko(?!.+Firefox))(?: |\\/)([\\d\\.apre]+)"].join(""),"g").exec(r)[1];document.body.className+=a.toLowerCase();function s(e){9===e.keyCode&&(document.body.classList.add("user-is-tabbing"),window.removeEventListener("keydown",s),window.addEventListener("mousedown",u))}var u=function e(){document.body.classList.remove("user-is-tabbing"),window.removeEventListener("mousedown",e),window.addEventListener("keydown",s)};window.addEventListener("keydown",s),e.useLocalStorage(),e.storageKey("lang"),e.useSanitizeValueStrategy("escaped"),_extends(window.langs,window.config.languages);var l=Object.keys(window.langs),c=!0,d=!1,g=void 0;try{for(var p,h=l[Symbol.iterator]();!(c=(p=h.next()).done);c=!0){var f=p.value;e.translations(f,window.langs[f].translations)}}catch(e){d=!0,g=e}finally{try{!c&&h.return&&h.return()}finally{if(d)throw g}}if(!i){function m(){return void 0!==navigator.languages?navigator.languages[0].split("-")[0]:navigator.language.split("-")[0]}var v=l.find(function(e){return window.langs[e].default})||null;i=(l.includes(m())?m():null)||v||"en"}e.preferredLanguage(i),e.use(i),n.defaultLocale(i),n.localeLocationPattern("/components/angular-i18n/angular-locale_{{locale}}.js"),angular.extend(o,{positionClass:"toast-bottom-right"})}]).run(["$rootScope","Config","ModuleService","Library","SettingService","SyncService","SessionService","MediaService","FirebaseService","UserService","UsersContentsInfos","UsersPreferences",function(e,t,n,o,i,r,a,s,u,l,c,d){e.Config=t,e.ModuleService=n,e.Library=o,e.SettingService=i,e.SyncService=r,e.SessionService=a,e.MediaService=s,e.FirebaseService=u,e.ReadAloud={toolbar:null,main:null},e.UserService=l,e.UsersContentsInfos=c,e.UsersPreferences=d,e.isLoading=!1,e.$on("$stateChangeError",function(e,t,n,o,i,r){console.log(r)}),e.$on("$stateChangeStart",function(){e.isLoading=!0}),e.$on("$stateChangeSuccess",function(){e.isLoading=!1})}]),angular.module("app").config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/login"),e.state("app",{abstract:!0,templateUrl:"app/app.html",controllerAs:"$ctrl",resolve:{_config:["Config",function(e){return e.load()}],_firebase:["FirebaseService","Config",function(o,i){function e(e,t){var n=document.createElement("script");t&&(n.onload=t),document.head.appendChild(n),n.src=e}if(i.hasFeature("notifications")){e("https://www.gstatic.com/firebasejs/5.5.4/firebase-app.js",function(){e("https://www.gstatic.com/firebasejs/5.5.4/firebase-messaging.js",function(){var e=i.get("notificationPublicKey"),t=i.get("notificationScript");if(t&&e){var n=t.match("{(.*)}")[0].trim();n=(n=(n=(n=n.replace(/ /g,"")).replace(/https:/g,"https")).replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g,'"$2": ')).replace(/https/g,"https:"),n=JSON.parse(n),o.initialize(n,e)}})})}return!0}],_books:["Library",function(e){return e.load()}],_theme:["Theme","Config",function(e,t){var n=t.get("theme").current;n&&""!=n||(n="default");var o=t.get("theme").themes[n];return e.setTheme(o)}],_user:["API","SessionService","UserService","User",function(e,n,o,i){return e.getUser().then(function(e){var t=new i(e);return n.user=t,o.checkTermsAndConditions(t),e})}],_sync:["SyncService","_books","_user",function(e){return e.load()}],_userContentsInfos:["UsersContentsInfos","_books","_user",function(e){return e.load()}],_userPreferences:["UsersPreferences","$translate","_books","_user",function(t,n){return t.load().then(function(){var e=t.get(t.KEY_USER_LANGUAGE);e&&n.use(e.value)})}]},controller:["$state","Config","SessionService","_config","API","$location",function(e,t,n,o,i,r){this.appName=t.get("appName"),this.accessCodePanelIsVisible=!1,this.iosConfig=t.get("ios"),this.androidConfig=t.get("android");var a=t.isMobile(this.androidConfig.id,this.iosConfig.storeId);if(this.logout=function(){i.hapi.get("/ap/users/logout").then(function(){n.logOut(),e.go("auth.login")})},this.showAccessCodePanel=function(){this.accessCodePanelIsVisible=!0},this.hideAccessCodePanel=function(){this.accessCodePanelIsVisible=!1},t.hasFeature("universalLink")&&a.mobile){var s=a.customLink,u=window.location;r.replace(s),window.setTimeout(function(){window.location=u,t.mobileCheckModal(a)},10)}}]})}]),angular.module("app").config(["$stateProvider",function(e){e.state("auth",{abstract:!0,templateUrl:"auth/auth.html",controllerAs:"AuthCtrl",resolve:{_config:["Config",function(e){return e.load()}],checkSession:["$state","SessionService","Config",function(e,t,n){return t.isLogged().then(function(){n.isSingleMode()||e.go(t.goToShelf())}).catch(function(){})}],_theme:["Theme","Config",function(e,t){var n=t.get("theme").current;n&&""!=n||(n="default");var o=t.get("theme").themes[n];return e.setTheme(o)}]},controller:["$scope","$state","$log","SessionService","Config","$location",function(e,t,n,o,i,r){n.debug("AuthCtrl"),this.appName=i.get("appName"),this.iosConfig=i.get("ios"),this.androidConfig=i.get("android");var a=i.isMobile(this.androidConfig.id,this.iosConfig.storeId);if(this.logout=function(){o.logOut(),t.go("auth.login")},i.hasFeature("universalLink")&&a.mobile){var s=a.customLink,u=window.location;r.replace(s),window.setTimeout(function(){window.location=u,i.mobileCheckModal(a)},10)}return this}]}).state("auth.login",{url:"/login?expired",templateUrl:"auth/login.html",controllerAs:"$ctrl",controller:["API","$state","SessionService","_config","$translate","LocalStorage","Config","$window","ngDialog","UserService","$location","StatisticsService","UsersPreferences",function(u,e,t,n,i,o,r,a,l,s,c,d,g){var p=this;this.appName=r.get("appName"),r.isSingleMode()&&e.go("auth.single-mode");var h=c.search();return h.activationCode&&setTimeout(function(){p.showValidationResult(h)},1e3),e.params.expired&&(this.message=i.instant("GT_SESSION_EXPIRED")),n.clever?this.clever_activated=n.clever.active:this.clever_activated=!1,this.queryMefUser=function(){if(h.from_mef)return!0},this.login=function(){var n=this;u.login({email:this.email,password:this.password}).then(function(){return n.badLogin=!1,e.go(t.goToShelf()),s.checkTermsAndConditions(t.getUser()),d.loginEvent()}).then(function(){var e=o.get("lang"),t=g.get(g.KEY_USER_LANGUAGE);t&&e&&(e!==t.value&&g.set(g.KEY_USER_LANGUAGE,e),i.use(t.value))}).then(function(){return u.getCloudFrontCookies({api:"ap",token:t.getToken()})}).catch(function(e){if(e){var t=e.data||null;if(t&&t.statusCode&&"406"==t.statusCode)n.openResend();else if(t&&t.statusCode&&"409"==t.statusCode){var s=n;l.openConfirm({width:"40%",template:"auth/dialogs/existing-user-login.html",showClose:!1,closeByEscape:!1,focusOnOpen:!0,controllerAs:"$ctrl",controller:["$scope","Config","ngDialog",function(e,t,n){this.termsAndConditionsChecked=!1,this.termsAndConditionsURL=t.getExternalLink("terms"),this.appName=t.get("appName");var o=s.email,i=s.password,r=t.getAppId(),a=t.get("workspaceId");this.linkAccount=function(){n.close();var e=[];if(s.termsAndConditionsURL){var t={date:Date.now(),url:s.termsAndConditionsURL,version:s.termsAndConditionsVersion};e=[{type:"terms",current:t,list:[t]}]}u.hapi.post("/ap/users/link-to-service",{email:o,password:i,app:{id:r,type:"distrib",conditions:e},workspace_id:a,type:"web"}).then(function(){s.login()})}}]}).catch(function(e){console.log(e)})}else n.badLogin=!0}console.log(e)})},this.cleverRedirect=function(){return u.hapi.get("/ap/users/clever-sso?workspace_id="+r.get("workspaceId")).then(function(e){window.location=e.data})},this.showValidationResult=function(e){var t=e.activationCode,n=e.email,o=p.language;l.openConfirm({template:"auth/dialogs/user-validation-result.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"30%",data:{status:t,email:n,lang:o},controllerAs:"$ctrl",controller:["$scope","$state",function(e,t){var n=this;this.VALIDATION_OK="ok",this.VALIDATION_KO="ko",this.VALIDATION_NOT_FOUND="notFound",this.status=e.ngDialogData.status,this.email=e.ngDialogData.email,this.lang=e.ngDialogData.lang,this.title=function(){var e="";return n.status===n.VALIDATION_OK?e="":n.status===n.VALIDATION_KO?e=i.instant("GT_ACTIVATION_CODE_KO_TITLE"):n.status===n.VALIDATION_NOT_FOUND&&(e=i.instant("GT_ACTIVATION_CODE_NOT_FOUND_TITLE")),e},this.message=function(){var e="";return n.status===n.VALIDATION_OK?e=i.instant("GT_ACTIVATION_CODE_OK_MSG"):n.status===n.VALIDATION_KO?e=i.instant("GT_ACTIVATION_CODE_KO_MSG"):n.status===n.VALIDATION_NOT_FOUND&&(e=i.instant("GT_ACTIVATION_CODE_NOT_FOUND_MSG")),e},this.showButton=function(e){return n.status===e},this.resendValidationMail=function(){if(n.email){var e=r.get("appId"),t=r.get("workspaceId");s.resendActivationCode(t,e,n.email,n.lang).then(function(){l.close(),l.openConfirm({width:"20%",template:"auth/dialogs/email-sent.html",showClose:!1})}).catch(function(e){console.log("Error on resendActivationCode: ",e)})}l.close()},this.goToRegister=function(){l.close(),t.go("auth.register")}}]}).catch(function(){})},this.openResend=function(){var e=p.email,t=r.get("appId"),n=r.get("workspaceId"),o=p.language;s.showResendValidationEmail(n,t,e,o)},this}]}).state("auth.login_with_clever",{url:"/login/sso?clever_key",templateUrl:"",controllerAs:"$ctrl",controller:["API","$state","SessionService",function(t,e,n){var o=this;t.hapi.post("/ap/users/login/sso",{clever_key:e.params.clever_key}).then(function(e){return t.afterLogin(e.data)}).then(function(){return t.getCloudFrontCookies({api:"ap",token:n.getToken()})}).then(function(){o.badLogin=!1,e.go(n.goToShelf())})}]}).state("auth.register",{url:"/register?token&email",templateUrl:"auth/register.html",controllerAs:"$ctrl",resolve:{singleMode:["Config","$q","$state",function(e,t,n){if(e.isSingleMode()){var o=t.defer();return o.resolve(),o.promise.then(function(){n.go("auth.login")})}}]},controller:["API","$state","Config","UserService","ngDialog","LocalStorage",function(i,r,a,s,u,l){return this.termsAndConditionsURL=a.getExternalLink("terms"),this.termsAndConditionsVersion=a.getExternalLinkVersion("terms"),this.errorUsed=!1,r.params.email&&(this.email=r.params.email,this.repeatEmail=r.params.email),this.register=function(){var t=this;if(this.password===this.repeatPassword&&this.email===this.repeatEmail){var e=[];if(this.termsAndConditionsURL){var n={date:Date.now(),url:this.termsAndConditionsURL,version:this.termsAndConditionsVersion};e=[{type:"terms",current:n,list:[n]}]}var o={email:this.email,password:this.password,identity:this.firstName+" "+this.lastName,workspace_id:a.get("workspaceId"),lang:l.get("lang"),app:{id:a.get("appId"),type:"distrib",conditions:e},type:"web"};r.params.token&&(o.registerToken=r.params.token,o.institution={conditions:o.app.conditions},delete o.app,delete o.workspace_id),i.register(o).then(function(){var e=t.email;s.showConfirmationRegistering(e)}).then(function(){t.badRegister=!1,r.go("auth.login")}).catch(function(e){t.badRegister=!0,e&&409===e.status?u.openConfirm({template:"auth/dialogs/existing-user-register.html",showClose:!1,closeByEscape:!1,focusOnOpen:!0,controllerAs:"$ctrl",controller:["$scope","$state",function(e,t){this.goToLogin=function(){u.close(),t.go("auth.login")}}]}).catch(function(e){console.log(e)}):e&&e.data&&403===e.data.statusCode&&"user-already-exist"===e.data.message?(t.badRegister=!1,t.errorUsed=!0):t.badRegister=!0,console.log(e)})}},this}]}).state("auth.forgot",{url:"/forgot-password",templateUrl:"auth/forgot.html",controllerAs:"$ctrl",resolve:{_redirect:["ModuleService","$state","Config","$window","$q",function(e,t,n,o,i){var r=i.defer();if(!e.hasModule("passwordRecovery"))return t.go("auth.login");var a=n.get("screens").passwordRecovery;return a&&a.external?o.location.href=a.external:r.resolve(),r.promise}]},controller:["API","$state",function(e,t){var n=this;return this.forgotPassword=function(){n.email&&0!=n.email.length&&e.resetPassword(n.email).then(function(e){if(200!=e.status)throw new Error("Error when resetting password.");n.badLogin=!1,n.errorEmailNotExist=!1,setTimeout(function(){t.go("auth.forgot-sent",{email:n.email,services:e.data.services})},1500)}).catch(function(e){e&&405===e.status?n.errorEmailNotExist=!0:n.badLogin=!0,console.trace(e)})},this}]}).state("auth.reset",{url:"/reset-password/:userid/:token",templateUrl:"auth/reset.html",controllerAs:"$ctrl",controller:["API","$state",function(e,t){var n=this;return this.password="",this.repeatPassword="",this.isValid=!1,e.validateOneTimeReset(t.params.userid,t.params.token).then(function(){n.isValid=!0}).catch(function(){n.isValid=!1}),this.confirmPassword=function(){n.password===n.repeatPassword&&e.confirmNewPassword(t.params.userid,t.params.token,n.password).then(function(){t.go("auth.login")}).catch(function(e){console.log(e)})},this}]}).state("auth.forgot-sent",{url:"/forgot-sent",templateUrl:"auth/forgot-sent.html",controllerAs:"$ctrl",params:{email:"",services:0},controller:["$state","$stateParams",function(e,t){this.email=t.email,this.services=t.services,this.confirm=function(){e.go("auth.login")}}]}).state("auth.single-mode",{url:"/session-expired",templateUrl:"auth/single-mode.html",controllerAs:"$ctrl",controller:function(){return this}}).state("auth.token_login",{url:"/login/sso/{token}",templateUrl:"",controllerAs:"$ctrl",controller:["API","$state","SessionService",function(t,n,o){var i=this;t.hapi.get("/v1/reader/users/sso?aptoken="+n.params.token).then(function(e){t.afterLogin(e.data),i.badLogin=!1,n.go(o.goToShelf())})}]})}]),angular.module("commons",[]),angular.module("app").controller("AssignmentsController",["$state","Library","$scope","$filter","$translate","$rootScope","Config","UsersPreferences",function(e,t,n,o,i,r,a,s){var u=this;switch(this.assignments=[],this.selectedAssignment=null,this.filteredAssignments=[],this.filters={type:{filterValue:"",defaultValue:"",testCondition:function(e,t){return e===t}},subject:{filterValue:"",testCondition:function(e,t){return e===t}},due_date:{filterValue:null,defaultValue:"",testCondition:function(e,t){return!e||((e=new Date(e))instanceof Date&&!isNaN(e.valueOf())&&(e=e.toISOString().split("T")[0]),e===(t=t.split("T")[0]))}}},this.$onInit=function(){r.Config.hasScreenSorter("assignments")?u.configSorting=r.Config.getScreenSorter("assignments"):u.configSorting=[{enabled:!0,label:"GT_SORT_DUE_DATE",target:"due_date",orderBy:"desc"},{enabled:!0,label:"GT_SORT_ASSIGNMENT_DATE",target:"start_date",orderBy:"desc"}];var e=s.get(s.KEY_DESK_ASSIGNMENT_SORTER);if(u.chosenSortOption=u.configSorting[0],e){var t=u.sortMethodConfig(e.value);t&&(u.chosenSortOption=t)}},n.$on("show-assignment-info-panel",function(e,t){u.selectedAssignment=t}),e.current.name){case"app.assignments.archive":this.assignments=t.getArchivedAssignments(),this.filteredAssignments=t.getArchivedAssignments(),this.types=t.getAssignmentTypes(),this.subjects=t.getAssignmentSubjects();break;case"app.assignments.all":default:this.assignments=t.getActiveAssignments(),this.filteredAssignments=t.getActiveAssignments(),this.types=t.getAssignmentTypes(),this.subjects=t.getAssignmentSubjects()}this.sortMethodConfig=function(t){return u.configSorting.find(function(e){return e.label===t})},this.translatedType=function(e){return i.instant("GT_CONTENT_TYPE_"+e.toUpperCase())},this.applyFilters=function(n){"app.assignments.archive"==e.current.name?u.filteredAssignments=t.getArchivedAssignments():u.filteredAssignments=t.getActiveAssignments(),Object.keys(n).forEach(function(t){n[t].filterValue&&0!==n[t].filterValue.length&&(u.filteredAssignments=u.filteredAssignments.filter(function(e){return n[t].testCondition(n[t].filterValue,e[t])}))})},this.applySorts=function(e){s.set(s.KEY_DESK_ASSIGNMENT_SORTER,e.label),u.filteredAssignments=o("orderBy")(u.filteredAssignments,e.target)},this.clearFilters=function(e){e?e.defaultValue?e.filterValue=e.defaultValue:e.filterValue=null:Object.keys(u.filters).forEach(function(e){e.filterValue=e.defaultValue||null}),u.applyFilters(u.filters)},this.closeAssignmentInfo=function(){u.selectedAssignment=null},angular.element(document).ready(function(){if(document.querySelector("#datepicker")){var e=document.querySelector("#datepicker");if(e.querySelector("div")){var t=e.querySelector("div");t.addEventListener("focusout",function(e){t.contains(e.relatedTarget)||t.classList.remove("_720kb-datepicker-open")})}}})}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.assignments",{url:"/assignments",abstract:!0,templateUrl:"app/assignments/home.html",controllerAs:"$ctrl",resolve:{_assignments:["Library","_books",function(e){return e.loadAssignments()}]},controller:function(){}}).state("app.assignments.all",{url:"",abstract:!1,templateUrl:"app/assignments/list.html",controllerAs:"$ctrl",controller:"AssignmentsController"}).state("app.assignments.archive",{url:"/archive",abstract:!1,templateUrl:"app/assignments/list.html",controllerAs:"$ctrl",controller:"AssignmentsController"})}]),angular.module("app").controller("LibraryController",["$state","Library","$scope","LocalStorage","ReadSpeakerService",function(e,t,n,o,i){var r=this;switch(o.get("view")||o.set("view","grid"),this.books=[],this.sort=null,this.selectedBook=null,this.view=o.get("view"),this.filter={},n.$state=e,n.$on("show-info-panel",function(e,t){r.selectedBook=t}),this.closeBookInfo=function(){r.selectedBook=null},e.current.name){case"app.library.books":this.books=t.getShelfBooks(),i.resetState();break;case"app.library.modules":this.books=t.getModules(),i.resetState();break;case"app.library.resources":this.books=t.getResources();break;case"app.library.favourites":this.books=t.getFavourites();break;case"app.library.all":default:this.books=t.getShelfBooks(),i.resetState()}}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.library",{url:"/library",abstract:!0,templateUrl:"app/library/home.html",controllerAs:"$ctrl",resolve:{redirect:["ModuleService","$state",function(e,t){!e.hasModule("shelf")&&e.hasModule("assignments")&&t.go("app.assignments.all")}],singleMode:["Config","$q","$state",function(e,t,n){if(e.isSingleMode()){var o=t.defer();return o.resolve(),o.promise.then(function(){n.go("auth.login")})}}],_contentsInfos:["UsersContentsInfos",function(e){return e.load()}]},controller:["Library","_contentsInfos",function(e){this.books=e.getContentsInfos()}]}).state("app.library.all",{url:"",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"}).state("app.library.books",{url:"/books",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"}).state("app.library.modules",{url:"/modules",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"}).state("app.library.resources",{url:"/resources",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"}).state("app.library.favourites",{url:"/favourites",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"})}]),angular.module("app").controller("BookController",["Library","$state","$rootScope","LocalStorage","SyncService","Iframe","MediaService","API","SessionService","Config","UsersContentsInfos","$translate",function(s,u,l,e,c,d,g,t,p,h,f,n){var m=this;if(this.$onInit=function(){m.showSidebar=!0,m.Iframe=d,m.book=s.getBookByContentId(u.params.book),m.bookTitle=m.book.getTitle(),m.navigationDirection=m.book.getPaginationMode(),m.showSearch=!1,m.privacyAndPolicyURL=h.getExternalLink("privacy"),m.termsAndConditionsURL=h.getExternalLink("terms"),m.contactUsURL=h.getExternalLink("contact"),m.helpURL=h.getExternalLink("help"),m.openNewTab=h.openNewTab(),m.topbarStyle=m.book.getTopbarStyle(),m.readerSearchFeature=m.book.readerSearchFeature(),m.readerBookmarkFeature=m.book.readerBookmarkFeature(),m.readerHighlightFeature=m.book.readerHighlightFeature(),m.readerNoteFeature=m.book.readerNoteFeature(),m.hasActiveInputFeatures=m.readerHighlightFeature||m.readerNoteFeature||m.readerBookmarkFeature,m.accessibilityFeatures=m.book.accessibilityFeatures(),m.contentsInfos=f.getBySharingId(m.book.getSharingId()),m.isFirefox="undefined"!=typeof InstallTrigger,m.ariaLive=m.isFirefox?"off":"polite";var n=!!m.book.isPDF()||m.book.countPages&&!!m.book.countPages.length;m.sharingId=null,l.$on("$stateChangeSuccess",function(){m.showSearch=!1}),"PREVIEW"!==p.readerMode&&c.updateNdAnnotationsStatus(),m.ndAnnotations=c.getNotViewedAnnotation().length,"EDIT"!==p.readerMode&&"SINGLE"!==p.readerMode||(m.user=p.getUser(),g.isPlaying=!1,m.isIubh=m.user.isIubh());var e=u.params.assignment;if(e?(m.sharingId=e,s.loadAssignmentId(e).then(function(e){m.assignment=e})):m.sharingId=m.book.getSharingId(),m.getTopbarTitle=function(){return m.book.getTopbarTitle(u.params.page)},m.isPrintEnabled=function(){if(m.user&&m.user.thirdparties.cengage){var e=h.hasFeature("print")&&n,t=m.user.thirdparties.cengage.enablePrint;return void 0!==t&&(e=e&&t),e}},u.params.page){var t=m.book.getPage(u.params.page);if(t){var o={date:Date.now(),pageId:t.path||t.id,pageTitle:t.title};f.updateLastOpening(m.sharingId,o)}}else{var i=m.lastOpenPageId(),r=m.book.getPage(i,m.book.structure.toc);if(i&&r?u.go("reader.book.page",{page:i}):0<m.book.pages.length&&(r=m.book.structure.version?m.book.structure.pagesList[0]:m.book.getPage(m.book.pages[0].path),u.go("reader.book.page",{page:r.path||r.id})),r){var a={date:Date.now(),pageId:r.path||r.id,pageTitle:r.title};f.updateLastOpening(m.sharingId,a)}}},this.lastOpenDate=function(){return m.contentsInfos&&m.contentsInfos.options&&m.contentsInfos.options.lastOpen?m.contentsInfos.options.lastOpen.date:null},this.lastOpenPageId=function(){return m.contentsInfos&&m.contentsInfos.options&&m.contentsInfos.options.lastOpen?m.contentsInfos.options.lastOpen.pageId:null},this.lastOpenPageTitle=function(){return m.contentsInfos&&m.contentsInfos.options&&m.contentsInfos.options.lastOpen?m.contentsInfos.options.lastOpen.pageTitle:null},this.toggleBookmark=function(){var e=m.book.getPage(u.params.page);c.toggleBookmark({pageId:e.path||e.id,pageTitle:e.title,sharingId:m.sharingId,contentVersion:m.book.getVersion()})},this.isPageBookmarked=function(){var e=c.isBookmarked(u.params.page,m.sharingId);return e?(m.isPageBookmarkedTitle=n.instant("GT_READER_BOOKMARK_ACTION_MARKED_ACCESS_LABEL"),!e.deleted):(m.isPageBookmarkedTitle=n.instant("GT_READER_BOOKMARK_ACTION_UNMARKED_ACCESS_LABEL"),!1)},this.nextPage=function(){return m.book.nextPage(u.params.page)},this.previousPage=function(){return m.book.previousPage(u.params.page)},this.toggleSidebar=function(){m.showSidebar=!m.showSidebar,angular.element(document.getElementsByClassName("toggle-sidebar"))[0].setAttribute("aria-label",m.getToolbarStatus(m.showSidebar));var e={left:0,top:0};m.showSidebar&&(e={left:260,top:0}),d.setToolbarMargin(e.left,e.top)},this.getToolbarStatus=function(e){var t=n.instant("GT_USER_INPUTS_EXPAND");return e&&(t=n.instant("GT_USER_INPUTS_COLLAPSE")),n.instant("GT_READER_SHOW_TOC_ACCESS_LABEL")+", "+t},this.toggleSearch=function(){m.showSearch=!m.showSearch},!u.params.page){if(!this.book)return;var o=this.book.getSharingId();this.assignment&&(o=this.assignment.id);var i=e.get(o);i?u.go("reader.book.page",{page:i}):0<this.book.pages.length&&u.go("reader.book.page",{page:this.book.pages[0].path})}return this.openUrl=function(e){window.open(e,"_blank").focus()},this}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};angular.module("app").controller("PageController",["$scope","$state","Library","$sce","$timeout","$rootScope","LocalStorage","Iframe","StatisticsService","SessionService","SyncService","SearchService","UsersContentsInfos","$translate","ngDialog",function(d,g,e,t,p,h,n,f,m,v,b,o,y,i,r){var _=this,k=g.params.book,a=g.params.assignment;this.book=e.getBookByContentId(k);var I=this.book.getPaginationMode();this.index=this.book.getIndexOfPage(g.params.page),this.page=this.book.getPage(g.params.page,this.book.structure.toc),this.iframeSrc=t.trustAsResourceUrl(this.book.getIndexFile(this.page,g.params.version)),this.features={readerNoteFeature:this.book.readerNoteFeature(),readerHighlightFeature:this.book.readerHighlightFeature()},this.sharingId=null,this.ndAnnotations=b.getUpdatedNdAnnotation().length;var s=v.mobileCheck(),u=v.getDisplayMobileWarning();this.mainContent=i.instant("GT_READER_MAIN_CONTENTS_GROUP_ACCESS_LABEL")+"."+i.instant("GT_READER_ANNOTATIONS_INSTRUCTION_ACCESSIBILITY"),a?(this.sharingId=a,e.loadAssignmentId(a).then(function(e){_.assignment=e})):this.sharingId=this.book.getSharingId(),this.resetToolbar=function(){_.toolbar={show:!1,position:null,note:!1,edit:!1,highlight:null,showNoteAndHighlight:!0,selectedText:null}},s&&!u&&(r.open({template:"app/reader/components/mobile-mode/mobile-warning.html",controllerAs:"$ctrl",appendClassName:"directive-modal-common",className:"ngdialog-theme-default mobile-mode",closeByEscape:!1,showClose:!1,height:"380px",focusOnOpen:!0,controller:"MobileModeController"}),v.setDisplayMobileWarning(!0)),this.resetToolbar(),this.ndAnnotationSetting={number:this.ndAnnotations,show:0<this.ndAnnotations};var l=n.get("last-item");l&&l!==this.sharingId&&o.clearSearch(),n.set("last-item",this.sharingId);var S=angular.element(document.querySelector("#iframe-page"))[0];return f.init(S,function(){var e=S.contentDocument||S.contentWindow.document,t=e.querySelectorAll("#"+g.params.highlight),r=S.contentWindow,i=e.getElementsByTagName("body")[0],a=null;h.showNavigationBottom=!1,h.showNavigationTop=!1;var n=0;_.assignment&&"evaluation"==_.assignment.type&&(n=_.book.getExerciseCount(),null==_.book._submittedExercises&&(_.book._submittedExercises=0));var o=void 0;_.book&&_.book.isbn&&-1===(o={eISBN:_.book.isbn,page_index:_.book.getIndexOfPage(_.page.path||_.page.id)}).page_index&&(o.page_index=0);function s(){var e=50*h.showNavigationBottom+50*h.showNavigationTop,t=i.offsetHeight,n=r.pageYOffset,o=window.innerHeight<i.firstElementChild.scrollHeight;p(function(){h.showNavigationTop=0!=_.index&&n-e-r.innerHeight/t*150<=0,h.showNavigationBottom=_.index+1!==_.book.pages.length-1&&t-r.innerHeight-n-e-r.innerHeight/t*150<=0||!o&&_.index+1!==_.book.pages.length})}function u(){var e=50*h.showNavigationBottom+50*h.showNavigationTop,t=i.offsetHeight,n=r.pageYOffset,o=window.innerHeight<i.firstElementChild.scrollHeight;p(function(){h.showNavigationLeft=0!=_.index,h.showNavigationRight=_.index!=_.book.pages.length-1,h.cyclicNavigation=_.index===_.book.pages.length-1,h.showNavigationTop=0!=_.index&&n-e-r.innerHeight/t*150<=0&&t!==r.innerHeight,h.showNavigationBottom=_.index+1!==_.book.pages.length&&t-r.innerHeight-n-e-r.innerHeight/t*150<=0||!o&&_.index+1!==_.book.pages.length})}if("v"===I?(s(),r.onscroll=s):(u(),r.onscroll=u),g.params.highlight&&f.focusHighlight(g.params.highlight),g.params.search&&f.search(g.params.search),g.params.scrollTo&&f.scrollToElement(g.params.scrollTo),f.onSelectedText(function(e,t,n){if(a=e,n)d.$apply();else{var o=Boolean(e.trim().length);_.selectedText=e,o&&null!=t?_.showToolbar(!0):_.toolbar.showNoteAndHighlight=!1,t&&o&&(_.toolbar.position={top:t.y,left:t.x}),h.ReadAloud.toolbar=o?"close":h.ReadAloud.toolbar,d.$apply()}}),_.showToolbar=function(e){_.resetToolbar(),_.toolbar.selectedText=_.selectedText,_.toolbar.show=e,p(function(){var e;(e=angular.element(document.getElementsByClassName("colors"))[0])&&e.children[0].focus()},1)},f.iframe.contentWindow.addEventListener("mousedown",function(){_.toolbar.show&&(_.showToolbar(!1),d.$apply())},!1),f.onSelectedHighlight(function(e,t,n){_.resetToolbar(),_.toolbar.show=!0,_.toolbar.edit=!0,_.toolbar.highlight=t,_.toolbar.note=t.isNote,_.toolbar.selectedText=t.text,n&&(_.toolbar.position={top:n.y,left:n.x}),d.$apply()}),f.on("gt-goto",function(e){e.fpath&&g.go("reader.book.page",{book:k,page:e.fpath,scrollTo:e.elementid})}),f.on("gt-showpage",function(){}),f.on("gt-email",function(e){var t="mailto:"+e.recipient,n="subject="+e.obj,o="body="+encodeURIComponent(e.body);window.location=t+"?"+n+"&"+o}),f.on("gt-savequizz",function(){}),f.on("gt-resetquizz",function(){}),f.on("gtSaveExercise",function(e){b.addExercise(_extends({sharingId:_.sharingId,contentVersion:_.book.getVersion(),pageTitle:_.page.title||""},e),_.page.path),e.submitted&&(m.exerciseGraded({exoData:e,pageId:_.page.path,bookId:_.book.project_id||_.book.id,assignment:_.assignment,loId:_.page.identifier||_.page.path}),m.endPageViewed(_.pageViewedEvent),m.startPageViewed({pageId:_.page.path,bookId:_.book.project_id||_.book.id,assignment:_.assignment,additionalInfo:o||void 0}).then(function(e){return _.pageViewedEvent=e}),_.assignment&&"evaluation"==_.assignment.type&&(_.book._submittedExercises++,_.book._submittedExercises==n&&(_.assignment.submitted=!0)))}),f.on("gtResetExercise",function(e){b.deleteExercise(e,_.sharingId)}),f.on("gt-bookmark",function(){}),"PREVIEW"!==v.readerMode){m.startPageViewed({pageId:_.page.path||_.page.id,bookId:_.book.project_id||_.book.id,assignment:_.assignment,additionalInfo:o||void 0}).then(function(e){return _.pageViewedEvent=e}),r.onbeforeunload=function(){m.endPageViewed(_.pageViewedEvent)};var l=d.$on("$stateChangeStart",function(e,t,n,o,i){n.anchor&&(r.location.hash=n.anchor),_.pageViewedEvent&&n.page!=i.page&&m.endPageViewed(_.pageViewedEvent),l()})}if("PREVIEW"!==v.readerMode){var c={pageId:_.page.path||_.page.id,pageTitle:_.page.title};y.updateLastOpening(_.sharingId,c)}_.loaded=!0,document.body.addEventListener("keydown",function(e){if((e.ctrlKey||e.metaKey)&&("c"===e.key||"C"===e.key)){var t=document.createElement("textarea");t.style.width="0",t.style.height="0",t.value=a,document.body.appendChild(t),t.focus(),t.select(),document.execCommand("copy"),document.body.removeChild(t)}}),t&&Array.from(t,function(e){e.blur(),d.$apply()})}),this}]).controller("MobileModeController",["$translate","$sce","$scope",function(e,t,n){n.warningDesc=t.trustAsHtml(e.instant("GT_MOBILE_WARNING_DESCRIPTION"))}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};angular.module("app").config(["$stateProvider",function(e){var t={_user:["API","SessionService","User","_ssoLogin",function(e,t,n,o){if("PREVIEW"!=t.readerMode&&("SINGLE"!=t.readerMode||t.getUserId()))return e.getUser().then(function(e){return t.user=new n(e),e})}],_assignments:["Library","_library","_user",function(e,t,n){return e.loadAssignments()}],_library:["Library","_ssoLogin","$state","$stateParams","_user",function(e,t,n,o,i){var r=n.params.projectId,a=o.book;return r?e.load({projectId:r}):e.load({book_content_id:a})}],_sync:["SessionService","SyncService","_ssoLogin","_library","_user",function(e,t,n,o,i){if("PREVIEW"!=e.readerMode)return t.load()}],_book:["_library","$stateParams","$state","_user",function(e,t,n,o){var i=e.getBookByContentId(t.book);if(i)return i.getStructure(t.version);n.go("app.library.all")}],_assignment:["Library","_library","$stateParams","_user",function(e,t,n,o){if(n.assignment)return e.loadAssignmentId(n.assignment)}],_bookFeatures:["_library","$stateParams","$state","_user",function(e,t,n,o){var i=e.getBookByContentId(t.book);if(i)return i.getFeatures(t.version);n.go("app.library.all")}],_userContentsInfos:["UsersContentsInfos","SessionService","_ssoLogin","_library","_user",function(e,t,n,o,i){if("PREVIEW"!=t.readerMode)return e.load()}],_userPreferences:["UsersPreferences","SessionService","_ssoLogin","_library","_user",function(e,t,n,o,i){if("PREVIEW"!=t.readerMode)return e.load()}]};e.state("reader",{url:"/reader?sso&assignment&username&token",abstract:!0,controllerAs:"$ctrl",templateUrl:"app/reader/reader.html",resolve:{_config:["Config",function(e){return e.load()}],singleMode:["Config","SessionService",function(e,t){e.isSingleMode()&&t.setReaderMode("SINGLE")}],_theme:["Theme","Config",function(e,t){var n=t.get("theme").current;n&&""!=n||(n="default");var o=t.get("theme").themes[n];return e.setTheme(o)}],_settings:["API","SettingService",function(e,i){return e.get("/components/native-js-libs/accessibility.json").then(function(e){_extends(i,e.data);var t=void 0,n=0==window.navigator.platform.toUpperCase().indexOf("MAC"),o=0==window.navigator.platform.toUpperCase().indexOf("WIN");return t=n?"osx":o?"windows":"other",i.fonts=i.fonts[t],i})}],_ssoLogin:["$state","$stateParams","API","$location",function(e,t,n,o){return t.sso?n.ssoLogin(t.sso).then(function(e){return n.afterLogin(e)}).then(function(){return n.getCloudFrontCookies({api:"ap",token:t.sso})}).catch(function(){throw e.go("auth.login"),new Error("Invalid token")}):t.username&&t.token?n.login({email:t.username,password:t.token}).then(function(){o.search("username",null),o.search("token",null)}).catch(function(){throw e.go("auth.login"),new Error("Invalid token")}):void 0}]},controller:["Config","$location",function(e,t){this.iosConfig=e.get("ios"),this.androidConfig=e.get("android");var n=e.isMobile(this.androidConfig.id,this.iosConfig.storeId);if(e.hasFeature("universalLink")&&n.mobile){var o=n.customLink,i=window.location;t.replace(o),window.setTimeout(function(){window.location=i,e.mobileCheckModal(n)},10)}return this}]}).state("reader.book",{url:"/:book?version",abstract:!1,templateUrl:"app/reader/index.html",resolve:_extends({_getMedias:["_library","SessionService","MediaService","$stateParams","_user",function(e,t,n,o,i){if("EDIT"==t.readerMode){var r=t.getUser().isIubh(),a=e.getBookByContentId(o.book);return r&&a.project_metas.value[0]?n.getMediaStreaming(a.project_metas.value[0].value):n.medias=[]}}],_singleMode:["Config","SessionService","$q","$state","_library",function(e,t,n,o,i){if(e.isSingleMode()){var r=t.getSingleModeConfig().isbn,a=n.defer();if(a.resolve(),i._library[0]&&i._library[0].isbn!==r)return a.promise.then(function(){o.go("auth.login")})}}]},t),controllerAs:"$ctrl",controller:"BookController"}).state("reader.userinput",{url:"/:book/userinput",abstract:!1,templateUrl:"app/reader/user-input/user-input.html",resolve:t,controllerAs:"$ctrl",controller:"userInput"}).state("reader.book.page",{url:"/page/:page?highlight&scrollTo&search",abstract:!1,resolve:{_exists:["_library","_book","$stateParams","$q","$state",function(e,t,n,o,i){var r=e.getBookByContentId(n.book);if(!r)throw new Error("Book not found");var a=r.getPage(n.page);return a||((a=r.getPageByPath(n.page))?i.go("reader.book.page",{page:a.id,search:n.search}):i.go("reader.book",{book:n.book})),!0}]},templateUrl:"app/reader/page.html",controllerAs:"$ctrl",controller:"PageController"}).state("reader.mefsso",{url:"/mefsso/:meftoken/:workspaceId/:projectId/:version",controllerAs:"$ctrl",resolve:{_mefSSO:["$stateParams","SessionService","Config","API",function(e,t,n,o){return n.config.workspaceId=window.config.workspaceId=e.workspaceId,t.setMEFToken(e.meftoken,e.workspaceId),o.getCloudFrontCookies({api:"mef",token:e.meftoken})}],_library:["Library","_mefSSO","$stateParams",function(e,t,n){var o=n.projectId;return e.load({projectId:o})}],_redirect:["_mefSSO","_library","$stateParams","$state",function(e,t,n,o){var i=t.getBookByProjectId(n.projectId);o.go("reader.book",{book:i.book_content_id,version:n.version})}]}}).state("reader.login_with_cengage",{url:"/jwt/tribble?jwt",templateUrl:"",controllerAs:"$ctrl",controller:["API","$state","Config","SessionService","User","LocalStorage",function(n,e,t,o,i,r){r.clear();var a=e.params.jwt,s=t.get("workspaceId"),u=t.get("appId"),l={};n.hapi.post("/v1/reader/users/cengage-jwt",{workspace_id:s,app_id:u,jwt:a}).then(function(e){n.afterLogin(e.data.user);var t=e.data.user.thirdparties.cengage.isbn;o.setSingleModeConfig({type:"cengage",isbn:t}),o.user=new i(e.data.user),o.setReaderMode("SINGLE"),l.book_content_id=e.data.book_content_id}).then(function(){return n.getCloudFrontCookies({api:"ap",token:o.getToken()})}).then(function(){e.go("reader.book",{book:l.book_content_id})}).catch(function(){r.clear(),e.go("auth.login")})}]})}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.statistics",{url:"/statistics",abstract:!1,templateUrl:"app/statistics/home.html",controllerAs:"$ctrl",controller:["SessionService","Theme","ColorAccessibility","API","SyncService","StatisticsService","$translate",function(e,t,n,o,i,r,s){var a=this;this.user=e.getUser();var u=t.getTheme();this.primaryContrat=n.relativeLuminance(u.primaryColor.value),this.userStats={},r.getUserStatistics().then(function(e){a.userStats=e}),this.getFullTime=function(e){var t=s.instant("GT_HOURS"),n=s.instant("GT_MINUTES"),o=Math.ceil(e/1e3/60)/60,i=Math.floor(o),r=60*(o-i),a=Math.ceil(r);return i?i+" "+t+" "+a+" "+n:a+" "+n},this.bookmarksLength=i.getBookmarks().filter(function(e){return!e.deleted}).length,this.highlightsLength=i.getHighlights().filter(function(e){return!e.deleted}).length,this.notesLength=i.getNotes().filter(function(e){return!e.deleted}).length}]}).state("app.userinput",{url:"/statistics/userinput",abstract:!0,resolve:{_assignments:["Library","_books",function(e){return e.loadAssignments()}],_book:["$q","Library","SyncService","_sync","_assignments","_books",function(r,a,e){var s=[],t=e.get();if(t.length)return t.forEach(function(e){var t=a.getBookOrAssignmentBySharingId(e.sharingId);if(t){var n=t.book_content_id||a.getBookByLMSId(t.getLMSId()).book_content_id,o=a.getBookByContentId(n),i=r.defer();return o.getStructure().then(i.resolve).catch(function(e){console.log(e),i.resolve()}),s.push(i.promise)}}),r.all(s)}]},templateUrl:"app/statistics/user-input/user-input.html",controllerAs:"$ctrl",controller:"globalUserInput"})}]),angular.module("app").controller("StatisticsController",function(){});var _createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}(),_get=function e(t,n,o){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,n,o)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(o):void 0};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").factory("Library",["Entities","Config","$http","Book","$q","API","Assignment","SessionService","LocalStorage","StatisticsService","UsersContentsInfos",function(e,d,t,g,i,n,u,p,h,o,r){function f(){_classCallCheck(this,f);var e=_possibleConstructorReturn(this,(f.__proto__||Object.getPrototypeOf(f)).call(this));return e._library=[],e._assignments=[],e._data=null,e._allBooksLoaded=!1,e}return new(_inherits(f,e),_createClass(f,[{key:"load",value:function(e){var n=this,t=0<arguments.length&&void 0!==e?e:{},o=t.projectId,i=t.book_content_id,r=t.allBooks,a=void 0!==r&&r;if(this._library.length&&this._allBooksLoaded)return this;var s=d.get("appId"),u=d.get("workspaceId")||h.get("workspaceId"),l=p.getUserId(),c=h.get("cacheToken");return _get(f.prototype.__proto__||Object.getPrototypeOf(f.prototype),"load",this).call(this,"/v1/reader/users/cacheToken?app_id="+s+"&user_id="+l).then(function(e){e&&e!==c&&h.set("cacheToken",e);var t=!e||o||i?"?metaType=web&app_studio_id="+s:"?c="+e+"&metaType=web&app_studio_id="+s;return p.getLMS()||(t+="&app_id="+s+"&workspace_id="+u),o?t+="&project_id="+o:i&&(t+="&book_id="+i),_get(f.prototype.__proto__||Object.getPrototypeOf(f.prototype),"load",n).call(n,"/v2/reader/books/store"+t)}).then(function(e){n._library=[];var t=e[0];t.books&&t.books.forEach(function(e){var t=new g(e);n._library.push(t)}),n._library.sort(function(e,t){return parseInt(t.export_date,0)-parseInt(e.export_date,0)}),n._data=t,n._allBooksLoaded||(n._allBooksLoaded=a)}).then(function(){return n})}},{key:"loadAssignments",value:function(){var n=this,o=[];return this._assignments.length?this._assignments:(this._assignments=[],this._data&&this._data.assignments&&this._data.assignments.forEach(function(e){var t=new u(e);o.push(t.loadPagesRead()),n._assignments.push(t)}),i.all(o))}},{key:"loadAssignmentId",value:function(e){var a=this,t=this.getAssignmentById(e);if(t)return i.resolve(t);var n=d.get("appId"),s=null;return _get(f.prototype.__proto__||Object.getPrototypeOf(f.prototype),"load",this).call(this,"/v2/reader/books/store?app_studio_id="+n+"&assignment_id="+e+"&metaType=web").then(function(e){var t=e[0];if(t.books&&t.books.length){var n=t.books[0];if(!a._library.some(function(e){return e.id===n.id})){var o=new g(n);a._library.push(o),a._data.books.push(n)}}if(t.assignments&&t.assignments.length){var i=t.assignments[0];if(s=i,!a._assignments.some(function(e){e.id,i.id})){var r=new u(i);r.loadPagesRead(),a._assignments.push(r),a._data.assignments.push(i)}}return s})}},{key:"_filterLibrary",value:function(t){return this._library.filter(function(e){if(e.type===t)return e})}},{key:"getAssignments",value:function(){return this._assignments}},{key:"getAssignmentById",value:function(t){return this._assignments.find(function(e){return e.id==t})}},{key:"getActiveAssignments",value:function(){return this.getAssignments().filter(function(e){var t=new Date(e.due_date),n=new Date,o=new Date(e.end_date);return n<t&&n<o})}},{key:"getArchivedAssignments",value:function(){return this.getAssignments().filter(function(e){var t=new Date(e.due_date),n=new Date,o=new Date(e.end_date);return t<=n&&n<o})}},{key:"getAll",value:function(){return this._library}},{key:"getBooks",value:function(){return this._filterLibrary("book")}},{key:"getShelfBooks",value:function(){return this._library.filter(function(e){if("book"===e.type&&e.sharing&&e.sharing.distributions&&-1<e.sharing.distributions.indexOf("shelf"))return e})}},{key:"getModules",value:function(){return this._filterLibrary("module")}},{key:"getModuleById",value:function(t){return this._library.find(function(e){if("module"===e.type&&e.id==t)return e})}},{key:"getResources",value:function(){return this._filterLibrary("resource")}},{key:"getFavourites",value:function(){return this._library.filter(function(e){if(!0===e.favourite)return e})}},{key:"getAssignmentTypes",value:function(){var t=[];return this._assignments.forEach(function(e){t.includes(e.type)||t.push(e.type)}),t}},{key:"getAssignmentSubjects",value:function(){var t=[];return this._assignments.forEach(function(e){t.includes(e.subject)||t.push(e.subject)}),t}},{key:"getBookByContentId",value:function(t){return this._library.find(function(e){return e.book_content_id===t})}},{key:"getBookByBookId",value:function(t){return this._library.find(function(e){return e.book_id===t||e.newapi_id===t})}},{key:"getBookByLMSId",value:function(t){return this._library.find(function(e){return e.newapi_id===t})}},{key:"getBookByProjectId",value:function(t){return this._library.find(function(e){return e.project_id===t&&"html5"===e.format})}},{key:"getBookOrAssignmentBySharingId",value:function(t){var e=this.getAssignmentById(t);return e||this._library.find(function(e){return e.getSharingId()==t})}},{key:"getContentsInfos",value:function(){return this._library.forEach(function(e){e.last_open_date=0;var t=r.getBySharingId(e.getSharingId());t&&t.options.lastOpen&&(e.last_open_date=t.options.lastOpen.date)}),this._library}}]),f)}]),angular.module("commons").filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.substr(1).toLowerCase():""}});var _window=window,he=_window.he;angular.module("commons").filter("decodeHTML",function(){return function(e){return e?he?he.decode(e):e:""}}),angular.module("commons").filter("decodeURI",function(){return decodeURI}),angular.module("commons").filter("percentage",function(){return function(e){return e+"%"}}),angular.module("commons").filter("readMore",["$sce",function(a){return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=arguments[1],n=t.size?t.size:20,o=e.replace(/[%]/g,"%25"),i=decodeURIComponent(o).replace(/<\/?[^>]+(>|$)/g,"");if(t.html&&(i=o),null==i||i&&i.length<=n||t.full)return a.trustAsHtml(i);var r=a.trustAsHtml(i).toString().substr(0,n);return a.trustAsHtml(r+"...")}}]),angular.module("commons").filter("sanitizeText",function(){return function(e){if(e){return e.replace(/(?:\u0000|&#0;|&#x0;)*/gi,"")}}}),angular.module("commons").filter("userInputsSync",["$state","Library",function(t,i){return function(e){function n(){switch(t.current.name){case"reader.userinput.notes":return"note";case"reader.userinput.bookmarks":return"bookmark";case"reader.userinput.highlights":return"highlight";case"reader.userinput.notdisplayed":return"notdisplayed";default:return null}}var o=[];return e.filter(function(e){var t=i.getBookOrAssignmentBySharingId(e.sharingId);"training"!==t.type&&"evaluation"!==t.type||!t.book_id?"training"!==t.type&&"evaluation"!==t.type||!t.module_id?("notdisplayed"===n()&&!t.getPage(e.pageId)||n()==e.type&&t.getPage(e.pageId))&&o.push(e):("notdisplayed"===n()&&!i.getBookByBookId(t.module_id).getPage(e.pageId)||n()==e.type&&i.getBookByBookId(t.module_id).getPage(e.pageId))&&o.push(e):("notdisplayed"===n()&&!i.getBookByBookId(t.book_id).getPage(e.pageId)||n()==e.type&&i.getBookByBookId(t.book_id).getPage(e.pageId))&&o.push(e)}),n()?o:e}}]),window.langs={languages:{en:{default:!0,translations:{GT_LOGIN_RESEND_INVITATION_LINK:"Resend Invitation Link"}},fr:{default:!1,translations:{GT_LOGIN_RESEND_INVITATION_LINK:"Resend Invitation Link"}}}};_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").factory("Assignment",["Entity","StatisticsService",function(e,n){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"loadPagesRead",value:function(){var t=this;return n.getNbPagesRead(this.id).then(function(e){return t.pagesRead=e})}},{key:"getLMSId",value:function(){return this.book_id||this.module_id}},{key:"getIndexOfPage",value:function(){return null}},{key:"getTitle",value:function(){return this.title}}]),t}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").factory("Book",["Entity","API","$q",function(e,n,o){function i(e){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.pages=[],t.uniquePages=[],t}return _inherits(i,e),_createClass(i,[{key:"getStructure",value:function(e){var t=this;return this.structure||this._loading?o.resolve(this.structure):(this._loading=!0,n.sameOriginHapi.get("/v1/reader/read/"+this.book_content_id+"/"+(e||this.version)+"/structure.json",this._entity).then(function(e){return t.structure=e.data.book,t.structure.version=e.data.version,t.pages=[],t._getPages(t.structure.content),t.uniquePages=[].concat(_toConsumableArray(new Set(t.pages.map(function(e){return e.path})))),t.structure.version&&(t.navigationPages=t.structure.pagesList.filter(function(e){return-1<e.role.indexOf("navigation")}),t.countPages=t.structure.pagesList.filter(function(e){return-1<e.role.indexOf("count")})),t._loading=!1,t.structure}))}},{key:"getFeatures",value:function(e){var t=this;return this.features||this._loading_features?o.resolve(this.features):(this._loading_features=!0,n.sameOriginHapi.get("/v1/reader/read/"+this.book_content_id+"/"+(e||this.version)+"/config.json",this._entity).then(function(e){return t.features=e.data,t._loading_features=!1,t.features}))}},{key:"_getPages",value:function(e){var n=this;return e.reduce(function(e,t){return"true"!==t.isPage?n._getPages(t.content||[]):n.pages.push(t),n.pages},[])}},{key:"nextPage",value:function(t){if(!this.structure.version){var e=this.uniquePages.findIndex(function(e){return e===t})+1;return e>=this.uniquePages.length&&(e=0),this.getPage(this.uniquePages[e])}var n=this.getPage(t);if(n){var o=this.getIndexOfPage(n.pageId)+1;return o>=this.navigationPages.length&&(o=0),this.navigationPages[o]}}},{key:"previousPage",value:function(t){if(!this.structure.version){var e=this.uniquePages.findIndex(function(e){return e===t})-1;return e<0&&(e=this.uniquePages.length-1),this.getPage(this.uniquePages[e])}var n=this.getPage(t);if(n){var o=this.getIndexOfPage(n.pageId)-1;return o<0&&(o=this.navigationPages.length-1),this.navigationPages[o]}}},{key:"getIndexFile",value:function(e,t){return this.structure.version?this.getIndexFileV1(e.target,t):e&&"true"===e.isPage?"api/v1/reader/stream/"+this.book_content_id+"/"+(t||this.version)+"/"+e.localPath:void 0}},{key:"getIndexFileV1",value:function(e,t){return"api/v1/reader/stream/"+this.book_content_id+"/"+(t||this.version)+"/"+e}},{key:"getPageByStruct",value:function(e,t){if(e.path===t&&"true"===e.isPage)return e;if(!e.content)return null;var n=null;for(var o in e.content)if(null!=(n=this.getPageByStruct(e.content[o],t)))break;return n}},{key:"getPage",value:function(e,t){if(this.structure&&e)return this.structure.version?(t=t||this.structure.toc,this.getSubpage(e,t)):this.getPageByStruct(this.structure,e)}},{key:"getCountPage",value:function(t){if(this.countPages)return this.countPages.find(function(e){return e.id==t})}},{key:"getCountPageByNum",value:function(t){if(this.countPages)return this.countPages.find(function(e){return e.num==t})}},{key:"getPageV1",value:function(t,e){var n=this;if(this.structure&&t)return this.navigationPages[0].id==t?(this.subpage=this.navigationPages[0],this.subpage):e.find(function(e){return e.id==t?(n.subpage=e,n.subpage):e.children?n.getPageV1(t,e.children):void 0})}},{key:"getPageByPath",value:function(t){var n=this.pages.find(function(e){return e.path===t});return this.structure.pagesList.find(function(e){return e.target===n.localPath})}},{key:"getSubpage",value:function(e,t){return this.getPageV1(e,t)||(this.subpage=this.getCountPage(e)),this.subpage}},{key:"getIndexOfPage",value:function(t){return this.structure.version?this.navigationPages.findIndex(function(e){return e.pageId===t}):this.pages.findIndex(function(e){return e.path===t})}},{key:"getIndexOfPageV2",value:function(t){return this.navigationPages.findIndex(function(e){return e.pageId==t})}},{key:"getFirstPageFromStruct",value:function(e){if(!e)return null;if("true"==e.isPage)return e;if(!e.content)return null;var t=null;for(var n in e.content)if(null!=(t=this.getFirstPageFromStruct(e.content[n])))break;return t}},{key:"getPages",value:function(){return this.pages}},{key:"getExerciseCount",value:function(){return this.pages.filter(function(e){return"exercise"===e.type}).length}},{key:"getSharingId",value:function(){return this.project_id||this.newapi_id}},{key:"getPartOrSection",value:function(t,e){var n=this,o=e||this.structure.content,i=null;return o.forEach(function(e){i||(e.path==t&&(i=e),e.content&&(i=n.getPartOrSection(t,e.content)?e:null))}),i}},{key:"getTitle",value:function(){if(this.isbn!==this.title)return this.title;var e=this.project_metas.value;if(e&&e.length){var t=e.find(function(e){return"title"===e.name.toLowerCase()});if(t&&t.value)return t.value}return this.title}},{key:"getPageTitle",value:function(e){if(void 0!==this.getPage(e))return this.getPage(e).title}},{key:"getTopbarStyle",value:function(){if(this.features)return this.features.topbar.style}},{key:"getTopbarTitle",value:function(e){if(!this.features||!this.features.topbar||!this.features.topbar.display)return this.getTitle();var t=this.features.topbar.display.title;return"project"===t?this.getTitle():"page"===t?this.getPageTitle(e):null}},{key:"readerSearchFeature",value:function(){if(this.features&&"module"!==this.type)return this.features.features.search}},{key:"readerBookmarkFeature",value:function(){if(this.features&&"module"!==this.type)return this.features.features.bookmarks}},{key:"readerHighlightFeature",value:function(){if(this.features&&"module"!==this.type)return this.features.features.highlights}},{key:"readerNoteFeature",value:function(){if(this.features&&"module"!==this.type)return this.features.features.notes}},{key:"accessibilityFeatures",value:function(){if(this.features&&"module"!==this.type)return this.features.features.accessibility}},{key:"getTocLevel",value:function(){if(this.features&&"module"!==this.type)return this.features.toc.level}},{key:"getPaginationMode",value:function(){if(this.features&&"module"!==this.type)return"vertical"===this.features.navigation.pagination?"v":"h"}},{key:"getVersion",value:function(){return this.version}},{key:"isPDF",value:function(){return this.importType&&"pdf"===this.importType}},{key:"isEpubFixed",value:function(){return this.importType&&"epub-fixed"===this.importType}},{key:"isEpubReflow",value:function(){return this.importType&&"epub-reflow"===this.importType}}]),i}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("Evaluation",["Entity","SessionService","$interval",function(e,n,t){function o(e){if(_classCallCheck(this,o),this.assignment=e,this.user=n.getUser(),this.options=e.evaluation_options,this.user.assignments_status||(this.user.assignments_status={}),this.user.assignments_status[this.assignment.id]||(this.user.assignments_status[this.assignment.id]={status:"not_started",time_spent:0}),this.assignment_status=this.user.assignments_status[this.assignment.id],"finished"!=this.assignment_status.status){var t=Date.now();new Date(this.assignment.due_date).getTime()<t&&this.finish()}}return _createClass(o,[{key:"_patch",value:function(e){if(!e)throw new Error("status is not defined");return this.assignment_status.status=e,this.user.assignments_status[this.assignment.id]=this.assignment_status,this.user.patch({assignments_status:this.user.assignments_status})}},{key:"_clear",value:function(){this._interval&&(t.cancel(this._interval),delete this._interval)}},{key:"start",value:function(){var e=this;this.isFinished()||(this._start=Date.now()-this.assignment_status.time_spent,this._patch("in_progress"),this._interval=t(function(){e.assignment_status.time_spent>=e.options.duration?e.finish().then(function(){"function"==typeof e._onFinish&&e._onFinish()}):(e.assignment_status.time_spent=1e3*((Date.now()-e._start)/1e3).toFixed(0),e.assignment_status.time_spent%1e4==0&&e._patch("in_progress"))},1e3))}},{key:"finish",value:function(){return this._clear(),this.assignment_status.time_spent=this.options.duration,this._patch("finished")}},{key:"isFinished",value:function(){return this.assignment_status.time_spent>=this.options.duration}},{key:"onFinish",value:function(e){this._onFinish=e}},{key:"pause",value:function(){this.isFinished()||(this._clear(),this.options.user_can_leave?this._patch("started"):this.finish())}},{key:"addTimeOffset",value:function(e){this._start+=e}},{key:"getReadableTimeSpent",value:function(){var e=new Date(this.options.duration-this.assignment_status.time_spent);return[e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()].map(function(e){return 1==(""+e).length?"0"+e:e}).join(":")}}]),o}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("StatisticsEvent",["Config",function(e){function a(e){var t=e.type,n=e.object,o=e.result,i=e.context,r=e.user;_classCallCheck(this,a),this.type=t,this.object=n,this.result=o,this.context=i,this.user=r}return _createClass(a,[{key:"end",value:function(){var e=new Date,t=new Date(this.result.started),n=e.getTime()-t.getTime();this.result={duration:n,ended:e.toISOString(),started:t.toISOString()}}},{key:"getLocalDateISOString",value:function(){function e(e,t){var n=Math.abs(Math.floor(e)).toString();if(n.length>t)return n;for(var o="",i=0;i<t-n.length;i++)o+="0";return o+n}var t=new Date,n=t.getTimezoneOffset();return t.getFullYear().toString().concat("-",e(t.getMonth()+1,2),"-",e(t.getDate(),2),"T",e(t.getHours(),2),":",e(t.getMinutes(),2),":",e(t.getSeconds(),2),".",e(t.getMilliseconds(),3),n<0?"+":"-",e(Math.abs(n)/60,2),":",e(Math.abs(n)%60,2))}},{key:"toObject",value:function(){return{editor_id:e.get("workspaceId"),actor:{user_id:this.user.id,email:this.user.email},authority:{reader:"Webreader",osVersion:window.navigator.platform,appVersion:window.wrVersion||"v3",browser:window.navigator.userAgent},timestamp:(new Date).toISOString(),localTimestamp:this.getLocalDateISOString(),verb:{name:this.type},result:this.result,object:this.object,context:this.context}}}]),a}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").factory("User",["Entity",function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"/v1/reader/users"))}return _inherits(t,e),_createClass(t,[{key:"isIubh",value:function(){this.thirdparties.iubh}}]),t}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").service("API",["Config","$http","$q","SessionService","$state","LocalStorage",function(r,c,a,s,t,u){var e,d=this;function n(){_classCallCheck(this,n)}function o(){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments))}window.Config=r,this.pushSubscribing=!1,this._logoutMiddleware=function(e){if(!e||!e.data||"Your token is invalid!"!=e.data.message)throw e;s.logOut(),t.go("auth.login",{expired:1}),console.trace("API error ",e)},this._keepTrying=function(n){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:3,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1e3;return n().catch(function(e){var t=a.defer();return e.status<=0&&0<o?setTimeout(function(){d._keepTrying(n,o-1,i).then(t.resolve).catch(t.reject)},i):t.reject(e),t.promise})},this.hapi=(_createClass(n,null,[{key:"post",value:function(e,t,n){var o=this._makeUrl(e),i=_extends({},n),r=null;if(i.retry){var a=i.retry,s=a.count,u=a.delay;r=this._keepTrying(function(){return c.post(o,t,i)},s,u)}else r=c.post(o,t,i);return r.catch(this._logoutMiddleware)}},{key:"put",value:function(e,t){return c.put(this._makeUrl(e),t).catch(this._logoutMiddleware)}},{key:"patch",value:function(e,t){return c.patch(this._makeUrl(e),t).catch(this._logoutMiddleware)}},{key:"get",value:function(e){return c.get(this._makeUrl(e)).catch(this._logoutMiddleware)}},{key:"delete",value:function(e){return c.delete(this._makeUrl(e)).catch(this._logoutMiddleware)}},{key:"batchTemplate",value:function(e,t,n){return{method:e,path:t,payload:n,query:{aptoken:s.getToken()}}}},{key:"_getFullUrl",value:function(){return r.get("hapiRho")}},{key:"_makeUrl",value:function(e){var t=this._getFullUrl()+e,n=s.getToken(),o=-1===t.indexOf("?")?"?":"&";if("PREVIEW"!=s.readerMode)return!n||t.match(/[?&]aptoken=/)?t:t+o+"aptoken="+n;var i=s.getMEFToken();return!i||t.match(/[?&]meftoken=/)?t:t+o+"meftoken="+i}}]),n),this.statistics={post:function(e,t,n){var o=2<arguments.length&&void 0!==n?n:{},i=d.statistics._makeUrl(e),r=_extends({},{headers:d.statistics._makeHeaders()},o),a=null;if(r.retry){var s=r.retry,u=s.count,l=s.delay;a=d._keepTrying(function(){return c.post(i,t,r)},u,l)}else a=c.post(i,t,r);return a.catch(d._logoutMiddleware)},put:function(e,t){var n=d.statistics._makeUrl(e),o={headers:d.statistics._makeHeaders()};return c.put(n,t,o)},get:function(e){var t=d.statistics._makeUrl(e),n={headers:d.statistics._makeHeaders()};return c.get(t,n)},delete:function(e,t){var n=d.statistics._makeUrl(e),o={headers:d.statistics._makeHeaders()};return c.delete(n,t,o)},_makeUrl:function(e){return r.get("statistics").host+e},_makeHeaders:function(){return{Authorization:"Bearer "+s.getToken()}}},this.sameOriginHapi=(e=this.hapi,_inherits(o,e),_createClass(o,null,[{key:"_getFullUrl",value:function(){return"/api"}}]),o),this.afterLogin=function(e){if(e.apps&&e.apps.length){var t=e.apps.find(function(e){return e.id==r.get("appId")});if(t)s.setToken(t.session);else{var n=e.institution||e.institutions[0];s.setToken(n.session),s.setLMS(n.id)}}else{var o=e.institution||e.institutions[0];s.setToken(o.session),s.setLMS(o.id)}s.setUserId(e.id),s.user=e;var i=u.get("lastfcmtoken");i&&d.pushSubscribe(i)},this.login=function(e){var n=this;return e.type="web",e.workspace=r.get("workspaceId"),e.app=r.get("appId"),this.hapi.post("/v1/reader/users/login",e,{withCredentials:!0}).then(function(e){var t=e.data;n.afterLogin(t)})},this.register=function(e){return this.hapi.post("/v1/reader/users/register",e).then(function(e){return e.data})},this.getUser=function(){return this.hapi.get("/v1/reader/users/"+s.getUserId()).then(function(e){return e.data})},this.resetPassword=function(e){return d.hapi.post("/v1/reader/users/lost",{email:e,app:r.get("appId"),lang:u.get("lang")})},this.getCloudFrontCookies=function(e){var t=e.api,n=e.token,o="ap"===t?"aptoken="+n:"meftoken="+n;return d.sameOriginHapi.get("/v1/reader/users/get-cloudfront-signed-cookies?"+o,{withCredentials:!0})},this.validateOneTimeReset=function(e,t){return d.hapi.post("/v1/reader/users/one-time-reset-validation",{userId:e,token:t})},this.confirmNewPassword=function(e,t,n){return d.hapi.post("/v1/reader/users/confirm-password",{userId:e,token:t,password:n})},this.get=function(e){return c.get(e)},this.ssoLogin=function(e){return d.get(r.get("hapiRho")+"/v1/reader/users/sso?aptoken="+e).then(function(e){return e.data})},this.getCorrectionSrc=function(e,t){return d.hapi._makeUrl("/ap/corrections/fullreport/"+e+"/"+t)},this.pushSubscribe=function(t){var n=this;if(s.getFCMToken()!==t&&!0!==this.pushSubscribing){this.pushSubscribing=!0;var e={fcmToken:t};return e.app=r.get("appId"),e.type="web",this.hapi.post("/ap/users/pushSubscribe",e).then(function(e){return s.setFCMToken(t),n.pushSubscribing=!1,e.data}).catch(function(){n.pushSubscribing=!1})}}}]),angular.module("commons").service("ColorAccessibility",function(){this.relativeLuminance=function(e){var t;/^#([A-Fa-f0-9]{3}){1,2}$/.test(e)&&(3==(t=e.substring(1).split("")).length&&(t=[t[0],t[0],t[1],t[1],t[2],t[2]]),e="rgba("+[(t="0x"+t.join(""))>>16&255,t>>8&255,255&t].join(",")+",1)"),e=(e=(e=e.replace("rgba(","")).replace("rgb(","")).replace(")","");var n=JSON.parse("["+e+"]"),o=n[0]/255,i=n[1]/255,r=n[2]/255;return.2126*(o<=.03928?o/12.92:Math.pow((.055+o)/1.055,2.4))+.7152*(i<=.03928?i/12.92:Math.pow((.055+i)/1.055,2.4))+.0722*(r<=.03928?r/12.92:Math.pow((.055+r)/1.055,2.4))}}),angular.module("commons").service("Config",["$q","ngDialog",function(t,n){var i=this;this.config={},this.load=function(){var e=t.defer();return this.config=window.config,e.resolve(this.config),e.promise},this.get=function(e){return i.config[e]},this.getAppId=function(){return i.get("appId")},this.hasFeature=function(e){var t=i.get("features");if(!t)return!1;var n=t[e];return!(!n||!0!==n.value)},this.isTermsAndConditionsDisabled=function(){var e=i.get("links");if(!e)return!0;var t=e.find(function(e){return"terms"===e.type});return t&&""===t.url},this.getExternalLinkVersion=function(t){var e=i.get("links");if(!e)return!1;var n=e.find(function(e){return e.type===t});return!!n&&n.version},this.getExternalLink=function(t){var e=i.get("links");if(!e)return!1;var n=e.find(function(e){return e.type===t});return!!n&&n.url},this.hasScreenSorter=function(e){var t=i.get("screens");return t[e]&&t[e].sorters},this.getScreenSorter=function(e){return i.get("screens")[e].sorters.list},this.getCurrentScreenSorter=function(e){return i.get("screens")[e].sorters.current},this.isSingleMode=function(){var e=i.get("screens").reader;return!(!e||!e.single)},this.openNewTab=function(){var e=i.get("screens").reader;return!!(e&&e.features&&e.features.external)},this.displayReaderLinks=function(){var e=i.get("screens").reader;return!!(e&&e.features&&e.features.displayLinks)},this.isMobile=function(e,t){var n=navigator.userAgent.match("iPad")||navigator.userAgent.match("iPhone")||navigator.userAgent.match("iPod"),o=navigator.userAgent.match("Android");return n||o?{androidLink:o?"https://play.google.com/store/apps/details?id="+e:"",customLink:o?"intent://gt/#Intent;scheme="+i.getAppId()+";package="+e+";end":""+i.getAppId(),iOSLink:n?"https://itunes.apple.com/app/apple-store/id"+t+"?mt=8":"",mobile:!0}:{isAndroid:"",isiOS:"",mobile:!1}},this.mobileCheckModal=function(e){n.open({template:"commons/templates/mobile-pop-up/mobile-pop-up.html",controllerAs:"$ctrl",appendClassName:"mobile-pop-up",showClose:!1,closeByEscape:!1,className:"ngdialog-theme-default",resolve:{isMobile:function(){return e}},controller:["isMobile","Config",function(e,t){this.isMobile=e,this.iosConfig=t.get("ios"),this.androidConfig=t.get("android")}]})},this.getCitationURL=function(){var e=i.get("features");return e&&e.citation?e.citation.url:""}}]),angular.module("commons").service("Cookies",function(){this.get=function(e){var t=!0,n=!1,o=void 0;try{for(var i,r=document.cookie.split("; ")[Symbol.iterator]();!(t=(i=r.next()).done);t=!0){var a=i.value.split("=");if(a[0]===e)return a[1]}}catch(e){n=!0,o=e}finally{try{!t&&r.return&&r.return()}finally{if(n)throw o}}return null}}),angular.module("commons").service("FirebaseService",["API","LocalStorage",function(t,n){var o=this;return this.firebase=null,this.publicKey=null,this.registration=null,this.initialize=function(e,t){o.firebase=window.firebase,o.publicKey=t,0===o.firebase.apps.length?(o.firebase.initializeApp(e),navigator.serviceWorker.register("firebase-messaging-sw.js?id="+e.messagingSenderId).then(function(e){return o.registration=e,o.firebase.messaging().useServiceWorker(e),navigator.serviceWorker.ready}).then(function(e){o.requestPermission()}).catch(function(e){})):n.get("lastfcmtoken")||o.requestPermission()},this.requestPermission=function(){o.firebase.messaging().usePublicVapidKey(o.publicKey),o.firebase.messaging().requestPermission().then(function(){return o.firebase.messaging().getToken().then(function(e){return e})}).then(function(e){n.set("lastfcmtoken",e),t.pushSubscribe(e)}).catch(function(e){console.log("FCM: ",e)}),o.firebase.messaging().onTokenRefresh(function(){o.firebase.messaging().getToken().then(function(e){n.set("lastfcmtoken",e),t.pushSubscribe(e)}).catch(function(e){console.log("FCM: ",e)})}),o.firebase.messaging().onMessage(function(e){o.showNotification(e)}),o.firebase.messaging().setBackgroundMessageHandler(function(e){o.showNotification(e)})},this.showNotification=function(e){var t=e.notification.title,n={body:e.notification.body,icon:e.notification.icon};return o.registration.showNotification(t,n)},this}]),angular.module("commons").service("LocalStorage",function(){this.set=function(e,t){localStorage.setItem(e,angular.toJson(t))},this.get=function(e){var t=localStorage.getItem(e);return t&&"undefined"!==t?"lang"===e?t:angular.fromJson(t):null},this.remove=function(e){localStorage.removeItem(e)},this.clear=function(){var e=localStorage.getItem("view"),t=localStorage.getItem("sort"),n=localStorage.getItem("lastfcmtoken"),o=localStorage.getItem("lang");localStorage.clear(),localStorage.setItem("view",e),localStorage.setItem("sort",t),localStorage.setItem("lastfcmtoken",n),localStorage.setItem("lang",o)}}),angular.module("commons").factory("MediaService",["API",function(t){var n={medias:[],selectedMedia:{},isPlaying:!1,getMediaStreaming:function(e){return t.hapi.get("/v1/reader/users/iubh/getmediasbycoursecode/en/"+e).then(function(e){return n.medias=e.data.media}).catch(function(e){return console.log(e),n.medias=[]})}};return n}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};angular.module("commons").service("ModuleService",["Config",function(i){var r=this;this.hasModule=function(e){r._modulesList=i.get("screens");var t=r._modulesList[e];return!(!t||!0!==t.enabled)},this.getModule=function(e){if(r.hasModule(e)){r._modulesList=i.get("screens");var t=r._modulesList[e],n=t.current||"generic",o=t.templates[n];return _extends(t,o)}}}]),angular.module("commons").service("PrintService",["SessionService",function(t){return this.getPrintTemplateUrl=function(e){return"api/v1/reader/print/"+e.app_id+"/"+e.project_id+"/"+e.book_content_id+"/"+e.book_version+"/"+e.fromPageId+"/to/"+e.toPageId+"?aptoken="+t.getToken()},this}]),angular.module("commons").service("ReadSpeakerService",["$location","$rootScope","Library",function(i,n,s){var o=this;this.voiceLang=null,this.displayMainPlay=function(e){n.ReadAloud.displayPlay=e},this.resetState=function(){n.ReadAloud={toolbar:null,main:null}},this.setState=function(e,t){n.ReadAloud={toolbar:e,main:t}},this.readSpeakerConf=function(e,t){var n=s.getBookByContentId(t),o=n.isPDF()?"#ffffff00":"#000000",i=n.isPDF()?"#2196f3":"#add8ff",r=document.createElement("script");r.type="text/javascript";var a="\n            window.rsConf = {\n                general: {\n                    usePost: true,\n                },\n                ui: {\n                    displayDownload: false,\n                    tools: {\n                        voicesettings: true\n                    }\n                },\n                settings: {\n                    hlicon: 'iconoff',\n                    hlspeed: 110,\n                    hltext: '"+o+"',\n                    hlsent: '#ffffff00',\n                    hlword: '"+i+"'\n                },\n                cb: {\n                    ui: {\n                        timeupdated: function (time, total) {\n                            var convertTime = function (time) {\n                                var splitedTime = time.split(':')\n                                var hour = Number(splitedTime[0])\n                                var minutes = Number(splitedTime[1])\n                                var seconds = Number(splitedTime[2])\n                                return (hour * 60 * 60) + (minutes * 60) + seconds\n                            }\n                            parent.postMessage({\n                                type:\"timeupdated\",\n                                params: {\n                                    percentage: convertTime(time) / convertTime(total) * 100\n                                }\n                            }, '*')\n                        },\n                        open: function () {\n                            console.log('hi');\n                        },\n                        play: function () {\n                            console.log('play');\n                        },\n                        pause: function () {\n                            console.log('pause');\n                        },\n                        stop: function () {\n                            parent.postMessage({\n                                type:\"stop\",\n                                params: {}\n                            }, '*')\n                            console.log('stop');\n                        }\n                    }\n                }\n            }";r.appendChild(document.createTextNode(a)),e.appendChild(r)},this.getSpeed=function(e){var t=document.createElement("script");t.type="text/javascript";t.appendChild(document.createTextNode("\n            ReadSpeaker.q(function() {\n                parent.postMessage({\n                    type: \"spechSpeed\",\n                    params: {\n                        spechSpeed: rspkr.st.get('hlspeed')\n                    }\n                }, '*')\n            });\n        ")),e.appendChild(t)},this.getLanguages=function(e){var t=document.createElement("script");t.type="text/javascript";t.appendChild(document.createTextNode("\n            rspkr.tools.load()\n            ReadSpeaker.q(function() {\n                parent.postMessage({\n                    type: \"langs\",\n                    params: {\n                        langs: rspkr.cfg.item('general.readingLangs')\n                    }\n                }, '*')\n            });\n        ")),e.appendChild(t)},this.readSpeakerCss=function(e){var t=document.createElement("style");t.type="text/css",t.rel="stylesheet";t.appendChild(document.createTextNode("\n            div#readspeaker_button1 {\n                display: none !important;\n            },\n            .sync_sent, .sync_word, .sync_word_highlighted, .sync_sent_highlighted {\n                font-size:inherit !important;\n                font-family:inherit !important;\n                color: inherit !important;\n            }\n        ")),e.appendChild(t)},this.readSpeakerEvents=function(e){var t=document.createElement("script");t.type="text/javascript";t.appendChild(document.createTextNode("\n            function createNewEvent(eventName) {\n                var event;\n                if (typeof Event === 'function') {\n                    event = new Event(eventName);\n                } else {\n                    event = document.createEvent('Event');\n                    event.initEvent(eventName, true, true);\n                }\n                return event;\n            }\n\n            window.addEventListener(\"message\", function receiveMessage(event)\n            {\n                if (event && event.data && event.data.type === 'play') {\n                    readpage();\n                }\n                if (event && event.data && event.data.type === 'pause-play') {\n                    rspkr.ui.getActivePlayer().play();\n                }\n                else if (event && event.data && event.data.type === 'pause'){\n                    rspkr.ui.getActivePlayer().pause();\n                }\n                else if (event && event.data && event.data.type === 'stop') {\n                    rspkr.ui.getActivePlayer().stop()\n                }\n                else if (event && event.data && event.data.type === 'close'){\n                    rspkr.ui.getActivePlayer().close();\n                }\n\n                if (event && event.data && event.data.type === 'skipBackwards') {\n                    rspkr.ui.getActivePlayer().rewind(5);\n                }\n\n                if (event && event.data && event.data.type === 'skipForwards') {\n                    rspkr.ui.getActivePlayer().forward(5);\n                }\n\n                if (event && event.data && event.data.type === 'changeSpeed') {\n                    rspkr.st.set('hlspeed', Number(event.data.params.speed))\n                }\n\n                if (event && event.data && event.data.type === 'changeLang') {\n                    rspkr.ui.Tools.VoiceSettings.switchLang(event.data.params.language.lang, event.data.params.language.name)\n                }\n\n            }, false);\n\n        ")),e.appendChild(t)},this.addReadSpeakerScript=function(e){var t=document.createElement("script");t.type="text/javascript",t.src="https://cdn1.readspeaker.com/script/10496/webReader/beta/ReadSpeaker.js?pids=wr",e.appendChild(t),t.onload=function(){o.getLanguages(e),o.getSpeed(e)}},this.addReadSpeakerButton=function(e,t){var n=document.createElement("div");n.id="readspeaker_button1",n.className="rs_skip rsbtn rs_preserve";var o='\n            <a\n                class="rsbtn_play"\n                accesskey="L"\n                title="Read the page"\n                href="//app-na.readspeaker.com/cgi-bin/rsent?customerid=10496&amp;lang=en_us&amp;readclass='+(t.document.getElementsByClassName("textLayer").length?"textLayer":t.document.body.firstElementChild.className)+"&amp;url="+encodeURIComponent(i.absUrl())+'"\n            >\n                <span class="rsbtn_left rsimg rspart">\n                    <span class="rsbtn_text">\n                        <span>Listen</span>\n                    </span>\n                </span>\n                <span class="rsbtn_right rsimg rsplay rspart"></span>\n            </a>\n        ';n.innerHTML=o,e.appendChild(n)}}]),angular.module("commons").service("SearchService",["API","StatisticsService","Library",function(a,s,u){var l=this;this.results=[],this.query="",this.isLoading=!1,this.annotationsLength=0,this.search=function(e,t,n,o){if(l.query=n,l.query&&l.query.length){var i=u.getBookByContentId(e),r=i.getIndexOfPage(o);return-1===r&&(r=0),l.isLoading=!0,s.searchEvent({pageId:o,bookId:i.project_id||i.id,bookISBN:i.isbn,pageIndex:r,value:n}),a.hapi.post("/v1/search/"+e+"/"+t,{query:l.query}).then(function(e){l.isLoading=!1,l.results=e.data}).catch(function(e){console.log(e),l.isLoading=!1,l.results=[]})}},this.markSearch=function(e,t){if(!e||!t)return"";e=decodeURI(e).split(/\s\s+/g).join(" ");for(var n=RegExp("("+t+")(?![^<]*>|[^<>]*</)","gi"),o=n.exec(e);o;)e=e.split(o[0]).join("<mark>"+o[0]+"</mark>"),o=n.exec(e);return e};function o(e,t){return!!e&&decodeURI(e).toLowerCase().split(/\s\s+/g).join(" ").includes(t.toLowerCase())}return this.searchLocalAnnotations=function(e,t){if(!e||!e.length||!t)return[];var n=e.filter(function(e){return o(e.options.selectedText,t)||o(e.pageTitle,t)&&"bookmark"===e.type||o(e.options.noteText,t)});return l.annotationsLength=n.length,n},this.clearSearch=function(){l.annotationsLength=0,l.results=[],l.query="",l.isLoading=!1},this.numberOfResults=function(){return l.results.reduce(function(e,t){return e+t.totalOccurrences},0)},this}]),angular.module("commons").service("SessionService",["$q","LocalStorage","Config","ModuleService",function(t,n,e,o){var i=this;this.user=null,this.readerMode="UNAUTHORIZED",this.setToken=function(e){i.readerMode="EDIT",n.remove("meftoken"),n.remove("workspaceId"),n.set("aptoken",e)},this.getToken=function(){return n.get("aptoken")},this.setMEFToken=function(e,t){i.readerMode="PREVIEW",n.remove("aptoken"),n.set("meftoken",e),n.set("workspaceId",t)},this.getMEFToken=function(){return n.get("meftoken")},this.getFCMToken=function(){return n.get("fcmtoken")},this.setFCMToken=function(e){n.set("fcmtoken",e)},this.isLogged=function(){var e=t.defer();return n.get("aptoken")?e.resolve():e.reject(),e.promise},this.logOut=function(){n.clear()},this.setUserId=function(e){n.set("userId",e)},this.getUserId=function(){return n.get("userId")},this.setUser=function(e){n.set("user",e)},this.setSingleModeConfig=function(e){n.set("singleModeConfig",e)},this.getSingleModeConfig=function(){return n.get("singleModeConfig")},this.setDisplayMobileWarning=function(e){n.set("displayMobileWarning",e)},this.getDisplayMobileWarning=function(){return n.get("displayMobileWarning")},this.getUser=function(){return this.user},this.setLMS=function(e){n.set("isFromLMS",e)},this.getLMS=function(){return n.get("isFromLMS",!1)},this.goToShelf=function(){return!o.hasModule("shelf")&&o.hasModule("assignments")?"app.assignments.all":"app.library.all"},this.setReaderMode=function(e){i.readerMode=e},this.mobileCheck=function(){var e=navigator.userAgent.match("iPad")||navigator.userAgent.match("iPhone")||navigator.userAgent.match("iPod"),t=navigator.userAgent.match("Android");return e||t};var r=this.getToken();this.getMEFToken()?this.readerMode="PREVIEW":r&&(this.readerMode="EDIT")}]),angular.module("commons").service("SettingService",function(){return this.data={accessibility:{fontSize:20,font:""},fonts:[],"font-sizes":[],contrasts:[]},this.data});_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").service("StatisticsService",["$q","API","SessionService","Config","StatisticsEvent",function(h,f,m,r,v){function e(){_classCallCheck(this,e)}return new(_createClass(e,[{key:"_getContext",value:function(e,t,n){var o={app_id:r.get("appId"),project_id:e};if(t&&(o.institution_id=t.id),n){if(!t)return;o.project_id=null,o.assignment_id=n.id,o.assignment_type=n.type;var i=[];n.groups.length&&(i=n.groups.filter(function(e){return-1<t.groups.indexOf(e)})),i.length&&(o.groups_ids=i)}else t&&t.groups.length;return o}},{key:"startPageViewed",value:function(e){var t=e.pageId,n=e.bookId,o=e.assignment,i=e.additionalInfo,r=(new Date).toISOString(),a=m.getUser(),s=a.institutions.find(function(e){return e.id==m.getLMS()});if(["UNAUTHORIZED","PREVIEW"].includes(m.readerMode))return h.resolve(null);var u={started:r,ended:r,duration:0},l={type:"page",id:t},c=this._getContext(n,s,o);i&&(c.additional_info=i);var d=new v({type:"viewed",result:u,object:l,context:c,user:a});return f.hapi.post("/v1/reader/statistics/events",d.toObject()).then(function(){return d})}},{key:"endPageViewed",value:function(e){return["UNAUTHORIZED","PREVIEW"].includes(m.readerMode)?h.resolve(null):(e.end(),f.hapi.post("/v1/reader/statistics/events",e.toObject()).then(function(){return e}))}},{key:"exerciseGraded",value:function(e){var t=e.exoData,n=e.pageId,o=e.bookId,i=e.assignment,r=e.metas,a=e.loId,s=m.getUser(),u=s.institutions.find(function(e){return e.id==m.getLMS()});if(["UNAUTHORIZED","PREVIEW"].includes(m.readerMode))return h.resolve(null);var l=_extends({},t),c={type:"page",id:n},d=this._getContext(o,u,i),g=new v({type:"graded",result:l,object:c,context:d,user:s,metas:r}),p=[f.hapi.post("/v1/reader/statistics/events",g.toObject())];return i&&p.push(f.hapi.post("/ap/corrections/answer",{answers:JSON.stringify(t),assignment_id:i.id,LO_id:a})),h.all(p).then(function(){return g})}},{key:"getNbPagesRead",value:function(e){var t=m.getUserId();return r.get("statistics").enabled?f.hapi.get("/v1/reader/statistics/events/pages_read?assignment_id="+e+"&user_id="+t).then(function(e){return e.data.pages_read?e.data.pages_read:0}):h.resolve(0)}},{key:"getUserStatistics",value:function(){var c=this,e=m.getUserId();return r.get("statistics").enabled?f.hapi.get("/v1/learners/"+e+"/statistics").then(function(e){c.userStats=e.data;var t=c.userStats.statistics.all.time_spent,n=Math.trunc(t/6e4),o=Math.round(t%6e4/1e3);c.userStats.statistics.all.time_spent_formatted=0<n?n+"min "+o+"s":o+"s",c.userStats.all=[];for(var i=0;i<c.userStats.books.length;i++)c.userStats.all.push(c.userStats.books[i]);for(var r=0;r<c.userStats.assignments.length;r++)c.userStats.all.push(c.userStats.assignments[r]);for(var a=0;a<c.userStats.all.length;a++){var s=c.userStats.all[a].statistics.time_spent,u=Math.trunc(s/6e4),l=Math.round(s%6e4/1e3);0<Math.trunc(s/6e4)?c.userStats.all[a].statistics.time_spent_formatted=u+"min "+l+"s":c.userStats.all[a].statistics.time_spent_formatted=l+"s"}return c.userStats}):(console.log("Statistics are not enabled"),h.resolve({all:[],books:[],assignments:[]}))}},{key:"loginEvent",value:function(){var e=m.getUser(),t=this._getContext();if(["UNAUTHORIZED","PREVIEW"].includes(m.readerMode))return h.resolve(null);var n=new v({type:"login",result:{},object:{},context:t,user:e,metas:{value:[]}});return f.hapi.post("/v1/reader/statistics/events",n.toObject()).then(function(){return n})}},{key:"loginSSOEvent",value:function(e,t){var n=m.getUser(),o=this._getContext();if(["UNAUTHORIZED","PREVIEW"].includes(m.readerMode))return h.resolve(null);o.sso_type=e,t&&(o.additional_info={eISBN:t});var i=new v({type:"launch",result:{},object:{},context:o,user:n,metas:{value:[]}});return f.hapi.post("/v1/reader/statistics/events",i.toObject()).then(function(){return i})}},{key:"userInputsEvent",value:function(e){var t=e.type,n=e.action,o=e.pageId,i=e.bookId,r=e.bookISBN,a=e.pageIndex,s=m.getUser(),u=this._getContext(i);if(["UNAUTHORIZED","PREVIEW"].includes(m.readerMode))return h.resolve(null);var l={type:t,id:u.page_id=o};r&&(u.additional_info={page_index:a,eISBN:r});var c=new v({type:t,result:{},object:l,context:u,user:s,metas:{value:[]}});return(c=c.toObject()).verb.action=n,f.hapi.post("/v1/reader/statistics/events",c).then(function(){return c})}},{key:"searchEvent",value:function(e){var t=e.pageId,n=e.bookId,o=e.bookISBN,i=e.pageIndex,r=e.value,a=m.getUser(),s=this._getContext(n);if(["UNAUTHORIZED","PREVIEW"].includes(m.readerMode))return h.resolve(null);s.page_id=t;var u={type:"search_term",value:r};o&&(s.additional_info={page_index:i,eISBN:o});var l=new v({type:"search",result:{},object:u,context:s,user:a,metas:{value:[]}});return f.hapi.post("/v1/reader/statistics/events",l.toObject()).then(function(){return l})}},{key:"readAloudEvent",value:function(e){var t=e.pageId,n=e.bookId,o=e.bookISBN,i=e.pageIndex,r=e.value,a=m.getUser(),s=this._getContext(n);if(!["UNAUTHORIZED","PREVIEW"].includes(m.readerMode)){s.page_id=t;var u={type:"action",value:r};o&&(s.additional_info={page_index:i,eISBN:o},-1==s.additional_info.page_index&&(s.additional_info.page_index=0));var l=new v({type:"listen",result:{},object:u,context:s,user:a,metas:{value:[]}});return f.hapi.post("/v1/reader/statistics/events",l.toObject()).then(function(e){return e.data})}}},{key:"printEvent",value:function(e){var t=e.pageId,n=e.bookId,o=e.bookISBN,i=e.value,r=e.print,a=m.getUser(),s=this._getContext(n);if(!["UNAUTHORIZED","PREVIEW"].includes(m.readerMode)){s.page_id=t;var u={type:"total_print_pages",value:i.toString()};o&&(s.additional_info={print:r,eISBN:o});var l=new v({type:"print",result:{},object:u,context:s,user:a,metas:{value:[]}});return f.hapi.post("/v1/reader/statistics/events",l.toObject()).then(function(e){return e.data})}}},{key:"printAnnotationsEvent",value:function(e){var t=e.bookId,n=e.bookISBN,o=m.getUser(),i=this._getContext(t);if(!["UNAUTHORIZED","PREVIEW"].includes(m.readerMode)){n&&(i.additional_info={eISBN:n});var r=new v({type:"print-annotations",result:{},object:{},context:i,user:o,metas:{value:[]}});return f.hapi.post("/v1/reader/statistics/events",r.toObject()).then(function(e){return e.data})}}}]),e)}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(i,r){function a(e,t){try{var n=s[e](t),o=n.value}catch(e){return void r(e)}if(!n.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});i(o)}return a("next")})}}angular.module("commons").service("SyncService",["API","LocalStorage","Library","StatisticsService","Config","Entity","SessionService","Assignment",function(o,c,s,r,d,i,g,n){var t,p=this;this._cache=[],this._booksCache={},this._currentDataModelVersion=2,this._push=function(e){e.forEach(function(t){var e=p._syncData.userInputs.find(function(e){return e.id===t.id&&e.sharingId===t.sharingId});e?e=_extends(e,t):p._syncData.userInputs.push(t)}),p._updateCache()},this.computeId=function(e){var t=c.get("userId"),n=d.getAppId()+t+e.id;return"hash"+i.hashCode(n)},this.computeExerciseId=function(e){var t=c.get("userId"),n=d.getAppId()+t+(e.sharingId||e.path)+e.pageId+e.fid+e.id;return"hash"+i.hashCode(n)},this._migrateDataModelToVersion2=function(e){var i=[],a=c.get("userId"),s=d.getAppId();if(!a)return i;var r=[];return e.docs&&(r=e.docs.filter(function(e){return"highlight"===e.type}),e.docs.forEach(function(t){var e=void 0;switch(t.type){case"bookmark":(e=function(e){if(!e.sharingId)return null;var t={id:e.pageId};return{id:p.computeId(t),$created_at:e.userDate,$updated_at:e.userDat,userId:a,appId:s,deleted:!1,contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId,type:e.type,userDate:e.userDate,options:{enabled:Boolean(!e.deleted)}}}(t))&&i.push(e);break;case"note":var n=r.findIndex(function(e){return e.id===t.highlight.$ref});if(-1!==n){var o=r[n];(e=function(e,t){if(!(e.sharingId&&t&&t.serialization&&"string"==typeof t.serialization&&t.serialization.length))return null;var n=p.computeId(e),o="",i="";try{var r=JSON.parse(t.serialization);o=r.color&&r.color.length?r.color:"#FFEB6B",r.id=n,i=JSON.stringify(r)}catch(e){return null}return{id:n,$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId,type:e.type,userDate:e.userDate,options:{color:o,selectedText:t.content,noteText:e.text,serializedData:i,highlightId:t.id}}}(t,o))&&i.push(e),r.splice(n,1)}break;case"exercise":case"quizz2":(e=function(e){if(!e.sharingId)return null;var t=e.questions;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return null}var n={id:p.computeExerciseId(e),$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId||null,type:"exercise",userDate:e.userDate,options:{scorePerc:e.scorePerc||e.score,scoreType:e.score_type||"percent",questions:t,currentQuestion:e.currentQuestion,submitted:Boolean(e.submitted),score:e.score,exerciseId:e.fid}};return e.nbQuestions&&(n.options.nbQuestions=e.nbQuestions),n}(t))&&i.push(e)}})),r.forEach(function(e){var t=function(e){if(!e.sharingId||!e.serialization||"string"!=typeof e.serialization||!e.serialization.length)return null;var t=p.computeId(e),n="",o="";try{var i=JSON.parse(e.serialization);n=i.color&&i.color.length?i.color:"#FFEB6B",i.id=t,o=JSON.stringify(i)}catch(e){return null}return{id:t,$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId,type:e.type,userDate:e.userDate,options:{color:n,selectedText:e.content,serializedData:o}}}(e);t&&i.push(t)}),i},this._migrateDataModel=function(){var e=c.get("sync");if(e&&!e.version){var t=p._migrateDataModelToVersion2(e),n={version:2,syncTimestamp:e.lastsyncdate||0,userInputs:t};c.set("sync",n)}},this.load=function(){p._cache=[],p._booksCache={},p._migrateDataModel();var e=c.get("sync"),t="",n=d.getAppId();return p._syncData={userInputs:[],syncTimestamp:0},e&&(t="&syncTimestamp="+e.syncTimestamp,p._syncData=e,p._updateCache()),o.hapi.get("/v2/reader/sync?appId="+n+t).then(function(e){return p._syncData||(p._syncData={version:p._currentDataModelVersion,syncTimestamp:0,userInputs:[]}),p._syncData.syncTimestamp=e.data.syncTimestamp,p._push(e.data.userInputs),p._syncData}).catch(function(){p._syncData={version:p._currentDataModelVersion,syncTimestamp:0,userInputs:[]}})},this._updateCache=function(){p._cache=p._get(),p._booksCache={},c.set("sync",p._syncData)},this.get=function(){return p._cache},this._get=function(){return p._syncData.userInputs=p._syncData.userInputs.filter(function(e){return!e.deleted}),p._syncData.userInputs.filter(function(e){return s.getBookOrAssignmentBySharingId(e.sharingId)})},this.getSyncDataByContext=function(e){var t=e.book,n=e.assignment,o=e.array,i=void 0;if(n)i=n;else{var r=s.getBookByContentId(t);if(!r)throw Error("No book provided");i=r.getSharingId()}var a=p._getSyncData(t,i);return o?a:{notes:a.filter(function(e){return"note"===e.type}),highlights:a.filter(function(e){return"highlight"===e.type}),bookmarks:a.filter(function(e){return"bookmark"===e.type}),exercises:a.filter(function(e){return"exercise"===e.type})}},this._getSyncData=function(e,t){return p._booksCache[e+t]||(p._booksCache[e+t]=p.get().filter(function(e){return e.sharingId==t}))},this.getUserInputsByContext=function(e){var t=e.book,n=e.assignment,o=void 0;if(n)o=n;else{var i=s.getBookByContentId(t);if(!i)throw Error("No book provided");o=i.getSharingId()}return p._getUserInputs(t,o)},this._getUserInputs=function(e,t){var n="ui_"+e+t;return p._booksCache[n]?p._booksCache[n]:p._booksCache[n]=p.get().filter(function(e){return e.sharingId==t&&("note"===e.type||"highlight"===e.type||"bookmark"===e.type)})},this.getNdAnnotations=function(){return p.get().filter(function(e){if("exercise"===e.type)return!1;var t=s.getBookOrAssignmentBySharingId(e.sharingId);if(t instanceof n){if(t.book_id&&!s.getBookByBookId(t.book_id).getPage(e.pageId))return!0;if(t.module_id&&!s.getBookByBookId(t.module_id).getPage(e.pageId))return!0}else if(!t.getPage(e.pageId))return!0;return!1})},this.getUpdatedNdAnnotation=function(){return p.getNdAnnotations().filter(function(e){return!e.options.broken_status})},this.updateNdAnnotationsStatus=function(t){if("PREVIEW"!=g.readerMode){var e=p.getNdAnnotations();e.forEach(function(e){(t||e.options.broken_status)&&(!t||"viewed"===!e.options.broken_status&&e.options.broken_status)||(e.options.broken_status=t)}),p.push(e)}},this.getNotViewedAnnotation=function(){return p.getNdAnnotations().filter(function(e){return!e.options.broken_status||"viewed"!==e.options.broken_status})},this.getByPageId=function(t,n){return p._syncData.userInputs.find(function(e){return e.pageId===t&&e.type===n})},this.getById=function(t){return p._syncData.userInputs.find(function(e){return e.id===t})},this.getExercise=function(t,n){return p._syncData.userInputs.find(function(e){return"exercise"===e.type&&e.options.exerciseId===t&&e.sharingId==n})},this.delete=(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=p.getById(t)){e.next=3;break}return e.abrupt("return");case 3:return n.deleted=!0,e.next=6,p.push([n]);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}},e,p)})),function(e){return t.apply(this,arguments)}),this.deleteExercise=function(e,t){var n=p.getExercise(e,t);if(n)return n.deleted=!0,p.prepareExerciseForSync(n),p.push([n])},this.push=function(e){return o.hapi.post("/v2/reader/sync",{appId:d.getAppId(),syncTimestamp:p._syncData.syncTimestamp,userInputs:e}).then(function(e){var t=e.data;return p._syncData.syncTimestamp=t.syncTimestamp,p.sendUserInputEvent(t.userInputs),p._push(t.userInputs),t}).catch(function(){return null})},this.sendUserInputEvent=function(e){e.forEach(function(e){if(["highlight","bookmark","note"].includes(e.type)){var t=p.getById(e.id),n="create",o=s.getBookOrAssignmentBySharingId(e.sharingId),i=o.getIndexOfPage(e.pageId);t&&e.deleted&&(n="delete"),t&&!e.deleted&&(n="update"),r.userInputsEvent({type:e.type,action:n,pageId:e.pageId,bookId:o.id,bookISBN:o.isbn,pageIndex:i})}})},this.toggleBookmark=function(e){if("PREVIEW"!=g.readerMode){var t=d.getAppId(),n=c.get("userId"),o=p.getByPageId(e.pageId,"bookmark");if(null==o){var i={id:e.pageId};o=_extends(e,{id:p.computeId(i),type:"bookmark",appId:t,userId:n,deleted:!1,pageId:e.pageId,pageTitle:e.pageTitle,contentVersion:e.contentVersion,userDate:Date.now(),version:p._currentDataModelVersion,options:{enabled:!0}})}else o.options.enabled=!o.options.enabled,o.deleted=!0;return e.sharingId&&(o.sharingId=e.sharingId),p.push([o])}},this.getBookmarks=function(){return p._syncData.userInputs.filter(function(e){return"bookmark"===e.type&&s.getBookOrAssignmentBySharingId(e.sharingId)})},this.isBookmarked=function(t,n){if("PREVIEW"!=g.readerMode)return p.getBookmarks().find(function(e){return e.pageId===t&&e.sharingId===n&&!0===e.options.enabled})},this.addHighlight=function(e,t){if("PREVIEW"!=g.readerMode){var n=Date.now(),o=d.getAppId(),i=c.get("userId"),r={id:e.id,appId:o,userId:i,deleted:!1,pageId:t,pageTitle:e.pageTitle,contentVersion:e.contentVersion,type:"highlight",userDate:n,version:p._currentDataModelVersion,options:{color:e.color,selectedText:e.text,serializedData:JSON.stringify(e)}},a=p.getById(e.id);return a&&(r.$created_at=a.$created_at),e.sharingId&&(r.sharingId=e.sharingId),p.push([r])}},this.getHighlights=function(){return p.get().filter(function(e){return"highlight"===e.type&&s.getBookOrAssignmentBySharingId(e.sharingId)})},this.addNote=function(e,t,n){if("PREVIEW"!=g.readerMode){var o=Date.now(),i=d.getAppId(),r=c.get("userId"),a={id:e.id,appId:i,userId:r,deleted:!1,pageId:t,pageTitle:e.pageTitle,type:"note",contentVersion:e.contentVersion,userDate:o,version:p._currentDataModelVersion,options:{color:e.color,selectedText:e.text,serializedData:JSON.stringify(e),noteText:n}},s=p.getById(e.id);if(s&&(a.$created_at=s.$created_at),e.sharingId&&(a.sharingId=e.sharingId),!0!==e.noteFromHighlight)return p.push([a]);var u=_extends({},a);u.deleted=!0,delete u.options,delete u.type;var l=_extends({},e);return e.id.contains("-fromhighlight")?l.id=e.id:l.id=e.id+"-fromhighlight",a.id=l.id,a.options.highlightId=e.id,a.options.serializedData=JSON.stringify(l),p.push([u,a])}},this.getNotes=function(){return p._syncData.userInputs.filter(function(e){return"note"===e.type&&s.getBookOrAssignmentBySharingId(e.sharingId)})},this.addExercise=function(e,t){if("PREVIEW"!=g.readerMode){var n=d.getAppId(),o=c.get("userId"),i=e.id;if(!i){var r={sharingId:e.sharingId,pageId:t,id:e.fid,fid:e.fid};i=p.computeExerciseId(r)}var a={id:i,userId:o,appId:n,deleted:!1,pageId:t,pageTitle:e.pageTitle,type:"exercise",contentVersion:e.contentVersion,userDate:Date.now(),version:p._currentDataModelVersion,options:{questions:"string"==typeof e.questions?e.questions:JSON.stringify(e.questions),currentQuestion:e.currentQuestion,nbQuestions:e.nbQuestions,submitted:e.submitted,score_type:e.score_type,score:e.score,scorePerc:e.scorePerc,exerciseId:e.fid}},s=p.getById(e.id);return s&&(a.$created_at=s.$created_at),e.sharingId&&(a.sharingId=e.sharingId),p.prepareExerciseForSync(a),p.push([a])}},this.prepareExerciseForInjection=function(e){"string"==typeof e.options.questions?e.questions=JSON.parse(e.options.questions):e.questions=e.options.questions,e.currentQuestion=e.options.currentQuestion,e.nbQuestions=e.options.nbQuestions,e.submitted=e.options.submitted,e.score_type=e.options.score_type,e.score=e.options.score,e.scorePerc=e.options.scorePerc},this.prepareExerciseForSync=function(e){e.questions&&delete e.questions,!e.currentQuestion&&0!==e.currentQuestion||delete e.currentQuestion,!e.nbQuestions&&0!==e.nbQuestions||delete e.nbQuestions,!e.submitted&&0!=e.submitted||delete e.submitted,e.score_type&&delete e.score_type,!e.score&&0!==e.score||delete e.score,!e.scorePerc&&0!==e.scorePerc||delete e.scorePerc}}]),angular.module("commons").service("UserService",["$q","LocalStorage","Config","API","$state","ngDialog","SessionService",function(e,t,s,u,l,c,d){var g=this;this.isCheckingTermsAndConditions=!1,this.checkTermsAndConditions=function(e){if((!s.get("features")||!s.get("features").termsValidationMandatory||!1!==s.get("features").termsValidationMandatory.value)&&(g.isCheckingTermsAndConditions||!s.isTermsAndConditionsDisabled())){var t=s.getExternalLink("terms");if(e&&!g.isCheckingTermsAndConditions&&t){var n=s.getExternalLinkVersion("terms");g.isCheckingTermsAndConditions=!0;var o=null;if(e.apps&&0<e.apps.length){var i=e.apps.find(function(e){return e.id===s.get("appId")});i&&i.conditions&&(o=i.conditions.filter(function(e){return"terms"===e.type}))}if((!o||!o.length)&&e.institutions&&0<e.institutions.length){var r=e.institutions.find(function(e){return e.id===d.getLMS()});r&&r.conditions&&(o=r.conditions.filter(function(e){return"terms"===e.type}))}var a=o&&o.length?o[0]:null;!a||a.current.version<n?c.openConfirm({showClose:!1,closeByDocument:!1,closeByEscape:!1,width:"50%",height:"80%",appendClassName:"ngdialog-terms-conditions",data:{terms_url:t},controllerAs:"$ctrl",template:"app/settings/condition-settings/condition-settings.html",controller:["$scope","$sce",function(e,t){this.terms_url=e.ngDialogData.terms_url,this.trustSrc=function(){return t.trustAsResourceUrl(this.terms_url)}}]}).then(function(){return g.isCheckingTermsAndConditions=!1,u.hapi.patch("/v1/reader/users/terms",{type:"terms",url:t,version:n})}).catch(function(){d.logOut(),l.go("auth.login"),g.isCheckingTermsAndConditions=!1}):g.isCheckingTermsAndConditions=!1}}},this.resendActivationCode=function(e,t,n,o){var i={email:n,app_id:t,workspace_id:e,lang:o};return u.hapi.post("/ap/users/resendActivationCode",i)},this.showResendValidationEmail=function(e,t,n,o){var i=!(4<arguments.length&&void 0!==arguments[4])||arguments[4],r=g;c.openConfirm({template:"auth/dialogs/resend-invitation.html",showClose:!1,appendClassName:"directive-modal-common",closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"30%",data:{userEmail:n,userAppId:t,userWorkspaceId:e,userLang:o,hasResendAction:i,parent:r},controllerAs:"$ctrl",controller:["$scope",function(e){var t=this;this.email=e.ngDialogData.userEmail,this.appId=e.ngDialogData.userAppId,this.workspaceId=e.ngDialogData.userWorkspaceId,this.lang=e.ngDialogData.userLang,this.hasResendAction=e.ngDialogData.hasResendAction,this.parent=e.ngDialogData.parent,this.resendInvitation=function(){t.parent.resendActivationCode(t.workspaceId,t.appId,t.email,t.lang).then(function(){c.close(),c.openConfirm({width:"20%",template:"auth/dialogs/email-sent.html",showClose:!1})}).catch(function(e){console.log("Error on resendActivationCode: ",e)})},this.confirm=function(){c.close()}}]}).catch(function(){})},this.showConfirmationRegistering=function(e){c.openConfirm({template:"auth/dialogs/register-confirmation.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"30%",data:{userEmail:e},controllerAs:"$ctrl",controller:["$scope",function(e){this.email=e.ngDialogData.userEmail,this.confirm=function(){c.close()}}]}).catch(function(){})}}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(i,r){function a(e,t){try{var n=s[e](t),o=n.value}catch(e){return void r(e)}if(!n.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});i(o)}return a("next")})}}angular.module("commons").service("UsersContentsInfos",["API","LocalStorage","Config","Entity","SessionService",function(n,o,i,r,a){var t,s=this,u="contentsInfos",l="/v1/reader/usersContentsInfos/sync";this.DEFAULT_ALT_MEDIA_ENABLED=!1,this.DEFAULT_TTS_VOLUME=.5,this.DEFAULT_TTS_SPEED=.5,this.DEFAULT_FONT_NAME="",this._currentDataModelVersion=1,this._syncData={version:this._currentDataModelVersion,syncTimestamp:0,userContentsInfos:[]},this._updateCache=function(){o.set(u,s._syncData)},this._push=function(e){e.forEach(function(t){var e=s._syncData.userContentsInfos.find(function(e){return e.id===t.id&&e.sharingId===t.sharingId});e?e=_extends(e,t):s._syncData.userContentsInfos.push(t)}),s._updateCache()},this._buildNewContentsInfos=function(e){var t=i.getAppId(),n=o.get("userId");return{id:s.generateID(t+n+e),userId:n,appId:t,sharingId:e,version:s._currentDataModelVersion,deleted:!1,options:{}}},this.load=function(){var e=o.get(u),t=i.getAppId();return e&&(s._syncData=e,s._updateCache()),n.hapi.post(l,{appId:t,syncTimestamp:s._syncData.syncTimestamp||0,userContentsInfos:[]}).then(function(e){return s._syncData.syncTimestamp=e.data.syncTimestamp,s._push(e.data.userContentsInfos),s._syncData})},this.generateID=function(e,t,n){return"hash"+r.hashCode(e+t+n)},this.getBySharingId=function(t){return s._syncData.userContentsInfos.find(function(e){return e.sharingId===t})},this.delete=(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=s.getBySharingId(t)){e.next=3;break}return e.abrupt("return");case 3:return n.deleted=!0,e.next=6,s.push([n]);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}},e,s)})),function(e){return t.apply(this,arguments)}),this.push=function(e){return n.hapi.post(l,{appId:i.getAppId(),syncTimestamp:s._syncData.syncTimestamp||0,userContentsInfos:e}).then(function(e){var t=e.data;return s._syncData.syncTimestamp=t.syncTimestamp,s._push(t.userContentsInfos),t})},this.toggleFavourite=function(e){if("PREVIEW"!=a.readerMode){var t=s.getBySharingId(e);return null==t?(t=s._buildNewContentsInfos(e)).options.favorite=!0:t.options.favorite=!t.options.favorite,s.push([t])}},this.isFavourite=function(e){if("PREVIEW"!=a.readerMode){var t=s.getBySharingId(e);return null!=t&&!1===t.deleted&&!0===t.options.favorite}},this.updateLastOpening=function(e,t){if("PREVIEW"!=a.readerMode){var n=s.getBySharingId(e);return null==n&&(n=s._buildNewContentsInfos(e)),n.options.lastOpen=t,s.push([n])}},this.updateAccessibilityTTS=function(e,t){if("PREVIEW"!=a.readerMode){var n=s.getBySharingId(e);return null==n&&(n=s._buildNewContentsInfos(e)),n.options.accessibility||(n.options.accessibility={}),null!=t.altMediaEnabled?n.options.accessibility.altMediaEnabled=t.altMediaEnabled:n.options.accessibility.altMediaEnabled=s.DEFAULT_ALT_MEDIA_ENABLED,null!=t.soundPower&&null!=t.soundPower&&0<=t.soundPower?n.options.accessibility.soundPower=t.soundPower:n.options.accessibility.soundPower=s.DEFAULT_TTS_VOLUME,null!=t.speechRate&&null!=t.speechRate&&0<=t.speechRate?n.options.accessibility.speechRate=t.speechRate:n.options.accessibility.speechRate=s.DEFAULT_TTS_SPEED,s.push([n])}},this.updateAccessibilityFont=function(e,t){if("PREVIEW"!=a.readerMode){var n=s.getBySharingId(e);return null==n&&(n=s._buildNewContentsInfos(e)),n.options.accessibility||(n.options.accessibility={}),n.options.accessibility.fontName=t.fontName||s.DEFAULT_FONT_NAME,s.push([n])}}}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};angular.module("commons").service("UsersPreferences",["API","LocalStorage","Library","Config","Entity",function(n,a,e,s,o){var u=this,i="preferences",r="/v1/reader/usersPreferences";this.KEY_DESK_BOOK_SORTER="deskBookSorter",this.KEY_DESK_ASSIGNMENT_SORTER="deskAssignmentSorter",this.KEY_USER_LANGUAGE="language",this._currentDataModelVersion=1,this._cache=[],this._syncData={userPreferences:[]},this._updateCache=function(){u._cache=u._get(),a.set(i,u._syncData)},this._push=function(e){e.forEach(function(t){var e=u._syncData.userPreferences.find(function(e){return e.id===t.id});e?e=_extends(e,t):u._syncData.userPreferences.push(t)}),u._updateCache()},this._get=function(){return u._syncData.userPreferences},this.load=function(){var e=a.get(i),t=s.getAppId();return e&&(u._syncData=e,u._updateCache()),n.hapi.get(r+"?appId="+t).then(function(e){return u._push(e.data),u._syncData})},this.generateID=function(e,t,n){return o.hashCode(e+t+n)},this.get=function(){return u._cache},this.getById=function(t){return u._syncData.userPreferences.find(function(e){return e.id===t})},this._insert=function(e){return n.hapi.post(r,e).then(function(e){var t=e.data;return u._push([t]),t})},this._update=function(e){return n.hapi.put(r,e).then(function(e){var t=e.data;return u._push([t]),t})},this.set=function(e,t){var n=a.get("userId"),o=s.getAppId(),i=u.generateID(o,n,e),r=u.getById(i);return r?(r.value=t,u._update(r)):(r={id:i,userId:n,appId:o,version:u._currentDataModelVersion,key:e,value:t},u._insert(r))},this.get=function(e){var t=a.get("userId"),n=s.getAppId(),o=u.generateID(n,t,e);return u.getById(o)}}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").service("Iframe",["SettingService","IframeInterface","SyncService","SessionService","$state","Library","Config","Entity","LocalStorage","UsersContentsInfos","$translate","ReadSpeakerService",function(t,e,i,v,b,y,_,r,s,k,I,S){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.iframe=null,e.tools=null,e.showToolbar=!1,e.sharingId=null,e.contentsInfos=null,e.init=e.init.bind(e),e.onFrameLoad=e.onFrameLoad.bind(e),e.setFontSize=e.setFontSize.bind(e),e.setFont=e.setFont.bind(e),e.PDFScale=1.25,e.EpubFixedWidth=60,e.EpubReflowWidth=1,e.activateAltTextMedia=e.activateAltTextMedia.bind(e),e.testAudioForAltText=e.testAudioForAltText.bind(e),e}return new(_inherits(n,e),_createClass(n,[{key:"init",value:function(e,t){this.listeners=new Map,this.setSelectedText=null,this.setSelectedHighlight=null,this.iframe=e,this.iframe.addEventListener("load",this.onFrameLoad,this),"function"==typeof t&&this.iframe.addEventListener("load",t)}},{key:"onFrameLoad",value:function(){var n=this,e=_.hasFeature("readAloud"),t=this.iframe.contentWindow;if(e){var o=t.document.getElementsByTagName("body")[0],i=t.document.getElementsByTagName("head")[0];S.readSpeakerCss(i),S.readSpeakerConf(o,b.params.book),S.readSpeakerEvents(o),S.addReadSpeakerScript(o),S.addReadSpeakerButton(o,t)}if(this.tools=t.Tools,this.Draw=t.Draw,this.GtRangy=t.GtRangy,this.GtAudio=t.GtAudio,this.GtPdfJS=t.GtPdfJS,this.tools&&this.Draw&&this.GtRangy&&this.GtAudio&&this.GtPdfJS){var r={highlight:{start:I.instant("GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY"),end:I.instant("GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY")},note:{start:I.instant("GT_READER_NOTE_READ_START_ACCESSIBILITY"),end:I.instant("GT_READER_NOTE_READ_END_ACCESSIBILITY")}};if(t.document.body.classList.add("webreader"),t.GtConfig.isMobile=!1,this.GtRangy.setWebReader(this),this.GtRangy.init({accessibility:r}),t.document.getElementById("gtrangy-style").textContent+="\n                .gt-search-highlight {\n                    background-color: yellow !important;\n                    padding: 2px 0px;\n                    outline: 2px solid blue;\n                }\n            ","function"==typeof t.setWebReader&&t.setWebReader(),t.sendToReader=function(e,t){n.emit(e,t),console.log(e,t)},this.GtPdfJS&&this.GtPdfJS.init(),this.isPDF()?this.zoomPDF(this.PDFScale):this._initUserInputs(),this.isWatermarkActive=_.hasFeature("bookWatermark"),this.GtPdfJS&&this.isPDF()&&this.isWatermarkActive){var a=v.getUser();this.GtPdfJS.setWatermark(a.identity+" "+a.email)}this.internalLinks=t.document.querySelectorAll(".gt-internal-link"),this.internalLinks.length&&this.setInternalLinkHref(this.internalLinks);var s=b.params.book;this.book=y.getBookByContentId(s);var u=b.params.assignment;this.sharingId=this._sharingId(s,u),this.contentsInfos=k.getBySharingId(this.sharingId);var l=k.DEFAULT_TTS_VOLUME,c=k.DEFAULT_TTS_SPEED,d=k.DEFAULT_ALT_MEDIA_ENABLED;if(this.contentsInfos){var g=this.contentsInfos.options.accessibility?this.contentsInfos.options.accessibility.fontName:"";this.setFont(g,!1);var p=this.contentsInfos.options.accessibility,h=p&&null!=p.soundPower?p.soundPower:l,f=p&&null!=p.speechRate?p.speechRate:c,m=p&&null!=p.altMediaEnabled?p.altMediaEnabled:d;this.activateAltTextMedia(m,h,f,!1)}else this.activateAltTextMedia(d,l,c,!1);this.isEpubFixed()&&this.zoomEpubFixed(this.EpubFixedWidth),this.book.isEpubReflow()&&this.zoomEpubReflow(this.EpubReflowWidth),this.setToolbarMargin(260,-20),this.ready(),this.emit("load")}}},{key:"_sharingId",value:function(e,t){var n=null;if(t)n=t;else{var o=y.getBookByContentId(e);o&&(n=o.getSharingId())}return n}},{key:"activateAltTextMedia",value:function(e,t,n,o){var i=!(3<arguments.length&&void 0!==o)||o,r=s.get("lang");if(e?this.tools.initTextAltOnMedia(r,t,n):this.tools.cancelTextOnMediaAlt(),!0===i&&this.sharingId){var a={altMediaEnabled:e,soundPower:t,speechRate:n};k.updateAccessibilityTTS(this.sharingId,a)}}},{key:"setFontSize",value:function(e){Number.isInteger(e)&&((t.accessibility.fontSize=e)==(t["font-sizes"].range[1]-t["font-sizes"].range[0])/2?this.tools.resetFontSize():this.tools.setFontSize(e+"%"))}},{key:"testAudioForAltText",value:function(e,t,n){var o=s.get("lang");this.tools.testAudioforAltMedia(o,e,t,n)}},{key:"setFont",value:function(e,t){var n=!(1<arguments.length&&void 0!==t)||t;if(e&&""!=e?this.tools.setFontFamily(e):this.tools.resetFontFamily(),!0===n&&this.sharingId){var o={fontName:e};k.updateAccessibilityFont(this.sharingId,o)}}},{key:"highlight",value:function(e,t,n){var o=2<arguments.length&&void 0!==n&&n,i=void 0;return i=t?(this.GtRangy.unlight(),t):r.generateUUID("hash"),this.GtRangy.highlight(i,o,e)}},{key:"removeHighlight",value:function(){this.GtRangy.unlight()}},{key:"focusHighlight",value:function(e){this.highlightId&&this.GtRangy.focusHighlight(e)}},{key:"setToolbarMargin",value:function(e,t){this.GtRangy.setFramePosition({left:e,top:t})}},{key:"search",value:function(e){e&&this.GtRangy.search(e)}},{key:"undoSearch",value:function(){this.GtRangy.undoSearch()}},{key:"scrollToElement",value:function(e){this.iframe.contentWindow.location.hash=e}},{key:"setInternalLinkHref",value:function(e){e.forEach(function(e){var t=e.href.split("?")[0],n=e.getAttribute("external-id");e.href=t+"?#"+n})}},{key:"zoomPDF",value:function(e){var t=this;this.isPDF()&&(isNaN(e)||(this.PDFScale=e,this.GtRangy.unlightAll(),this.GtPdfJS.zoom(this.PDFScale).then(function(){t._initUserInputs()})))}},{key:"isPDF",value:function(){return!!this.GtPdfJS&&this.GtPdfJS.isPDF}},{key:"isEpubFixed",value:function(){return this.book&&this.book.isEpubFixed()}},{key:"zoomEpubFixed",value:function(e){var t=this.iframe.contentWindow.document.body,n=t.parentNode,o=t.querySelector("body *:first-child");n.setAttribute("style","background: #808080; height: 100%;"),o.setAttribute("style","display: table-cell;"),t.setAttribute("style","transform-origin: top center; margin: 0 auto; height: auto; display: table;"),this.EpubFixedWidth=e;var i=t.offsetWidth/n.offsetWidth*100;t.setAttribute("style","transform: scale("+this.EpubFixedWidth/i+"); transform-origin: top center; margin: 0 auto; height: auto; display: table;")}},{key:"zoomEpubReflow",value:function(e){var t=this.iframe.contentWindow.document.body;this.EpubReflowWidth=e,"firefox"==document.body.className?t.setAttribute("style","transform: scale("+e+")"):t.setAttribute("style","zoom: "+e)}},{key:"_initUserInputs",value:function(){var o=this.iframe.contentWindow;if("PREVIEW"!==v.readerMode){var e=i.getSyncDataByContext({book:b.params.book,assignment:b.params.assignment}),t=e.notes.map(function(e){if(!e.deleted)return e.options.serializedData});t.length&&this.GtRangy.highlight(t,!0);var n=e.highlights.map(function(e){if(!e.deleted)return e.options.serializedData});n.length&&this.GtRangy.highlight(n),"function"==typeof o.setExercise&&(b.params.assignment&&y.loadAssignmentId(b.params.assignment).then(function(e){var t=e;if(t&&("evaluation"==t.type&&"function"==typeof o.exerciseEvaluationMode&&o.exerciseEvaluationMode(t.evaluation_options.show_score_on_submit,t.evaluation_options.show_answers_on_submit),"function"==typeof o.exerciseReadOnlyMode)){var n=Date.now();(new Date(t.due_date).getTime()<n||"finished"==t.status)&&o.exerciseReadOnlyMode()}}),e.exercises.forEach(function(e){i.prepareExerciseForInjection(e),o.setExercise(e.options.exerciseId,e)}))}}}]),n)}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("app").factory("IframeInterface",function(){function e(){_classCallCheck(this,e),this.isReady=!1,this.callbacksWhenReady=[],this.onSelectedHighlight=this.onSelectedHighlight.bind(this),this.onSelectedText=this.onSelectedText.bind(this),this.listeners=new Map}return _createClass(e,[{key:"onSelectedText",value:function(e){this.setSelectedText=e}},{key:"onSelectedHighlight",value:function(e){this.setSelectedHighlight=e}},{key:"ready",value:function(){this.isReady=!0,this.callbacksWhenReady.forEach(function(e){return e.apply()}),this.callbacksWhenReady.length=0}},{key:"whenReady",value:function(e){this.isReady?e.apply():this.callbacksWhenReady.push(e)}},{key:"emit",value:function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];var i=this.listeners.get(e);return!(!i||!i.length||(i.forEach(function(e){e.apply(void 0,n)}),0))}},{key:"on",value:function(e,t){var n=this;return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),function(){n.listeners.get(e).splice(n.listeners.get(e).indexOf(t),1)}}}]),e}),angular.module("app").config(["$stateProvider",function(e){e.state("reader.userinput.notes",{url:"/notes"}).state("reader.userinput.bookmarks",{url:"/bookmarks"}).state("reader.userinput.highlights",{url:"/highlights"}).state("reader.userinput.notdisplayed",{url:"/bad-items"})}]),angular.module("app").controller("userInput",["$state","$scope","SyncService","Library","SearchService",function(e,t,n,o,i){var r=this;t.$state=e,this.book=o.getBookByContentId(e.params.book),this.highlightsActivated=this.book.readerHighlightFeature(),this.notesActivated=this.book.readerNoteFeature(),this.bookmarksActivated=this.book.readerBookmarkFeature(),this.bookTitle=this.book.getTitle(),this.isFirefox="undefined"!=typeof InstallTrigger,this.ariaLive=this.isFirefox?"off":"polite",this.cover=this.book.cover||"commons/img/covers.png",this.author=this.book.author||"-",this.ndAnnotations=n.getNdAnnotations().length,this.annotationsStatus=n.getNotViewedAnnotation().length,this.activeSearch=!1,this.pageTitleIndex={},this.filterOptions=[{name:"Content order",key:"content"},{name:"Newest",key:"newest"},{name:"Oldest",key:"oldest"}],this.sortSelected=this.filterOptions[0],this.getSyncFilter=function(){switch(e.current.name){case"reader.userinput.notes":return"note";case"reader.userinput.bookmarks":return"bookmark";case"reader.userinput.highlights":return r.highlightsInputs()?"highlight":null;case"reader.userinput.notdisplayed":return"notdisplayed";default:return null}},this.getAriaLabel=function(e){return!e&&!r.getSyncFilter()||e===r.getSyncFilter()},this.getSyncObjects=function(){return n.getUserInputsByContext({book:e.params.book,assignment:e.params.assignment})},this.updateStatus=function(e){n.updateNdAnnotationsStatus(e),r.annotationsStatus=0},this.userInputs=this.getSyncObjects(),this.getSyncObjects().forEach(function(e){var t=r.book.pages,n=e.pageTitle;r.pageTitleIndex[n]=t.findIndex(function(e){return e.title==n})}),this.sortByContent=function(e,t){return r.pageTitleIndex[e.pageTitle]-r.pageTitleIndex[t.pageTitle]},this.sortAnnotations=function(e){return"oldest"===e.key?(r.userInputs=r.getSyncObjects().sort(function(e,t){return e.$created_at-t.$created_at}),r.sortSelected=e):"newest"===e.key?(r.userInputs=r.getSyncObjects().sort(function(e,t){return t.$created_at-e.$created_at}),r.sortSelected=e):"content"===e.key?(r.userInputs=r.getSyncObjects().sort(function(e,t){return r.sortByContent(e,t)}),r.sortSelected=e):void 0},this.clearSearch=function(){i.clearSearch(),r.searchQuery=""},this.onChanges=function(e){r.userInputs=e||r.getSyncObjects(),r.getLengths()},document.querySelector('[role="tablist"]').addEventListener("keydown",function(e){var t=document.querySelectorAll('[role="tab"]'),n=document.getElementById("menu-list-item").children,o=Array.prototype.slice.call(n).indexOf(document.activeElement);39!==e.keyCode&&37!==e.keyCode||(t[o].setAttribute("tabindex",-1),39===e.keyCode?++o>=t.length&&(o=0):37===e.keyCode&&--o<0&&(o=t.length-1),t[o].setAttribute("tabindex",0),t[o].focus())}),this.notesInputs=function(){return!!r.notesActivated||!!r.userInputs.find(function(e){return"note"===e.type})},this.highlightsInputs=function(){return!!r.highlightsActivated||!!r.userInputs.find(function(e){return"highlight"===e.type})},this.bookmarksInputs=function(){return!!r.bookmarksActivated||!!r.userInputs.find(function(e){return"bookmark"===e.type})},this.getLengths=function(){r.notesLength=r.userInputs.filter(function(e){return"note"===e.type&&r.book.getPage(e.pageId)}).length,r.highlightsLength=r.userInputs.filter(function(e){return"highlight"===e.type&&r.book.getPage(e.pageId)}).length,r.bookmarksLength=r.userInputs.filter(function(e){return"bookmark"===e.type&&r.book.getPage(e.pageId)}).length,r.notDisplayedLength=r.userInputs.filter(function(e){return!r.book.getPage(e.pageId)}).length},this.getLengths(),this.sortAnnotations(this.sortSelected),this.goBack=function(){e.go("reader.book",{book:e.params.book})}}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.account-settings",{url:"/account-settings",abstract:!1,templateUrl:"app/settings/account-settings/account-settings.html",controllerAs:"$ctrl",controller:["$anchorScroll","$location",function(t,n){this.innerNav=function(e){n.hash(e),t()}}]})}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.general-settings",{url:"/general-settings",abstract:!1,templateUrl:"app/settings/general-settings/general-settings.html",controllerAs:"$ctrl",controller:["$anchorScroll","$location",function(t,n){this.innerNav=function(e){n.hash(e),t()}}]})}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.profile",{url:"/profile",abstract:!1,templateUrl:"app/settings/profile/profile.html",controllerAs:"$ctrl",controller:["SessionService","API","$state","Config","LocalStorage","$translate",function(e,t,n,o,i,r){var a=this;this.user=e.getUser(),this.avatarProgress=null,this.hasChanges=!1;var s=this.user.identity.split(" ");this.firstName=s.slice(0,s.length-1).join(" "),this.lastName=s[s.length-1],this.avatarUploaded=function(){a.user.setProperty("avatar",a.fileUrl),a.hasChanges=!0},this.onBeforeUpload=function(n){return t.hapi.post("/s3/generate-signed-url",{key:n.filename,method:"putObject"}).then(function(e){var t=e.data;n.setUploadUrl(t.url),n.isSignedUrl(!0),a.fileUrl=t.full})},this.goBack=function(){n.go(e.goToShelf())},this.modalParams={type:"open",button:r.instant("GT_PROFILE_USER"),modalButton:"Confirm",body:"You have unsaved changes. Are you sure?"},this.update=function(){a.user.identity=a.firstName.trim()+" "+a.lastName.trim(),a.user.save(),a.hasChanges=!1}}]})}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.userinput.notes",{url:"/notes"}).state("app.userinput.bookmarks",{url:"/bookmarks"}).state("app.userinput.highlights",{url:"/highlights"})}]),angular.module("app").controller("globalUserInput",["$state","$scope","SyncService",function(e,t,n){t.$state=e,this.getSyncFilter=function(){switch(e.current.name){case"app.userinput.notes":return"note";case"app.userinput.highlights":return"highlight";case"app.userinput.bookmarks":return"bookmark";default:return null}},this.getSyncObjects=function(){return n.get()}}]),angular.module("commons").component("accessCodePanel",{bindings:{cancel:"&",visible:"="},templateUrl:"commons/components/access-code/access-code-panel.html",controller:["$state","API","Library","$translate","Config",function(e,n,o,i,r){this.currentStep=0,this.code="",this.errorMsg="",this.validateCode=function(){var t=this;return this.currentStep=1,n.hapi.patch("/v1/reader/licenses/activate",{access_code:this.code,app_studio_id:r.get("appId")}).then(function(e){return o.load({allBooks:!0})}).then(function(e){t.errorMsg="",t.currentStep=2}).catch(function(e){t.currentStep=3,e.data&&404===e.data.statusCode?t.errorMsg=i.instant("GT_ACCESS_CODE_NOT_FOUND"):e.data&&403===e.data.statusCode&&e.data.message?t.errorMsg=i.instant(e.data.message):t.errorMsg=i.instant("GT_ACCESS_CODE_ERR_UNKNOW")})},this.retry=function(){this.currentStep=0},this.goToLibrary=function(){this.cancel(),e.go("app.library.all"),e.reload(),this.currentStep=0},this.close=function(){this.cancel(),this.currentStep=0}}]}),angular.module("commons").component("footerOptions",{templateUrl:"commons/components/footer-options/footer-options.html",controllerAs:"$ctrl",controller:["LocalStorage","Config","$translate",function(e,t,n){var o=this;this.language=e.get("lang")||"en",this.languages=Object.keys(t.get("languages")),this.termsAndConditionsURL=t.getExternalLink("terms");var i={en:"commons/img/english-us-uk.svg",fr:"commons/img/fr-flag-icon.png",de:"commons/img/de-flag-icon.png",it:"commons/img/it-flag-icon.png",es:"commons/img/es-flag-icon.png"};return this.getFlag=function(e){return e=e||o.language,i[e]?i[e]:"commons/img/missing-flag-icon.png"},this.languagesName=function(e){return e=e||o.language,n.instant("GT_LANGUAGE_OPTIONS_"+e.toUpperCase())},this.setLanguage=function(e){e!==o.language&&(o.language=e,n.use(e))},this}]}),angular.module("commons").component("gtButton",{bindings:{title:"@",icon:"@",color:"@",click:"&",disabled:"="},templateUrl:"commons/components/gt-button/gt-button.html",controllerAs:"$ctrl",controller:function(){return this}}),angular.module("commons").component("gtInput",{bindings:{type:"@",title:"@",data:"=",condition:"<",compare:"<",icon:"@",link:"@",name:"@",required:"@",disabled:"<",validation:"<",used:"="},transclude:!0,templateUrl:"commons/components/gt-input/gt-input.html",controllerAs:"$ctrl",controller:["$translate",function(e){var t=this;return this.isPass=angular.copy(this.type),this.isVisible=!1,this.showPass=function(){t.isVisible=!t.isVisible,t.type=t.isVisible?"text":"password"},this.emailPattern=/^\s*[\w\-\+_]+(\.[\w\-\+_]+)*\@[\w\-\+_]+\.[\w\-\+_]+(\.[\w\-\+_]+)*\s*$/,this.typeTranslation=e.instant("GT_MUST_MATCH_"+this.type.toUpperCase()),this}]}),angular.module("commons").component("toolbar",{bindings:{logout:"&",showaccesscodepanel:"&"},templateUrl:"commons/components/toolbar/toolbar.html",controller:["$scope","$state","SessionService","Config","LocalStorage","$window","$translate","UsersPreferences",function(e,t,n,o,i,r,a,s){var u=this;e.$state=t,this.user=n.user,this.language=i.get("lang")||"en";var l=s.get(s.KEY_USER_LANGUAGE);l&&(this.language=l.value),this.languages=Object.keys(o.get("languages")),this.termsAndConditionsURL=o.getExternalLink("terms"),this.policyURL=o.getExternalLink("privacy"),this.contactURL=o.getExternalLink("contact"),this.isContactEmail=this.contactURL?-1!=this.contactURL.indexOf("@"):null;var c={en:"commons/img/english-us-uk.svg",fr:"commons/img/fr-flag-icon.png",de:"commons/img/de-flag-icon.png",it:"commons/img/it-flag-icon.png",es:"commons/img/es-flag-icon.png",_default:"commons/img/missing-flag-icon.png"};this.getFlag=function(e){return e=e||u.language,c[e]?c[e]:e._default},this.languagesName=function(e){return e=e||u.language,a.instant("GT_LANGUAGE_OPTIONS_"+e.toUpperCase())},this.setLanguage=function(e){return e!==u.language&&(u.language=e,s.set(s.KEY_USER_LANGUAGE,e),a.use(e)),u.lang=e}}]}),angular.module("commons").directive("ngDraggable",["$document",function(f){return{restrict:"A",scope:{dragOptions:"=ngDraggable"},link:function(e,t){var n,o,i,r,a,s,u=0,l=0,c=t[0].offsetWidth,d=t[0].offsetHeight;if(e.dragOptions){i=e.dragOptions.start,a=e.dragOptions.drag,r=e.dragOptions.stop;var g=e.dragOptions.container;g&&(s=document.getElementById(g).getBoundingClientRect())}function p(e){l=e.clientY-o,u=e.clientX-n,function(){s&&(u<s.left?u=s.left:u>s.right-c&&(u=s.right-c),l<s.top?l=s.top:l>s.bottom-d&&(l=s.bottom-d));t.css({top:l+"px",left:u+"px"})}(),a&&a(e)}function h(e){f.unbind("mousemove",p),f.unbind("mouseup",h),r&&r(e)}t.on("mousedown",function(e){e.preventDefault(),n=e.clientX-t[0].offsetLeft,o=e.clientY-t[0].offsetTop,f.on("mousemove",p),f.on("mouseup",h),i&&i(e)})}}}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};var STATIC_COLOR_EXPRESSION=/^{((\s|,)*?["'a-zA-Z-]+?\s*?:\s*?('|")[a-zA-Z0-9-.]*('|"))+\s*}$/;angular.module("commons").directive("gtColors",["$parse","Theme",function(u,l){return{restrict:"A",require:[],compile:function(e,t){var n,o,i,s=(n=t.gtColors,o=-1<n.indexOf("::"),i=o||STATIC_COLOR_EXPRESSION.test(t.gtColors),t.gtColors=n.replace("::",""),!o&&!i);return function(e,r,t){function n(){return t.gtColors||(t.gtColors="{}"),u(t.gtColors)(e)}function a(o,i){Object.keys(o).forEach(function(e){var t=i[o[e]],n=t?t.value:o[e];r.css(e,n)})}e.$on("$destroy",function(){angular.noop()}),e.$on("theme-changed",function(){var e=l.getTheme();a(n(),e)});try{var o=l.getTheme(),i=n();!function(t,n){if(t.hover){var o=_extends({},t.hover);delete t.hover;function e(){a(o,n)}function i(){var e;e=o,Object.keys(e).forEach(function(e){r.css(e,"")}),a(t,n)}r[0].removeEventListener("mouseover",e,!1),r[0].removeEventListener("mouseout",i,!1),r[0].addEventListener("mouseover",e,!1),r[0].addEventListener("mouseout",i,!1)}}(i,o),s?e.$watch(n,function(){a(n(),o)},!0):a(i,o)}catch(e){console.error(e)}}}}}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("Theme",["$rootScope",function(t){function e(){_classCallCheck(this,e),this._theme={primaryColor:{value:"red"},secondaryColor:{value:"blue"},textColor:{value:"#34495e"}}}return new(_createClass(e,[{key:"getTheme",value:function(){return this._theme}},{key:"setTheme",value:function(e){this._theme=_extends(this._theme,e),t.$broadcast("theme-changed")}}]),e)}]),angular.module("commons").directive("gtModal",["ngDialog","$sce",function(r,a){return{restrict:"EA",templateUrl:"commons/directives/gt-modal/gt-modal.html",scope:{params:"=",cancelButton:"&",approveButton:"&"},transclude:!0,link:function(e,t,n,o,i){t.on("click",function(){r.open({template:"commons/directives/gt-modal/gt-modal-ng-dialog.html",showClose:!1,appendClassName:"open"===e.params.type?"directive-modal-read":"delete"===e.params.type?"directive-modal-delete":"directive-modal-common",resolve:{},className:"ngdialog-theme-default",controllerAs:"$ctrl",controller:function(){var o=this;i(e,function(e){for(var t="",n=0;n<e.length;n++)t+=e[n].outerHTML;o.cloneElement=a.trustAsHtml(t)}),this.modalParams=e.params,this.buttonFunc=function(){return e.approveButton()}}})})}}}]),angular.module("commons").directive("lazyBackground",["$timeout",function(r){return{restrict:"A",scope:{lazyBackground:"@"},link:function(n,o,i){i.$observe("lazyBackground",function(e){var t=new Image;t.onload=function(){r(function(){n.$apply(function(){i.lazyBackground&&o.css({background:'url("'+e+'") no-repeat center',backgroundSize:"cover"})})})},t.src=e,t.complete&&t.onload()})}}}]),angular.module("commons").directive("lazyImage",["$timeout",function(i){return{restrict:"A",scope:{lazyImage:"@"},link:function(n,o,e){e.$observe("lazyImage",function(e){var t=new Image;t.onload=function(){i(function(){n.$apply(function(){e&&""!=e&&o.attr("src",e)})})},t.src=e,t.complete&&t.onload()})}}}]),angular.module("commons").directive("ngOnload",function(){return{restrict:"A",scope:{callback:"&ngOnload"},link:function(e,t){t.one("load",function(){e.callback()})}}});_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("Entities",["API",function(t){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"load",value:function(e){return t.hapi.get(e||this.endpoint).then(function(e){return e.data})}},{key:"hapi",value:function(){return t.hapi}}]),e}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("Entity",["API",function(n){function o(e,t){_classCallCheck(this,o),this._update(e),this._url=t}return _createClass(o,[{key:"_update",value:function(t){var n=this;this._entity={},Object.keys(t).forEach(function(e){e in["id","$created_at","$updated_at"]||(n._entity[e]=t[e]),n[e]=t[e]})}},{key:"_syncEntity",value:function(){var t=this;Object.keys(this._entity).forEach(function(e){t._entity[e]=t[e]})}},{key:"setProperty",value:function(e,t){this._entity[e]=this[e]=t}},{key:"save",value:function(){var t=this;if(this._url){this._syncEntity();var e="post";return this.id&&(e="put"),n.hapi[e](this._url,this._entity).then(function(e){return t._update(e.data),e.data})}}},{key:"patch",value:function(e){var t=this;if(this._entity.id)return n.hapi.patch(this._url+"/"+this._entity.id,e).then(function(e){return t._update(e.data),e.data})}}],[{key:"generateUUID",value:function(e){return(0<arguments.length&&void 0!==e?e:"")+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}},{key:"hashCode",value:function(e){if(!e||!e.length)return 0;for(var t=void 0,n=0;n<e.length;n++)t=Math.imul(31,t)+e.charCodeAt(n)|0;return""+t}}]),o}]),angular.module("app").component("assignmentInfo",{bindings:{assignment:"<",closeCallback:"<"},templateUrl:"app/assignments/components/assignment-info/assignment-info.html",controller:["$state","$scope","SyncService","Assignment","Library",function(e,t,n,o,i){var r=this;this.moreInfo=!1,this.sync={notes:0,highlights:0,bookmarks:0},this.$onChanges=function(){r.assignment&&(r.sync={notes:0,highlights:0,bookmarks:0},r.book=i.getBookByLMSId(r.assignment.getLMSId()),r.book.getStructure().then(function(){var e=n.getSyncDataByContext({book:r.book.book_content_id,assignment:r.assignment.id});r.sync.notes=e.notes.length,r.sync.bookmarks=e.bookmarks.length,r.sync.highlights=e.highlights.length}))},this.closeInfo=function(){"function"==typeof r.closeCallback&&r.closeCallback.apply()},this.goToReader=function(){e.go("reader.book",{book:r.book.book_content_id,assignment:r.assignment?r.assignment.id:void 0})},this.goToHighlights=function(){e.go("reader.userinput.highlights",{book:r.book.book_content_id,assignment:r.assignment?r.assignment.id:void 0})},this.goToNotes=function(){e.go("reader.userinput.notes",{book:r.book.book_content_id,assignment:r.assignment?r.assignment.id:void 0})},this.goToBookmarks=function(){e.go("reader.userinput.bookmarks",{book:r.book.book_content_id,assignment:r.assignment?r.assignment.id:void 0})}}]}),angular.module("app").component("assignmentList",{bindings:{assignments:"="},templateUrl:"app/assignments/components/assignment-list/assignment-list.html",controller:function(){}}),angular.module("app").component("assignmentTile",{bindings:{assignment:"="},templateUrl:"app/assignments/components/assignment-tile/assignment-tile.html",controller:["$state","$rootScope","Library","LocalStorage","API",function(e,t,n,o,i){var r=this,a=n.getBookByLMSId(this.assignment.getLMSId());this.cover=a?a.cover:void 0;var s=1;s=a.infos?a.infos.pages.length:a.contents?a.contents.length:1,this.progress=+(100*this.assignment.pagesRead/s).toFixed(0)||0,this.isNew=o.get(this.assignment.id),this.today=Date.now(),this.due=new Date(this.assignment.due_date).getTime(),this.start=new Date(this.assignment.start_date).getTime(),this.moreInfo=!1,this.showInfo=function(){t.$broadcast("show-assignment-info-panel",r.assignment)},this.read=function(){e.go("reader.book",{book:a.book_content_id,assignment:r.assignment.id})},this.goToReport=function(){window.open(i.getCorrectionSrc(r.assignment.id,o.get("lang")),"_blank")}}]}),angular.module("app").component("bookFilters",{bindings:{view:"=",sort:"=",filter:"="},templateUrl:"app/library/components/book-filters/book-filters.html",controller:["$translate","LocalStorage","$rootScope","UsersPreferences",function(e,t,n,o){var i=this;this.$onInit=function(){n.Config.hasScreenSorter("shelf")?i.sortFilters=i.sortFiltersId(n.Config.getScreenSorter("shelf")):i.sortFilters=[{enabled:!0,label:"GT_SORT_LAST_OPEN",target:"last_open_date",orderBy:"desc",id:"0"},{enabled:!0,label:"GT_SORT_LAST_ADDED_TO_LIB",target:"$updated_at",orderBy:"desc",id:"1"},{enabled:!0,label:"GT_SORT_TITLE_AZ",target:"title",orderBy:"asc",id:"2"},{enabled:!0,label:"GT_SORT_TITLE_ZA",target:"title",orderBy:"desc",id:"3"}];var e=o.get(o.KEY_DESK_BOOK_SORTER);if(e){var t=i.sortMethodConfig(e.value);t?i.sort=t:i.applyFilter()}else i.applyFilter()},this.sortMethodConfig=function(t){return i.sortFilters.find(function(e){return e.label===t})},this.sortFiltersId=function(e){return e.forEach(function(e,t){e.id=t}),e},this.defineSortMethod=function(){o.set(o.KEY_DESK_BOOK_SORTER,i.sort.label)},this.changeView=function(e){t.set("view",e),i.view=e},this.applyFilter=function(){n.Config.hasScreenSorter("shelf")?i.sort=i.sortMethodConfig(n.Config.getCurrentScreenSorter("shelf")):i.sort=i.sortFilters[0]}}]}),angular.module("app").component("bookInfo",{bindings:{book:"<",closeCallback:"<"},templateUrl:"app/library/components/book-info/book-info.html",controller:["$state","$scope","SyncService","UsersContentsInfos",function(e,t,n,o){var i=this;this.moreInfo=!1,this.sync={notes:0,highlights:0,bookmarks:0},this.highlightsActivated=!0,this.notesActivated=!0,this.bookmarksActivated=!0,this.bookTitle=function(){return i.book.getTitle()},this.$onChanges=function(){i.book&&(i.sync={notes:0,highlights:0,bookmarks:0},i.book.getStructure().then(function(){var e=n.getSyncDataByContext({book:i.book.book_content_id});i.sync.notes=e.notes.length,i.sync.bookmarks=e.bookmarks.length,i.sync.highlights=e.highlights.length}),i.book.getFeatures(i.book.version).then(function(){i.highlightsActivated=i.book.readerHighlightFeature(),i.notesActivated=i.book.readerNoteFeature(),i.bookmarksActivated=i.book.readerBookmarkFeature()}))},this.closeInfo=function(){"function"==typeof i.closeCallback&&i.closeCallback.apply()},this.toggleFavourite=function(){o.toggleFavourite(i.book.getSharingId()),i.book.favourite=!i.book.favourite},this.goToReader=function(){e.go("reader.book",{book:i.book.book_content_id})}}]}),angular.module("app").component("bookList",{bindings:{books:"=",sort:"=",view:"=",filter:"="},templateUrl:"app/library/components/book-list/book-list.html",controller:function(){var e=this;this.orderByFunction=function(){return e.sort?[("desc"===e.sort.orderBy?"-":"")+e.sort.target,"title"]:"title"}}}),angular.module("app").component("bookTile",{bindings:{book:"=",view:"="},templateUrl:"app/library/components/book-tile/book-tile.html",controller:["$rootScope","$state","UsersContentsInfos","Config",function(e,t,n,o){var i=this;this.openMenu=!1,this.book.favourite=n.isFavourite(this.book.getSharingId()),this.showInfo=function(){e.$broadcast("show-info-panel",i.book)},this.bookTitle=this.book.getTitle(),this.toggleFavourite=function(e){e.stopPropagation(),n.toggleFavourite(i.book.getSharingId()),i.book.favourite=!i.book.favourite},this.goToReader=function(){if(o.openNewTab()){var e=t.href("reader.book",{book:i.book.book_content_id});window.open(e,"_blank")}else t.go("reader.book",{book:i.book.book_content_id})}}]}),angular.module("app").component("assignmentEvaluation",{bindings:{assignment:"="},templateUrl:"app/reader/components/assignment-evaluation/assignment-evaluation.html",controllerAs:"$ctrl",controller:["Evaluation","$window","$scope","Iframe","$state",function(e,t,n,o,i){var r=this;if("evaluation"==this.assignment.type){this.evaluation=new e(this.assignment),this.evaluation.start(),this.finished=!1,this.evaluation.onFinish(function(){r.finished=!0,alert("Evaluation finished."),i.go("app.assignments.all")}),t.onbeforeunload=function(){if(!r.evaluation.isFinished()&&!r.evaluation.options.user_can_leave)return""};var a=n.$on("$stateChangeStart",function(e,t,n,o){if(!r.evaluation.isFinished()&&!r.evaluation.assignment.submitted&&!(0<=o.name.indexOf(t.name))&&(r.evaluation.options.user_can_leave||!r.evaluation.isFinished())){if(r.evaluation.options.user_can_leave&&!r.evaluation.isFinished()){if(e.preventDefault(),confirm("Warning! Are you sure you want to leave this session?"))return a(),void i.go(t,n)}else if(e.preventDefault(),confirm('Do you really want to quit the page? Evaluation will be marqued as "finished".'))return a(),void i.go(t,n);return!1}});return t.onunload=function(){return r.evaluation.pause()},n.$on("$destroy",function(){r.evaluation.pause(),"function"==typeof a&&a()}),this}}]});_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(i,r){function a(e,t){try{var n=s[e](t),o=n.value}catch(e){return void r(e)}if(!n.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});i(o)}return a("next")})}}angular.module("app").component("bookCitation",{bindings:{book:"<"},templateUrl:"app/reader/components/book-citation/book-citation.html",controllerAs:"$ctrl",controller:["ngDialog","Config",function(e,t){function n(t){var e=r.find(function(e){return e.name.toLowerCase()===t.toLowerCase()});return e?e.value:""}function o(e){if(!e)return"";var t=e.split(" ");return t.length<=1?"":t[1]}function i(e){return e?e.split(" ")[0]:""}var r=this.book.project_metas.value,a=this.book.title,s={metadata:{title:n("title")||a,publisher:n("publisher"),city:n("city"),year:n("publication date"),editiontext:n("edition"),vol:n("volume")},contributors:[{function:n("contributor 1 role").toLowerCase(),first:i(n("contributor 1 first and middle name")),middle:o(n("contributor 1 first and middle name")),last:n("contributor 1 last name")},{function:n("contributor 2 role").toLowerCase(),first:i(n("contributor 2 first and middle name")),middle:o(n("contributor 2 first and middle name")),last:n("contributor 2 last name")},{function:n("contributor 3 role").toLowerCase(),first:i(n("contributor 3 first and middle name")),middle:o(n("contributor 3 first and middle name")),last:n("contributor 3 last name")}]},u={url:t.getCitationURL()};return this.citate=function(){e.open({template:"app/reader/components/book-citation/book-citation-modal.html",showClose:!0,appendClassName:"directive-modal-common",resolve:{_citation:["$q","CitationService",function(e,n){var t=["mla8","apa","harvard","chicagob"].map(function(e){var t=_extends({},s,{style:e},{pubonline:u});return n.getCitation(t)});return e.all(t)}]},className:"ngdialog-theme-default",controllerAs:"$ctrl",controller:"CitationController"})},this}]}).controller("CitationController",["_citation","$sce",function(o,i){var r=this;this.styles=[{type:"mla8",name:"MLA"},{type:"apa",name:"APA"},{type:"harvard",name:"Harvard"},{type:"chicagob",name:"Chicago/Turabian"}],this.type=this.styles[0].type,this.changeCitationType=function(t,e){if(o[e||0]){t=t||r.type;var n=o.find(function(e){return e.style===t});r.citation=i.trustAsHtml(n.data)}},this.changeCitationType(),this.copyToClipboard=function(){var t=document.getElementById("citation").innerHTML;function e(e){e.clipboardData.setData("text/html",t),e.clipboardData.setData("text/plain",t),e.preventDefault()}document.addEventListener("copy",e),document.execCommand("copy"),document.removeEventListener("copy",e)}}]),angular.module("app").component("goToPage",{bindings:{book:"<"},templateUrl:"app/reader/components/go-to-page/go-to-page.html",controllerAs:"$ctrl",controller:["$state","$scope",function(n,e){var o=this;this.structureVersion=this.book.structure.version;var t=this.book.structure.content,i=this.book.pages;this.uniquePages=[].concat(_toConsumableArray(new Set(i.map(function(e){return e.path}))));var r=i[i.length-1],a=Number(r.logicalPageNumber);this.pageNumber=null,this.totalPageNumber=this.uniquePages.length,this.structureVersion&&(this.totalPageNumber=this.book.countPages.length,this.uniquePages=this.book.countPages,r=this.uniquePages[this.uniquePages.length-1]),this.getIndexOfPage=function(){var t=o.book.getPage(n.params.page);if(t)return o.uniquePages.findIndex(function(e){return e==t.path})+1};return this.actualPageNumber=function(){var t=o.book.getPage(n.params.page);if(t)return o.structureVersion?function(t){var e=o.uniquePages.find(function(e){return e.target.includes(t)});if(e)return e.num}(t.target):t.logicalPageNumber?t.logicalPageNumber:i.findIndex(function(e){return e.path==t.path})+1},e.$on("$locationChangeSuccess",function(){o.actualPageNumber(),o.getIndexOfPage()}),this.getLogicalPageNumber=function(e,t){var n=null;return e.forEach(function(e){n||(e.logicalPageNumber==t&&(n=e),Number(t)>a&&!isNaN(a)&&Number(t)<=o.totalPageNumber&&(n=o.book.getPage(o.uniquePages[t-1])),e.content&&(n=o.getLogicalPageNumber(e.content,t)))}),n},this.getPageByNumber=function(){if(o.structureVersion)return o.uniquePages.find(function(e){return e.num==o.pageNumber});if(t.length){if(t[0].logicalPageNumber)return o.getLogicalPageNumber(t,o.pageNumber);var e=o.pageNumber-1;return i[e]}},this.goToPage=function(){var e=o.getPageByNumber();if(!e)return o.pageNumber=o.actualPageNumber();n.go("reader.book.page",{page:e.path||e.id,scrollTo:null})},this}]}),angular.module("app").component("printPages",{bindings:{book:"<"},templateUrl:"app/reader/components/print-pages/print-pages.html",controllerAs:"$ctrl",controller:["ngDialog","API","SessionService","User",function(e,t,n,o){var i=this.book;return this.openPrintModal=function(){e.open({template:"app/reader/components/print-pages/print-pages-modal.html",controllerAs:"$ctrl",appendClassName:"directive-modal-common",className:"ngdialog-theme-default print-modal",width:"330px",resolve:{book:function(){return i},userAPI:function(){return t.getUser().then(function(e){return n.user=new o(e)})}},controller:"PrintController"})},this}]}).controller("PrintController",["book","$scope","$state","$sce","SessionService","Config","$translate","PrintService","StatisticsService","$timeout",function(a,t,o,n,i,e,r,s,u,l){var c=this;this.displayError="",this.structureVersion=a.structure.version;var d=a.structure.content;this.countPages=a.countPages;var g=this.structureVersion?a.countPages:a.pages,p=i.getToken(),h=[].concat(_toConsumableArray(new Set(g.map(function(e){return e.path})))),f=g[g.length-1],m=g.findIndex(function(e){return e.id==f.id}),v=Number(f.logicalPageNumber),b=e.get("appId"),y=i.getUser(),_=10,k=null,I=y.apps.find(function(e,t){return k=t,e.id===b});if(I.print&&I.print.token===p)_=I.print.limit;else{var S={limit:_,token:p};y.apps[k].print=S,i.user=y}this.getPage=function(e){var t=a.getPage(e);return c.structureVersion?c.countPages.find(function(e){return e.target.includes(t.target)}):t},this.actualPageNumber=function(e){var t=e||o.params.page,n=c.getPage(t);if(n)return n.logicalPageNumber?n.logicalPageNumber:n.num?n.num:a.pages.findIndex(function(e){return e.path==n.path})+1},this.fromPage=this.actualPageNumber(null),this.getPageByNumber=function(e){if(d.length)return d[0].logicalPageNumber?c.getLogicalPageNumber(d,e):void 0},this.getLogicalPageNumber=function(e,t){var n=null;return e.forEach(function(e){n||(e.logicalPageNumber==t&&(n=e),Number(t)>v&&!isNaN(v)&&Number(t)<=c.totalPageNumber&&(n=c.book.getPage(h[t-1])),e.content&&(n=c.getLogicalPageNumber(e.content,t)))}),n},this.getIndexOfPage=function(t){if(t)return c.structureVersion?a.countPages.findIndex(function(e){return e.target==t.target}):h.findIndex(function(e){return e==t.path})+1},this.convertPageToIndex=function(t,e){var n=c.structureVersion?a.countPages.find(function(e){return e.num==t}):c.getPageByNumber(t);if(n)return c.getIndexOfPage(n);var o=h[t-1];if(o){var i=c.actualPageNumber(o);e?c.fromPage=i:c.toPage=i;var r=c.getPageByNumber(i);return c.getIndexOfPage(r)}},this.validateInputs=function(){l(function(){if(c.toPage&&c.fromPage){if("0"!=c.fromPage.toString().charAt(0)&&"0"!=c.toPage.toString().charAt(0))return c.structureVersion?(c.firstPage=a.getCountPageByNum(c.fromPage),c.lastPage=a.getCountPageByNum(c.toPage),c.validateError=!1,c.displayError=c.firstPage&&c.lastPage?T():r.instant("GT_BOOK_PRINT_INVALID_PAGE_RANGE")):(c.firstPage=c.convertPageToIndex(c.fromPage,!0),c.lastPage=c.convertPageToIndex(c.toPage,!1),c.validateError=!1,c.firstPage&&c.lastPage?c.validateFromToPages():c.displayError=r.instant("GT_BOOK_PRINT_INVALID_PAGE_RANGE"));c.displayError=r.instant("GT_BOOK_PRINT_INVALID_PAGE_RANGE")}else c.displayError="",c.validateError=!0},1e3)};var T=function(){var e=c.convertPageToIndex(c.firstPage.num);E(c.firstPage);var t=c.convertPageToIndex(c.toPage),n=_+r.instant("GT_BOOK_PRINT_PAGES_LEFT");return t-e<_&&(n=!t||e<=t?"":r.instant("GT_BOOK_PRINT_FROM_TO_PAGES")),n};this.validateFromToPages=function(){return c.displayError=r.instant("GT_BOOK_PRINT_FROM_TO_PAGES"),!c.lastPage||c.firstPage<=c.lastPage?c.totalPrintPages():c.displayError},this.totalPrintPages=function(){return c.displayError=_+r.instant("GT_BOOK_PRINT_PAGES_LEFT"),c.lastPage-c.firstPage<_?c.displayError="":c.displayError},this.getDefaultToPage=function(){return _?c.fromPage?(E(c.fromPage),void c.validateInputs()):c.toPage=null:(c.displayError=r.instant("GT_BOOK_PRINT_NO_MORE_PAGES"),c.disableInputs=!0,c.toPage=null,void(c.fromPage=null))};var E=function(e){var t=c.convertPageToIndex(e);if(c.structureVersion){var n=t+_-1;1==_&&(n=t),m<n&&(n=m);var o=a.countPages[n];o&&(c.toPage=o.num)}else if(isNaN(Number(c.fromPage))){var i=h[t+_-2];c.toPage=c.actualPageNumber(i)}else{var r=(Number(c.fromPage)+_-1).toString();c.toPage=v<r?v:r}};this.getDefaultToPage(),this.print=function(){if(c.structureVersion&&c.firstPage.id===c.lastPage.id){var e=g.findIndex(function(e){return e.id==c.lastPage.id});c.lastPage=g[e+1]}var t={fromPageId:h[c.firstPage-1]||c.firstPage.id,toPageId:h[c.lastPage]||c.lastPage.id,project_id:a.project_id,app_id:I.id,book_content_id:a.book_content_id,book_version:a.version};c.iFrameSrc=n.trustAsResourceUrl(s.getPrintTemplateUrl(t)),u.printEvent({pageId:h[c.firstPage-1]||c.firstPage.id,bookId:a.project_id||a.id,bookISBN:a.isbn,value:c.lastPage-c.firstPage+1,print:{startPage:c.firstPage.num||c.firstPage,endPage:c.lastPage.num||c.lastPage}}),c.validateError=!0,c.structureVersion||(y.apps[k].print.limit=_-(c.lastPage-c.firstPage+1)),i.user=y},this.onFrameLoad=function(){var e=document.getElementById("iframe-print-page");e.contentWindow.document.execCommand("print",!1,null)||e.contentWindow.print(),t.closeThisDialog()}}]),angular.module("app").component("readAloud",{bindings:{expanded:"<",showOptions:"<"},templateUrl:"app/reader/components/read-aloud/read-aloud.html",controller:["Iframe","$scope","ReadSpeakerService","StatisticsService","$state","Library","$timeout","$translate",function(t,a,s,n,e,o,i,r){var u=this,l=e.params.page,c=o.getBookByContentId(e.params.book),d="undefined"!=typeof InstallTrigger;s.displayMainPlay(!1),this.ariaLive=d?"off":"polite";var g=this;this.languages=[],this.mappedLanguages=[],this.activeLanguage=null,this.progress=0,this.readspeakerSpeed=[{type:"70",name:r.instant("GT_VOCAL_SYNTHESIS_SLOW_TITLE")},{type:"110",name:r.instant("GT_VOCAL_SYNTHESIS_NORMAL_TITLE")},{type:"160",name:r.instant("GT_VOCAL_SYNTHESIS_FAST_TITLE")}];var p={Kate:r.instant("GT_READ_ALOUD_US_FEMALE_VOICE"),en_gb_brian:r.instant("GT_READ_ALOUD_UK_MALE_VOICE"),Jack:r.instant("GT_READ_ALOUD_AU_MALE_VOICE"),Paul:r.instant("GT_READ_ALOUD_US_MALE_VOICE")},h=Object.keys(p);this.speed=this.readspeakerSpeed[1].type,this.changeLanguage=function(e){s.resetState(),u.progress=0,t.iframe.contentWindow.postMessage({type:"changeLang",params:{language:e}},"*"),s.voiceLang=e.name},window.addEventListener("message",function(e){if(e&&e.data&&"stop"===e.data.type&&(s.setState("stop","stop"),a.$apply()),e&&e.data&&"langs"===e.data.type){g.languages=e.data.params?e.data.params.langs:[],g.defaultLang=s.voiceLang;var t=angular.copy(g.languages),n=Object.keys(g.languages).map(function(e){return t[e].lang=e,t[e]});g.mappedLanguages=[].concat.apply([],n).map(function(e){if(0<=h.indexOf(e.voice))return e.voice===g.defaultLang&&(g.defaultLang=p[e.voice]),e.name=e.voice,e.lang=e.lang||"en_us",e.voice=p[e.voice],e});var o=g.mappedLanguages.map(function(e){return e.voice}).indexOf(g.defaultLang);g.activeLanguage=-1!==o?g.mappedLanguages[o]:g.mappedLanguages[2],g.changeLanguage(g.activeLanguage)}if(e&&e.data&&"timeupdated"===e.data.type&&(g.progress=e.data.params?e.data.params.percentage:0,a.$apply()),e&&e.data&&"spechSpeed"===e.data.type){var i=e.data.params.spechSpeed,r=g.readspeakerSpeed.find(function(e){return e.type===i});r&&(g.speed=r.type)}},!1);function f(t){i(function(){var e=angular.element(document.getElementsByClassName(t))[1];e&&(e.setAttribute("aria-label",r.instant("GT_READ_ALOUD_"+t.toUpperCase())),e.focus())},100)}this.play=function(e){t.iframe.contentWindow.postMessage({type:e,params:{}},"*"),s.setState("play","play"),n.readAloudEvent({pageId:l,bookId:c.project_id||c.id,bookISBN:c.isbn,pageIndex:c.getIndexOfPage(l),value:"play"}),f("pause")},this.pause=function(e){t.iframe.contentWindow.postMessage({type:"pause",params:{}},"*"),s.setState("pause","pause"),n.readAloudEvent({pageId:l,bookId:c.project_id||c.id,bookISBN:c.isbn,pageIndex:c.getIndexOfPage(l),value:"pause"}),"pause"===e?(s.displayMainPlay(!0),f("play")):(s.displayMainPlay(!1),f("pause"))},this.stop=function(){t.iframe.contentWindow.postMessage({type:"stop",params:{}},"*"),s.setState("stop","stop"),n.readAloudEvent({pageId:l,bookId:c.project_id||c.id,bookISBN:c.isbn,pageIndex:c.getIndexOfPage(l),value:"stop"}),s.displayMainPlay(!1),f("replay"),u.progress=0},this.close=function(e){if(s.displayMainPlay(!1),e)return u.playerStatus="close";t.iframe.contentWindow.postMessage({type:"close",params:{}},"*"),s.resetState(),n.readAloudEvent({pageId:l,bookId:c.project_id||c.id,bookISBN:c.isbn,pageIndex:c.getIndexOfPage(l),value:"close"}),f("play")},this.skipBackwards=function(){s.displayMainPlay(!1),t.iframe.contentWindow.postMessage({type:"skipBackwards",params:{}},"*")},this.skipForwards=function(){s.displayMainPlay(!1),t.iframe.contentWindow.postMessage({type:"skipForwards",params:{}},"*")},this.changeSpeed=function(e){t.iframe.contentWindow.postMessage({type:"changeSpeed",params:{speed:e}},"*")},a.$on("$locationChangeSuccess",function(){s.resetState()})}]}),angular.module("app").component("readerAccessibility",{bindings:{sharing:"<"},templateUrl:"app/reader/components/reader-accessibility/reader-accessibility.html",controllerAs:"$ctrl",controller:["$scope","Iframe","SettingService","$translate","$timeout","UsersContentsInfos","$state","Library","SessionService",function(e,t,o,n,i,r,a,s,u){var l=this;this.book=s.getBookByContentId(a.params.book);var c=r.DEFAULT_ALT_MEDIA_ENABLED,d=r.DEFAULT_TTS_SPEED,g=10*r.DEFAULT_TTS_VOLUME,p=r.DEFAULT_FONT_NAME,h=a.params.book,f=a.params.assignment;this.sharingId=t._sharingId(h,f);var m=o["pdf-zoom"].range[0],v=o["pdf-zoom"].range[1];this.Iframe=t,this.contentsInfos=r.getBySharingId(this.sharing),this.book=s.getBookOrAssignmentBySharingId(this.sharing),this.user=u.getUser(),this.userAltMediaEnabled=function(){return l.contentsInfos&&l.contentsInfos.options.accessibility&&null!=l.contentsInfos.options.accessibility.altMediaEnabled?l.contentsInfos.options.accessibility.altMediaEnabled:c},this.isAltTextActived=this.userAltMediaEnabled(),this.altTextLabel=this.isAltTextActived?n.instant("GT_ACCESSIBILITY_DISPLAY_ALT_TEXT_ACTIVE"):n.instant("GT_ACCESSIBILITY_DISPLAY_ALT_TEXT_INACTIVE"),this.userReadingSpeed=function(){return l.contentsInfos&&l.contentsInfos.options.accessibility&&null!=l.contentsInfos.options.accessibility.speechRate?l.contentsInfos.options.accessibility.speechRate:d},this.userVolume=function(){return l.contentsInfos&&l.contentsInfos.options.accessibility&&null!=l.contentsInfos.options.accessibility.soundPower?10*l.contentsInfos.options.accessibility.soundPower:g},this.userFont=function(){if(!l.contentsInfos||!l.contentsInfos.options.accessibility||!l.contentsInfos.options.accessibility.fontName)return p;var e=l.contentsInfos.options.accessibility.fontName;return o.fonts.includes(e)?e:p},this.backgroundColor=[{color:"#ffffff",name:n.instant("GT_ACCESSIBILITY_FONT_DEFAULT"),font:"#0000008a"},{color:"#ffffff",name:n.instant("GT_VOCAL_SYNTHESIS_NORMAL_TITLE"),font:"#0000008a"},{color:"#eeece3",name:n.instant("GT_BACKGROUND_COLOR_SEPIA"),font:"#0000008a"},{color:"#373838",name:n.instant("GT_BACKGROUND_COLOR_BLACK"),font:"#ffffff"}],this.readingSpeed=[{type:0,name:n.instant("GT_VOCAL_SYNTHESIS_SLOW_TITLE")},{type:.5,name:n.instant("GT_VOCAL_SYNTHESIS_NORMAL_TITLE")},{type:1,name:n.instant("GT_VOCAL_SYNTHESIS_FAST_TITLE")}],this.speed=this.userReadingSpeed(),this.changeZoom=function(e){if(!(l.slider.value<=m&&"out"===e||"in"===e&&l.slider.value>=v-2)){var t=o["pdf-zoom"].step,n="out"===e?l.slider.value-t:l.slider.value+t;l.slider.value=n,b()}};var b=function(){t.isPDF()?t.zoomPDF(l.slider.value/100):t.isEpubFixed()?t.zoomEpubFixed(l.slider.value):l.book.isEpubReflow()&&t.zoomEpubReflow(l.slider.value/100)};this.book.isPDF()?this.slider={value:100*t.PDFScale,options:{floor:m,ceil:v-2,step:o["pdf-zoom"].step,showSelectionBarEnd:!1,keyboardSupport:!0,ariaLabel:"Zoom in, zoom out slider",translate:function(){return""},showSelectionBar:!0,getSelectionBarColor:function(){return"#3E85C7"},getPointerColor:function(){return"#3E85C7"}}}:(this.book.isEpubFixed()||this.book.isEpubReflow())&&(this.slider={value:this.book.isEpubFixed()?t.EpubFixedWidth:100*t.EpubReflowWidth,options:{floor:this.book.isEpubFixed()?20:30,ceil:this.book.isEpubFixed()?99:170,step:this.book.isEpubFixed()?1:10,showSelectionBarEnd:!1,keyboardSupport:!0,ariaLabel:"Zoom in, zoom out slider",translate:function(){return""},getSelectionBarColor:function(){return"#3E85C7"},getPointerColor:function(){return"#3E85C7"}}}),this.volumeSlider={value:this.userVolume(),options:{floor:0,ceil:10,step:1,hideLimitLabels:!0,hidePointerLabels:!0,showSelectionBarEnd:!1,onEnd:function(){t.activateAltTextMedia(!1,l.currentVolume(),l.speed,!1),t.activateAltTextMedia(!0,l.currentVolume(),l.speed)},showSelectionBar:!0,getSelectionBarColor:function(){return"#3E85C7"},getPointerColor:function(){return"#3E85C7"}}},this.currentVolume=function(){return l.volumeSlider.value/10},this.testAudioText=n.instant("GT_VOCAL_SYNTHESIS_AUDIO_TEST_TEXT"),this.font=this.userFont(),e.$on("slideEnded",function(){b()}),this.selectFont=function(){t.setFont(l.font)},this.displayAltTextMedia=function(){i(function(){var e=document.getElementsByClassName("rz-pointer-min")[0];e&&(e.tabIndex=13,e.setAttribute("aria-label",n.instant("GT_READER_ACCESSIBILITY_SPEECH_VOLUME_ACCESS_LABEL")),y(e,"click"))}),t.activateAltTextMedia(l.isAltTextActived,l.currentVolume(),l.speed)},this.changeReadingSpeed=function(e){t.activateAltTextMedia(!1,l.currentVolume(),e,!1),t.activateAltTextMedia(!0,l.currentVolume(),e)},this.testAudio=function(){t.testAudioForAltText(l.currentVolume(),l.speed,l.testAudioText)};var y=function(e,t){if(e.fireEvent)e.fireEvent("on"+t);else{var n=document.createEvent("Events");n.initEvent(t,!0,!1),e.dispatchEvent(n)}};return this}]}),angular.module("app").component("readerDropdown",{bindings:{icon:"@",tooltip:"@",additionalClass:"@",tabIndex:"@",arialabel:"@",color:"@"},transclude:!0,templateUrl:"app/reader/components/reader-dropdown/reader-dropdown.html",controllerAs:"$ctrl",controller:["$scope","$timeout","$translate",function(t,e,n){var o=this;this.isFirefox="undefined"!=typeof InstallTrigger,this.ariaLive=this.isFirefox?"off":"polite";return this.click=function(){o.openmenu=!o.openmenu,e(function(){t.$broadcast("rzSliderForceRender");var e=document.getElementsByClassName("rz-pointer-min")[0];e&&(e.tabIndex=11,function(e,t){if(e.fireEvent)e.fireEvent("on"+t);else{var n=document.createEvent("Events");n.initEvent(t,!0,!1),e.dispatchEvent(n)}}(e,"click"))})},this.dropdownState=function(){return o.openmenu?n.instant("GT_USER_INPUTS_COLLAPSE"):n.instant("GT_USER_INPUTS_EXPAND")},this.activeColor=function(e){return o.isOpen?e:"white"},this}]}),angular.module("app").component("readerJoyride",{bindings:{},templateUrl:"app/reader/components/reader-joyride/reader-joyride.html",controller:["ngDialog",function(e){this.openInfo=function(){e.open({template:"app/reader/components/reader-joyride/modals/modal.html",appendClassName:"reader-joyride-modal",showClose:!1,closeByEscape:!0,className:"ngdialog-theme-default",controllerAs:"$ctrl",controller:function(){}})}}]}),angular.module("app").component("readerMedias",{templateUrl:"app/reader/components/reader-medias/reader-medias.html",controller:["MediaService","$window",function(r,a){this.medias=r.medias,this.showDescription=function(e){e.showDescription=!e.showDescription},this.play=function(e,t){if("video"==t){var n=e.files.find(function(e){return-1<e.type.indexOf(t)&&-1<e.url.indexOf("480p")});r.selectedMedia=n,r.isPlaying=!0}else if("pdf"==t){var o=e.files.find(function(e){return"document"==e.type});a.open(o.url,"_blank")}else{var i=e.files.find(function(e){return"audio"==e.type});r.selectedMedia=i,r.isPlaying=!0}}}]}),angular.module("app").component("readerNavigation",{bindings:{position:"@",condition:"=",next:"=",previous:"=",type:"@"},transclude:!0,templateUrl:"app/reader/components/reader-navigation/reader-navigation.html",controllerAs:"$ctrl",controller:["$state","$rootScope",function(n,o){var i=this;return this.nextPage=function(){if(document.activeElement===document.getElementById("next-page")){for(var e=parseInt(document.getElementById("next-page").getAttribute("tabindex"));!document.querySelectorAll('[tabindex="'+--e+'"]').length;);document.querySelector('[tabindex="'+e+'"]').focus(),document.querySelector('[tabindex="'+e+'"]').blur()}var t=i.next.path||i.next.id;o.navigationAnimation=i.type+"n",o.showNavigationTop=!1,o.showNavigationBottom=!1,o.showNavigationLeft=!1,o.showNavigationRight=!1,o.cyclicNavigation=!1,n.go("reader.book.page",{page:t})},this.previousPage=function(){if(document.activeElement===document.getElementById("previous-page")){for(var e=parseInt(document.getElementById("previous-page").getAttribute("tabindex"));!document.querySelectorAll('[tabindex="'+--e+'"]').length;);document.querySelector('[tabindex="'+e+'"]').focus(),document.querySelector('[tabindex="'+e+'"]').blur()}var t=i.previous.path||i.previous.id;o.navigationAnimation=i.type+"p",o.showNavigationTop=!1,o.showNavigationBottom=!1,o.showNavigationLeft=!1,o.showNavigationRight=!1,o.cyclicNavigation=!1,n.go("reader.book.page",{page:t})},this}]}),angular.module("app").component("readerPlayer",{templateUrl:"app/reader/components/reader-player/reader-player.html",controllerAs:"$ctrl",controller:function(){return this}}),angular.module("app").component("readerToc",{bindings:{book:"="},templateUrl:"app/reader/components/reader-toc/reader-toc.html",controller:function(){this.bookTitle=this.book.getTitle(),this.shouldShowItem=function(e){return!e.hasOwnProperty("display")||"true"===e.display}}}),angular.module("app").component("searchPanel",{bindings:{book:"=",back:"&"},templateUrl:"app/reader/components/search-panel/search-panel.html",controllerAs:"$ctrl",controller:["SearchService","Iframe","$state","SyncService","$filter","$sce",function(t,e,n,o,i,r){var a=this;this.SearchService=t,this.searchQuery="";var s=n.params.page,u=document.getElementsByTagName("search-panel")[0];this.searchInput=angular.element(document.getElementById("search-input"))[0],this.isFirefox="undefined"!=typeof InstallTrigger,this.ariaLive=this.isFirefox?"off":"polite",this.activeTab="content",this.pageTitleIndex={},this.queryChanged=function(e){t.search(a.book.book_content_id,a.book.version,e,s),a.shortenedQuery=r.valueOf(i("readMore")(e,{size:120}))},this.getSyncObjects=function(){return o.getUserInputsByContext({book:n.params.book,assignment:n.params.assignment})},this.getSyncObjects().forEach(function(e){var t=a.book.pages,n=e.pageTitle;a.pageTitleIndex[n]=t.findIndex(function(e){return e.title==n})}),this.sortByContent=function(e,t){return a.pageTitleIndex[e.pageTitle]-a.pageTitleIndex[t.pageTitle]},this.getSyncObjects().sort(function(e,t){return a.sortByContent(e,t)}),this.switchPanel=function(e){e&&(a.activeTab=e)};return document.addEventListener("keydown",function(e){u.offsetParent&&!u.contains(e.srcElement)&&9===e.keyCode&&(e.preventDefault(),a.searchInput&&a.searchInput.focus())}),this.clearSearch=function(){e.undoSearch(),t.clearSearch(),a.searchQuery="",a.searchInput.focus()},this.searchInput.focus(),this}]}),angular.module("app").component("searchResults",{bindings:{searchQuery:"<",results:"=",back:"=",annotations:"<",filter:"<"},templateUrl:"app/reader/components/search-results/search-results.html",controller:["Library","$state","SearchService",function(e,t,n){var o=this,i=e.getBookByContentId(t.params.book);this.$onInit=function(){o.filteredAnnotations=n.searchLocalAnnotations(o.annotations,o.searchQuery)},this.$onChanges=function(e){if(e&&e.searchQuery){if(e.searchQuery.isFirstChange())return;o.filteredAnnotations=n.searchLocalAnnotations(o.annotations,o.searchQuery)}if(e&&e.annotations){if(e.annotations.isFirstChange())return;o.filteredAnnotations=n.searchLocalAnnotations(o.annotations,o.searchQuery)}},this.sortSearchResults=function(){return i.isPDF()?"-pageIndex":"+pageIndex"}}]}),angular.module("app").component("printAnnotations",{bindings:{book:"<"},templateUrl:"app/reader/user-input/components/print-annotations/print-annotations.html",controllerAs:"$ctrl",controller:["ngDialog","API","SessionService","User","SyncService","$state",function(e,t,n,o,i,r){var a=this,s=this.book;this.openPrintModal=function(){e.open({template:"app/reader/user-input/components/print-annotations/print-annotations-modal.html",controllerAs:"$ctrl",appendClassName:"directive-modal-common",className:"ngdialog-theme-default print-annotations",width:"560px",resolve:{book:function(){return s},userAPI:function(){return t.getUser().then(function(e){return n.user=new o(e)})},types:function(){return l()},userInputs:function(){return u()}},controller:"PrintAnnotationController"})};var u=function(){return i.getUserInputsByContext({book:r.params.book,assignment:r.params.assignment}).filter(function(e){return"note"===e.type||"highlight"===e.type})};this.getUserInputsLength=function(t){return a.userInputs=u(),a.userInputs.filter(function(e){return"notdisplayed"===t?!a.book.getPage(e.pageId):e.type===t&&a.book.getPage(e.pageId)}).length};var l=function(){return a.types=[],a.getUserInputsLength("note")&&a.types.push("note"),a.getUserInputsLength("highlight")&&a.types.push("highlight"),a.getUserInputsLength("notdisplayed")&&a.types.push("notdisplayed"),a.types};return this}]}).controller("PrintAnnotationController",["types","userInputs","$timeout","book","$translate","SessionService","$location","StatisticsService",function(e,n,o,i,r,t,a,s){var u=this;this.types=e,this.book=i,this.userInputs=angular.copy(n);var l=angular.copy(this.types);this.orderBy="pageId",this.cover=this.book.cover||"commons/img/covers.png",this.bookTitle=this.book.getTitle(),this.user=t.getUser(),this.url="https://"+a.host()+"/",this.getTypeLabel=function(e){return"notdisplayed"===e?r.instant("GT_USER_INPUTS_NOT_DISPLAYED")+" "+r.instant("GT_USER_INPUTS_HIGHLIGHTS")+" & "+r.instant("GT_USER_INPUTS_NOTES"):r.instant("GT_USER_INPUTS_"+e.toUpperCase()+"S")},this.getSortBy=function(){return"type"===u.orderBy?r.instant("GT_PRINT_OPTIONS_ORDER_BY_TYPE"):r.instant("GT_PRINT_OPTIONS_ORDER_BY_PAGE")},this.selectTypes=function(e){var t=l.indexOf(e);-1<t?l.splice(t,1):l.push(e)},this.getColorName=function(e){return"#FFEB6B"===e?d("yellow"):"#C0ED72"===e?d("green"):"#ADD8FF"===e?d("blue"):"#FFB0CA"===e?d("pink"):"#D9B2FF"===e?d("purple"):void 0};function c(e,t){var n,o=[],i=(n=t,e.reduce(function(e,t){return(e[t[n]]=e[t[n]]||[]).push(t),e},{}));return Object.keys(i).forEach(function(e){o=o.concat(i[e])}),o}var d=function(e){return r.instant("GT_READER_HIGHLIGHT_"+e.toUpperCase()+"_COLOR")};this.getPartChapterPageName=function(e){var t=i.getPartOrSection(e),n=i.getPage(e);return n&&t&&"true"!==t.isPage?t.title+" / "+n.title:n?n.title:""},this.getUserInputsLength=function(t){return n.filter(function(e){return"notdisplayed"===t?!u.book.getPage(e.pageId):e.type===t&&u.book.getPage(e.pageId)}).length},this.update=function(){u.userInputs=c(u.userInputs,u.orderBy)},this.isNotDisplayed=function(e){return!u.book.getPage(e)},this.print=function(){if(0<l.length){var e,t=[];-1<l.indexOf("notdisplayed")&&(t=n.filter(function(e){return!u.book.getPage(e.pageId)})),e=n.filter(function(e){return-1<l.indexOf(e.type)&&u.book.getPage(e.pageId)}).concat(t),u.userInputs=c(e,u.orderBy);o(function(){var e=document.getElementById("print-section").innerHTML,t=window.open("","","width=800,height=900");t.document.open(),t.document.write("<html><head><title>"+r.instant("GT_ANNOTATIONS_PRINT_TEMPLATE_HEADER")+'</title><style>\n                .annotation-card {\n                    border-bottom: 1px solid #9e9e9e7a;\n                    margin-bottom: 24px;\n                    position: relative;\n                    width: 70%\n                }\n                .whole-page {\n                    margin: 28px 38px;\n                }\n                #print-section {\n                    page-break-after: always;\n                    page-break-inside: avoid;\n                }\n                .header {\n                    border-bottom: 1px solid #9e9e9e7a;\n                    padding: 5px 0;\n                }\n                .date {\n                    float: right;\n                    font-size: 14px;\n                }\n                .side-notes {\n                    width: 30%;\n                    margin: 0 10px;\n                    position: absolute;\n                    top: 0;\n                    left: 74%;\n                }\n                .error {\n                    width: 16px;\n                    background-color: #B00020;\n                    height: 16px;\n                    text-align: center;\n                    border-radius: 50%;\n                    margin-right: 4px;\n                    display: inline-block;\n                }\n                .missing-page-caption {\n                    color: #B00020;\n                    font-size: 14px;\n                }\n                .highlighted-text>p {\n                    font-weight: 600\n                }\n                .highlighted-text {\n                    border-left: 4px solid;\n                    padding-left: 5px;\n                }\n                .side-note-text{\n                    margin: 0;\n                    color: rgba(0, 0, 0, 0.87);\n                    padding-top: 5px;\n                    padding-bottom: 7px;\n                    font-size: 16px;\n                    border-bottom: 1px solid #9e9e9e7a;\n                    font-weight: bold;\n                }\n                .header {\n                    border-bottom: 1px solid #9e9e9e7a;\n                }\n                .book-chapter{\n                    padding-top: 8px;\n                }\n                .page-name {\n                    color: rgba(0,0,0,0.87);\n                    font-family: Roboto;\n                    font-size: 14px;\n                    letter-spacing: 0.27px;\n                    margin-top: 10px;\n                    line-height: 16px;\n                }\n                .color-display {\n                    display: inline-flex;\n                    width: 20px;\n                    height: 20px;\n                    border-radius: 50%;\n                    margin-right: 6px\n                }\n                .book-annotation-cover {\n                    float: left;\n                    border-radius: 2px;\n                    padding-right: 16px;\n                }\n                .type {\n                    text-transform: capitalize;\n                    font-size: 14px;\n                    vertical-align: super;\n                    color: rgba(0,0,0,0.87);\n                }\n                .note-text{\n                    font-size: 16px;\n                }\n                .book-cover {\n                    height: 120px;\n                    width: 120px;\n                    object-fit: contain;\n                }\n                .page-header {\n                    display: none;\n                }\n                @page {\n                    margin: 50px;\n                }\n                .copyrights {\n                    position: fixed;\n                    right: 1%;\n                    height: 35px;\n                    width: 170px;\n                    color: rgba(0,0,0,0.87);\n                    font-family: Roboto;\n                    font-size: 8px;\n                    letter-spacing: 0.2px;\n                    line-height: 10px;\n                    bottom: 106px;\n                }\n                .info-type{\n                    color: #565252;\n                    font-family: Roboto;\n                    font-size: 16px;\n                    font-weight: bold;\n                    letter-spacing: 0.11px;\n                    line-height: 16px;\n                }\n                .book-annotation-description {\n                    display: grid;\n                }\n                .book-annotations {\n                    display: inline-flex;\n                }\n                .annotation-info{\n                    margin: 17px 0;\n                    border-bottom: 1px solid #9e9e9e7a;\n                    padding: 5px 0;\n                }\n                .annotation-book {\n                    line-height: 12px;\n                }\n                .book-name {\n                    color: rgba(0, 0, 0, 0.87);\n                    font-size: 20px;\n                    font-weight: 600;\n                    letter-spacing: 0.25px;\n                    word-wrap: break-word;\n                    white-space: initial;\n                    max-width: 100%;\n                }\n                .annotation-book-author {\n                    height: 20px;\n                    color: rgba(0, 0, 0, .6);\n                    font-size: 14px;\n                    letter-spacing: .25px;\n                    line-height: 20px;\n                }\n                .pink {\n                    background-color: #FFB0CA\n                }\n                .blue {\n                    background-color: #ADD8FF\n                }\n                .purple {\n                    background-color: #D9B2FF\n                }\n                .green {\n                    background-color: #C0ED72\n                }\n                .yellow {\n                    background-color: #FFEB6B\n                }\n                .annotation-section {\n                    position: relative;\n                }\n            // </style></head><body onload="window.print()">'+e+"</html>"),t.document.close()},1e3),s.printAnnotationsEvent({bookId:u.book.project_id||u.book.id,bookISBN:u.book.isbn})}}}]),angular.module("app").component("readerColorPicker",{bindings:{callback:"=",selected:"<?",firstIsDefault:"@?"},templateUrl:"app/reader/user-input/components/reader-color-picker/reader-color-picker.html",controller:["$translate",function(n){var t=this;this.colors=["#FFEB6B","#C0ED72","#ADD8FF","#FFB0CA","#D9B2FF"],this.selectColor=function(e){t.selected=e,"function"==typeof t.callback&&t.callback(e)},this.selected||(this.selected="",this.firstIsDefault&&this.selectColor(this.colors[0])),this.getTranslationValue=function(e){var t=n.instant("GT_READER_HIGHLIGHT_"+e.toUpperCase()+"_COLOR");return n.instant("GT_READER_HIGHLIGHT_ACCESSIBILITY",{color:t})},this.getColorName=function(e){return"#FFEB6B"===e?t.getTranslationValue("yellow"):"#C0ED72"===e?t.getTranslationValue("green"):"#ADD8FF"===e?t.getTranslationValue("blue"):"#FFB0CA"===e?t.getTranslationValue("pink"):"#D9B2FF"===e?t.getTranslationValue("purple"):void 0}}]}),angular.module("app").component("readerInputItemList",{bindings:{items:"<",filter:"@?",changes:"&",searchQuery:"<"},templateUrl:"app/reader/user-input/components/reader-input-item-list/reader-input-item-list.html",controller:["$state","Library","SearchService","$sce","$filter",function(e,n,t,o,i){var r=this;this.bookId=e.params.book;var a=n.getBookByContentId(this.bookId);this.annotations=this.items,this.currentState=e.current.name,this.getBookName=function(e){var t=n.getBookOrAssignmentBySharingId(e);return t?t.getTitle():""},this.getShortenedQuery=function(e){return o.valueOf(i("readMore")(e,{size:120}))},this.searchAnnotations=function(){return t.searchLocalAnnotations(r.items,r.searchQuery)},this.$onChanges=function(e){if(e&&e.items&&(r.annotations=r.items,r.searchQuery?(r.annotations=r.searchAnnotations(),r.changes({data:r.annotations})):r.changes()),e&&e.searchQuery){if(e.searchQuery.isFirstChange())return;r.searchQuery?(r.annotations=r.searchAnnotations(),r.changes({data:r.annotations})):(r.changes(),r.annotations=r.items)}},this.displayExpand=function(e){return!a.getPage(e[0].pageId)},this.getPartChapterPageName=function(e){var t=e.split(",")[1],n=a.getPartOrSection(t),o=a.getPage(t);return o&&n&&"true"!==n.isPage?n.title+" / "+o.title:o?o.title:""}}]}),angular.module("app").component("readerInputItemViewer",{bindings:{currentItem:"<",text:"<",type:"<",searchQuery:"<"},templateUrl:"app/reader/user-input/components/reader-input-item-viewer/reader-input-item-viewer.html",controller:["$state","SyncService","Library","$translate","Assignment","$scope","$timeout","LocalStorage","SearchService","toastr",function(e,o,t,i,n,r,a,s,u,l){var c=this;this.item=this.currentItem;var d=t.getBookOrAssignmentBySharingId(this.item.sharingId),g=d.book_content_id||t.getBookByLMSId(d.getLMSId()).book_content_id,p=d instanceof n?d.id:void 0,h=t.getBookByContentId(g);this.type=this.item.type,this.page=h.getPage(this.item.pageId),this.pageTitle=null,this.typeTranslation=i.instant("GT_USER_INPUT_"+this.type.toUpperCase());var f=s.get("lang");if(this.page&&this.page.title&&(this.pageTitle=this.page.title),this.item&&this.item.options.serializedData){var m=JSON.parse(this.item.options.serializedData);this.color=m.color}this.$onInit=function(){y(c.searchQuery),c.initItem(),c.resetNoteSettings(),b()},this.$onChanges=function(){b(),c.item=c.currentItem,c.initItem(),c.getAnnotationIcon(),y(c.searchQuery)};function v(e,t){return e&&t?"de"===t?e:e.toLowerCase():""}var b=function(){a(function(){var e=angular.element(document.getElementsByClassName("highlight-caption"));0<e.length&&angular.forEach(e,function(e){e.scrollHeight>e.clientHeight&&e.setAttribute("style","box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15); -moz-box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15); -webkit-box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15)")})},1)};this.initItem=function(){c.item&&c.item.options.serializedData&&(c.color=c.item.options.color),c.typeTranslation=i.instant("GT_USER_INPUT_"+c.type.toUpperCase()),c.modalParams={type:"delete",button:i.instant("GT_ALERT_DELETE_USER_INPUT_TITLE",{type:v(c.typeTranslation,f)}),modalButton:i.instant("GT_ALERT_DELETE_USER_INPUT_TITLE",{type:v(c.typeTranslation,f)}),header:i.instant("GT_ALERT_DELETE_USER_INPUT_TITLE",{type:v(c.typeTranslation,f)}),body:i.instant("GT_USER_INPUTS_WARNING_DELETE_"+c.type.toUpperCase())},c.goToAnnotationModal={type:"open",button:i.instant("GT_USER_INPUT_OPEN_ACTION"),modalButton:i.instant("GT_USER_INPUTS_LEAVE_BUTTON"),body:i.instant("GT_USER_INPUTS_OPEN_WARNING",{type:c.typeTranslation.toLowerCase()})}};var y=function(e){if("bookmark"===c.type){var t=c.item.pageTitle;c.markedBookmark=u.markSearch(t,e)}if("highlight"===c.type){var n=c.item.options.selectedText;c.markedHighlight=u.markSearch(n,e)}if("note"===c.type){var o=c.item.options.selectedText;c.markedselectedText=u.markSearch(o,e);var i=c.item.options.noteText;c.markedNoteText=u.markSearch(i,e)}};document.addEventListener("mousedown",function(e){var t=document.getElementsByClassName("reader-input-note");t&&t.length&&(t[0].contains(e.target)||(c.resetNoteSettings(),r.$apply()))},!1),this.openNoteMode=function(e){c.resetNoteSettings(),c.noteSettings.show=!0,c.noteSettings.edit=!0,c.noteSettings.highlight=c.item,c.noteSettings.note=!0,c.noteSettings.isAnnotationsMode=!0,c.noteSettings.serializedHighlight=c.item.options.serializedData,c.noteSettings.pageId=c.item.pageId,c.noteSettings.position={top:e.pageY?e.pageY-300:window.innerHeight/3},c.noteSettings.selectedText=c.item.options.selectedText},this.getAnnotationIcon=function(){var e="note"===c.type?"message":"highlight";return"bookmark"===c.type?"bookmark":e},this.resetNoteSettings=function(){c.noteSettings={show:!1,position:null,note:!1,edit:!1,highlight:null}},this.goToAnnotation=function(){c.page&&e.go("reader.book.page",{book:g,page:c.item.pageId,highlight:c.item.id,scrollTo:c.item.id,assignment:p,search:c.searchQuery})},this.delete=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o.delete(c.item.id),t=i.instant("GT_USER_INPUTS_DELETE_"+c.item.type.toUpperCase()),n=i.instant("GT_CANCEL").toUpperCase(),l.success(t+'. <button class="toast-cancel-button">'+n+"</button>",{toastClass:"toast toast-black",timeOut:3e3,allowHtml:!0});case 4:case"end":return e.stop()}},e,c)})),this.fullNote=!1,this.moreOrLess="GT_SHOW_MORE",this.showMoreOrLess=function(){c.fullNote=!c.fullNote,c.moreOrLess=c.fullNote?"GT_SHOW_LESS":"GT_SHOW_MORE"}}]}),angular.module("app").component("readerInputNotDisplayed",{bindings:{settings:"<"},templateUrl:"app/reader/user-input/components/reader-input-not-displayed/reader-input-not-displayed.html",controller:["$state","Library","$translate","SyncService",function(e,t,n,o){var i=this;this.book=t.getBookByContentId(e.params.book),this.nonDisplayedTitle=n.instant("GT_USER_INPUTS_NOT_DISPLAYED_ALERT",{number:this.settings.number}),this.updateStatus=function(e){i.settings.show=!1,o.updateNdAnnotationsStatus(e)}}]});_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}angular.module("app").component("readerInputNote",{bindings:{settings:"<"},templateUrl:"app/reader/user-input/components/reader-input-note/reader-input-note.html",controller:["Iframe","SyncService","$state","Library","$translate","$filter",function(s,u,l,c,t,o){var d=this;this.color="",this.text="",this.book=c.getBookByContentId(l.params.book);var n=296;l.params.assignment&&c.loadAssignmentId(l.params.assignment).then(function(e){d.assignment=e}),this.colorChanged=function(e){d.color=e},this.displayNote=function(){return d.settings.show&&d.settings.note},this.focusColorPicker=function(e){e&&document.getElementById("color-picker").focus(),d.selectColorLabel()};this.$doCheck=function(){var e;(e=angular.element(document.getElementsByClassName("highlight-text"))[0])&&e.scrollHeight>e.clientHeight&&e.setAttribute("style","box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15); -moz-box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15); -webkit-box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15)");var t=document.getElementsByClassName("note-text")[0];t&&t.focus()},this.$onChanges=function(e){var t=e.settings.currentValue;if(d.selectedText=o("decodeURI")(t.selectedText),d.color="",d.text="",t.highlight&&(d.color=t.highlight.color?t.highlight.color:t.highlight.options.color,1==t.note)){var n=u.getById(t.highlight.id);if(!n)return;d.text=n.options.noteText}},this.save=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,o,i,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:0<d.text.length&&(t=void 0,n=!1,d.settings.highlight?n=d.settings.isAnnotationsMode?(t=d.settings.serializedHighlight,!!(o=JSON.parse(d.settings.serializedHighlight)).noteFromHighlight||!o.isNote):(i=JSON.stringify(d.settings.highlight),t=s.highlight(d.color,i,!0),!!d.settings.highlight.noteFromHighlight):t=s.highlight(d.color,null,!0),d.book=d.book||c.getBookOrAssignmentBySharingId(d.settings.highlight.sharingId),r=d.book.getSharingId(),d.assignment&&(r=d.assignment.id),a=_extends(JSON.parse(t),{sharingId:r,contentVersion:d.book.getVersion(),pageTitle:d.book.getPage(l.params.page||d.settings.pageId)?d.book.getPage(l.params.page||d.settings.pageId).title:"",noteFromHighlight:n}),u.addNote(a,l.params.page||d.settings.pageId,d.text),d.settings.show=!1),d.isShown=!1;case 2:case"end":return e.stop()}},e,d)})),this.delete=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.delete(d.settings.highlight.id);case 2:if(t=u.getById(d.settings.highlight.id))return e.next=6,u.delete(t.id);e.next=6;break;case 6:d.settings.isAnnotationsMode||s.removeHighlight(),d.settings.show=!1,d.isShown=!1;case 9:case"end":return e.stop()}},e,d)})),this.cancel=function(){d.settings.show=!1,d.isShown=!1},this.alignPositionTop=function(){var e=window.innerHeight||document.body.clientHeight,t=d.settings.position.top;return e<t+(n=document.getElementsByClassName("reader-input-note")[0].clientHeight)&&(t=e-n-100),t+"px"},this.alignPositionLeft=function(){var e=window.innerWidth||document.body.clientWidth,t=d.settings.position.left-350;t<350&&(t=350);var n=t+700;return e<n&&(t=e-700-350),t<350&&e<n&&(t=(e-700)/2),t+"px"},this.selectColorLabel=function(){var e=d.showColors?t.instant("GT_USER_INPUTS_COLLAPSE"):t.instant("GT_USER_INPUTS_EXPAND");return t.instant("GT_USER_INPUTS_SELECT_COLOR_LABEL")+", "+e}}]});_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e};angular.module("app").component("readerInputToolbar",{bindings:{settings:"<",features:"<"},templateUrl:"app/reader/user-input/components/reader-input-toolbar/reader-input-toolbar.html",controller:["Iframe","SyncService","$state","Library",function(r,a,s,e){var u=this;this.book=e.getBookByContentId(s.params.book),s.params.assignment&&e.loadAssignmentId(s.params.assignment).then(function(e){u.assignment=e}),this.$onChanges=function(){u.settings.show&&document.getElementById("annotation-container").focus()},this.applyHighlight=function(e){var t=void 0;if(u.settings.highlight){var n=JSON.stringify(u.settings.highlight);t=r.highlight(e,n)}else t=r.highlight(e);var o=u.book.getSharingId();u.assignment&&(o=u.assignment.id);var i=_extends(JSON.parse(t),{sharingId:o,contentVersion:u.book.getVersion(),pageTitle:u.book.getPage(s.params.page).title||""});a.addHighlight(i,s.params.page),u.settings.show=!1},this.delete=function(){a.delete(u.settings.highlight.id),r.removeHighlight(),u.settings.show=!1},this.alignPositionTop=function(){return u.settings.position?u.settings.position.top+"px":"0px"},this.alignPositionLeft=function(){if(u.settings.position){var e=window.innerWidth-u.settings.position.left;return u.book.isPDF()||200<e?u.settings.position.left-135+"px":(e<100?window.innerWidth-375:u.settings.position.left-window.innerWidth/6)+"px"}return"0px"}}]}),angular.module("app").component("readerTocItem",{bindings:{item:"="},templateUrl:"app/reader/components/reader-toc/components/reader-toc-item/reader-toc-item.html",controller:["$state","$stateParams","Library","$scope","$translate",function(n,e,t,o,i){var r=this;this.params=e,this.book=t.getBookByContentId(this.params.book),this.tocLevel=this.book.getTocLevel(),this.isFirefox="undefined"!=typeof InstallTrigger,this.ariaLive=this.isFirefox?"off":"polite",this.shouldShowItem=function(e){return!e.hasOwnProperty("display")||"true"===e.display},this.getStatus=function(){return"true"==r.item.isPage?"":r.showChild?i.instant("GT_USER_INPUTS_COLLAPSE"):i.instant("GT_USER_INPUTS_EXPAND")},this.getStatus=function(){return"true"==r.item.isPage?"":r.showChild?i.instant("GT_USER_INPUTS_COLLAPSE"):i.instant("GT_USER_INPUTS_EXPAND")},this.openPage=function(e){if("true"==r.item.isPage)n.go("reader.book.page",{page:r.item.path,scrollTo:e||null});else if(r.showChild=!r.showChild,r.shouldStayOpen=!r.shouldStayOpen,r.showChild){var t=r.book.getFirstPageFromStruct(r.item);t&&n.go("reader.book.page",{page:t.path,scrollTo:e||null})}},this._shouldStayOpen=function(){return r.showChild||null!=r.book.getPageByStruct(r.item,r.params.page)},this.isActive=function(){return"false"==r.item.isPage&&null!=r.book.getPageByStruct(r.item,r.params.page)},this.showChild=this.shouldStayOpen=this._shouldStayOpen(),o.$on("$locationChangeSuccess",function(){r.showChild=r.shouldStayOpen=r._shouldStayOpen()})}]}),angular.module("app").component("newTocReaderItem",{bindings:{item:"="},templateUrl:"app/reader/components/reader-toc/components/reader-toc-item-new/reader-toc-item-new.html",controller:["$state","$stateParams","Library","$scope","$translate",function(t,e,n,o,i){var r=this;this.params=e,this.book=n.getBookByContentId(this.params.book),this.tocLevel=this.book.getTocLevel(),this.isFirefox="undefined"!=typeof InstallTrigger,this.ariaLive=this.isFirefox?"off":"polite",this.getStatus=function(){return"true"==r.item.isPage?"":r.showChild?i.instant("GT_USER_INPUTS_COLLAPSE"):i.instant("GT_USER_INPUTS_EXPAND")},this.isSelectedPage=function(){var e=null,t=r.params.page,n=r.book.getCountPage(t);if(n&&(e=n.target.split("#")[0]),r.item.id==t||r.item.target.includes(e))return a(r.item.id),!0};var a=function(e){var t=document.getElementById(e),n=document.querySelector(".toc-container"),o=t.getBoundingClientRect();0<=o.top&&(o.bottom<=n.clientHeight+190||o.top<n.clientHeight&&0<=o.bottom)||n.scrollTo(0,t.offsetTop-190)};this.openPage=function(e){r.item.children&&(r.showChild=!r.showChild,r.shouldStayOpen=!r.shouldStayOpen),t.go("reader.book.page",{page:r.item.id,scrollTo:e||null})},this._shouldStayOpen=function(){return!!r.item.children&&(r.showChild||r.book.getPage(r.params.page,r.item.children))},this.showChild=this.shouldStayOpen=this._shouldStayOpen(),o.$on("$locationChangeSuccess",function(){r.showChild=r.shouldStayOpen=r._shouldStayOpen()})}]}),angular.module("app").component("searchResultItem",{bindings:{searchQuery:"<",result:"=",back:"="},templateUrl:"app/reader/components/search-results/components/search-result-item/search-result-item.html",controller:["$state","$stateParams","$sce","$translate",function(t,n,o,i){var r=this;this.collapsed=!0,this.previews=this.result.previews.map(function(e){return{occurrences:e.occurrences,previewText:o.trustAsHtml("« ..."+e.preview+"... »"),ariaLabelText:e.preview}}),this.pageTitle=this.result.pageTitle,this.occurrences=this.result.totalOccurrences,this.goToPage=function(e){e.srcElement.classList.contains("occurrences-button")||e.srcElement.classList.contains("show-more-less-btn")?r.showMoreLess():t.is("reader.book.page")&&n.page===r.result.pageContentId&&n.search===r.searchQuery?r.back():t.go("reader.book.page",{page:r.result.pageContentId,search:r.searchQuery})},this.showMoreLess=function(e){e&&e.stopPropagation(),r.collapsed=!r.collapsed},this.getPageTitle=function(){var e=i.instant("GT_SEARCH_PAGE_TITLE")+" "+r.pageTitle;return e=e.replace(new RegExp("</?.*?[^<>]*>","gi"),""),o.trustAsHtml(e)}}]});